<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stationeers Server Dashboard - Monitor and manage your servers">
    <title>Dashboard - Stationeers Server Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/ui-theme.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="page-shell">
    <div id="connection-banner" class="connection-banner" role="status" aria-live="polite">
        <span id="connection-banner-text">Connection lost. Attempting to reconnect...</span>
        <button type="button" id="connection-banner-action">Reload</button>
    </div>

    <div class="container">
        <header class="hero-card">
            <div class="hero-main">
                <img src="/sdsm.png" alt="SDSM logo" class="hero-logo" width="72" height="72">
                <div class="hero-heading">
                    <h1 class="hero-title">Server Dashboard</h1>
                    <p class="hero-subtitle">Monitor and manage your Stationeers servers in real time.</p>
                </div>
            </div>
            <div class="hero-meta">
                <div class="hero-meta-title">Fleet Overview</div>
                <p class="hero-meta-text">{{ len .servers }} server{{ if ne (len .servers) 1 }}s{{ end }} tracked ‚Ä¢ stay in sync with live status, players, and health.</p>
                <span class="pill">Last refresh: <span id="last-refresh">just now</span></span>
            </div>
            <div class="hero-actions">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <span id="theme-icon">ÔøΩ</span>
                </button>
                <button
                    class="btn btn-primary"
                    hx-get="/api/refresh"
                    hx-trigger="click"
                    hx-indicator="#refresh-indicator"
                    hx-swap="none"
                >
                    <span id="refresh-indicator" class="hidden">‚ü≥</span>
                    Refresh
                </button>
                <a href="/manager" class="btn btn-secondary">Manager</a>
                <a href="/logout" class="btn btn-secondary">Logout</a>
            </div>
        </header>

        <section class="stats-grid"
             hx-get="/api/stats"
             hx-trigger="load, every 30s, refresh"
                 hx-swap="innerHTML">
            <div class="stat-card">
                <div class="stat-value" id="total-servers">{{ len .servers }}</div>
                <div class="stat-label">Total Servers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="active-servers">
                    {{ $active := 0 }}
                    {{ range .servers }}
                        {{ if .IsRunning }}{{ $active = add $active 1 }}{{ end }}
                    {{ end }}
                    {{ $active }}
                </div>
                <div class="stat-label">Active Servers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-players">
                    {{ $players := 0 }}
                    {{ range .servers }}
                        {{ $players = add $players .ClientCount }}
                    {{ end }}
                    {{ $players }}
                </div>
                <div class="stat-label">Connected Players</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">100%</div>
                <div class="stat-label">System Health</div>
            </div>
        </section>

        <section id="server-grid"
                 class="grid-split"
                 hx-get="/api/servers"
             hx-trigger="load, every 10s, refresh"
                 hx-swap="innerHTML">
            {{ if .servers }}
                {{ range .servers }}
                <article class="glass-card server-card" data-server-id="{{ .ID }}" data-target-url="/server/{{ .ID }}">
                    <div class="card-header">
                        <div class="server-name card-title">{{ .Name }}</div>
                        <span class="status-pill {{ if .IsRunning }}is-running{{ else }}is-stopped{{ end }}" data-status>
                            {{ if .IsRunning }}Running{{ else }}Stopped{{ end }}
                        </span>
                    </div>
                    <div class="server-info">
                        <div class="info-item">
                            <div class="info-label">World</div>
                            <div class="info-value">{{ .World }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Port</div>
                            <div class="info-value">{{ .Port }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Players</div>
                            <div class="info-value" data-player-count>{{ .ClientCount }}/{{ .MaxClients }}</div>
                        </div>
                        <div class="info-item">
                            <div class="info-label">Password</div>
                            <div class="info-value">{{ if .Password }}Yes{{ else }}No{{ end }}</div>
                        </div>
                    </div>
                    <div class="server-actions">
                        {{ if .IsRunning }}
                            <button
                                class="btn btn-danger btn-pill"
                                hx-post="/api/servers/{{ .ID }}/stop"
                                hx-trigger="click"
                                hx-confirm="Are you sure you want to stop this server?"
                                hx-target="closest .server-card"
                                hx-swap="outerHTML"
                                data-stop-navigation="true"
                            >
                                Stop
                            </button>
                        {{ else }}
                            <button
                                class="btn btn-success btn-pill"
                                hx-post="/server/{{ .ID }}"
                                hx-trigger="click"
                                hx-vals='{"start":"1"}'
                                hx-target="closest .server-card"
                                hx-swap="none"
                                data-stop-navigation="true"
                            >
                                Start
                            </button>
                        {{ end }}
                        <button
                            class="btn btn-danger btn-pill"
                            hx-post="/server/{{ .ID }}"
                            hx-trigger="click"
                            hx-confirm="Are you sure you want to delete {{ .Name }}? This cannot be undone."
                            hx-vals='{"delete":"1"}'
                            hx-target="body"
                            hx-swap="none"
                            data-stop-navigation="true"
                        >
                            Delete
                        </button>
                    </div>
                </article>
                {{ end }}
            {{ else }}
                <div class="glass-card empty-state">
                    <div class="empty-state-icon" aria-hidden="true">ÔøΩÔ∏è</div>
                    <h3 class="card-title">No Servers Found</h3>
                    <p class="hero-subtitle">Get started by creating your first dedicated server configuration.</p>
                    <button class="btn btn-primary" onclick="createNewServer()">
                        Create New Server
                    </button>
                </div>
            {{ end }}
        </section>
    </div>

    {{ if .servers }}
    <button class="floating-action" onclick="createNewServer()" aria-label="Add new server">+</button>
    {{ end }}

    <script>
        let ws;

        function getStoredTheme() {
            return localStorage.getItem('theme') || 'dark';
        }

        function setTheme(theme) {
            const html = document.documentElement;
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || getStoredTheme();
            const next = current === 'dark' ? 'light' : 'dark';
            setTheme(next);
        }

        setTheme(getStoredTheme());

        function bindServerCardNavigation(root) {
            const cards = (root || document).querySelectorAll('.server-card');
            cards.forEach(card => {
                if (card.dataset.navigationBound === 'true') {
                    return;
                }
                card.dataset.navigationBound = 'true';
                card.addEventListener('click', event => {
                    if (event.target.closest('[data-stop-navigation="true"]')) {
                        return;
                    }
                    const url = card.getAttribute('data-target-url');
                    if (url) {
                        window.location.href = url;
                    }
                });
            });
        }

        bindServerCardNavigation();

        document.addEventListener('htmx:afterSwap', event => {
            if (event.target && event.target.closest('#server-grid')) {
                bindServerCardNavigation(event.target.closest('#server-grid'));
            }
        });

        const HEALTH_ENDPOINT = '/healthz';
        const HEALTH_TIMEOUT = 4000;
        const HEALTH_INTERVAL_OK = 15000;
        const HEALTH_INTERVAL_LOST = 5000;
        let healthTimer = null;
        let healthLost = false;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => console.log('WebSocket connected');
            ws.onmessage = event => handleRealtimeUpdate(JSON.parse(event.data));
            ws.onclose = () => setTimeout(connectWebSocket, 3000);
            ws.onerror = error => console.error('WebSocket error:', error);
        }

        function setDashboardConnectionBanner(active, text) {
            const banner = document.getElementById('connection-banner');
            const bannerText = document.getElementById('connection-banner-text');
            if (!banner) {
                return;
            }
            if (active) {
                banner.classList.add('active');
                if (bannerText && text) {
                    bannerText.textContent = text;
                }
                document.body.style.paddingTop = '3.5rem';
            } else {
                banner.classList.remove('active');
                document.body.style.paddingTop = '';
            }
        }

        function scheduleHealthCheck(delay) {
            if (healthTimer) {
                clearTimeout(healthTimer);
            }
            healthTimer = setTimeout(runHealthCheck, delay);
        }

        function runHealthCheck() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), HEALTH_TIMEOUT);
            fetch(HEALTH_ENDPOINT, {
                cache: 'no-store',
                credentials: 'same-origin',
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error('Health check failed');
                    }
                    if (healthLost) {
                        healthLost = false;
                        setDashboardConnectionBanner(true, 'Connection restored. Reloading...');
                        setTimeout(() => {
                            setDashboardConnectionBanner(false);
                            window.location.reload();
                        }, 1200);
                        return;
                    }
                    setDashboardConnectionBanner(false);
                })
                .catch(() => {
                    clearTimeout(timeoutId);
                    if (!healthLost) {
                        healthLost = true;
                        setDashboardConnectionBanner(true, 'Connection lost. Attempting to reconnect...');
                    }
                })
                .finally(() => {
                    scheduleHealthCheck(healthLost ? HEALTH_INTERVAL_LOST : HEALTH_INTERVAL_OK);
                });
        }

        function startHealthMonitor() {
            const reloadBtn = document.getElementById('connection-banner-action');
            if (reloadBtn) {
                reloadBtn.addEventListener('click', () => window.location.reload());
            }
            runHealthCheck();
        }

        function handleRealtimeUpdate(data) {
            switch (data.type) {
                case 'server_status':
                    updateServerStatus(data.serverId, data.status);
                    break;
                case 'stats_update':
                    updateStats(data.stats);
                    break;
                default:
                    console.log('Unknown update type:', data.type);
            }
        }

        function updateServerStatus(serverId, status) {
            const serverCard = document.querySelector(`[data-server-id="${serverId}"]`);
            if (!serverCard) {
                return;
            }
            const statusBadge = serverCard.querySelector('[data-status]');
            if (statusBadge) {
                statusBadge.textContent = status.running ? 'Running' : 'Stopped';
                statusBadge.classList.toggle('is-running', status.running);
                statusBadge.classList.toggle('is-stopped', !status.running);
            }
            if (status.playerCount !== undefined) {
                const playerInfo = serverCard.querySelector('[data-player-count]');
                if (playerInfo) {
                    playerInfo.textContent = `${status.playerCount}/${status.maxPlayers || '?'}`;
                }
            }
        }

        function updateStats(stats) {
            if (stats.totalServers !== undefined) {
                const total = document.getElementById('total-servers');
                if (total) total.textContent = stats.totalServers;
            }
            if (stats.activeServers !== undefined) {
                const active = document.getElementById('active-servers');
                if (active) active.textContent = stats.activeServers;
            }
            if (stats.totalPlayers !== undefined) {
                const players = document.getElementById('total-players');
                if (players) players.textContent = stats.totalPlayers;
            }
            const refresh = document.getElementById('last-refresh');
            if (refresh) {
                const now = new Date();
                refresh.textContent = now.toLocaleTimeString();
            }
        }

        function createNewServer() {
            window.location.href = '/server/new';
        }

        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            startHealthMonitor();

            document.body.addEventListener('htmx:beforeRequest', event => {
                if (event.detail.elt?.getAttribute('hx-indicator') === '#refresh-indicator') {
                    document.getElementById('refresh-indicator')?.classList.remove('hidden');
                }
            });

            document.body.addEventListener('htmx:afterRequest', event => {
                if (event.detail.elt?.getAttribute('hx-indicator') === '#refresh-indicator') {
                    document.getElementById('refresh-indicator')?.classList.add('hidden');
                }
            });

            setInterval(() => {
                htmx.trigger('#server-grid', 'refresh');
                htmx.trigger('.stats-grid', 'refresh');
            }, 30000);
        });

        document.addEventListener('keydown', event => {
            if (event.ctrlKey && event.shiftKey && event.key === 'T') {
                event.preventDefault();
                toggleTheme();
            }
            if (event.ctrlKey && event.key === 'r') {
                event.preventDefault();
                htmx.trigger('#server-grid', 'refresh');
            }
        });

        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
</body>
</html>