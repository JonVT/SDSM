<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stationeers Server Manager - Configuration and Updates">
    <title>Manager - Stationeers Server Manager</title>
    
    <!-- Modern CSS Framework -->
    <link rel="stylesheet" href="/static/modern.css">
    
    <!-- HTMX for dynamic interactions -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        .manager-header {
            background: linear-gradient(120deg, rgba(37, 99, 235, 0.93) 0%, rgba(139, 92, 246, 0.93) 100%);
            border-radius: var(--radius-xl);
            padding: var(--space-4) var(--space-5);
            margin-bottom: var(--space-5);
            box-shadow: var(--shadow-lg);
            color: #f8fafc;
        }

        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: none;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-5);
            background: rgba(239, 68, 68, 0.95);
            color: #ffffff;
            font-weight: 600;
            z-index: 4000;
            box-shadow: var(--shadow-lg);
        }

        .connection-banner.active {
            display: flex;
        }

        .connection-banner button {
            padding: var(--space-1) var(--space-3);
            border: 1px solid rgba(255, 255, 255, 0.55);
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.18);
            color: #ffffff;
            font-size: var(--text-sm);
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .connection-banner button:hover {
            background: rgba(255, 255, 255, 0.32);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: var(--space-4);
        }

        .branding {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .branding-logo {
            width: 56px;
            height: 56px;
            border-radius: var(--radius-lg);
            background: rgba(255, 255, 255, 0.1);
            padding: var(--space-2);
            box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.2);
            object-fit: contain;
        }

        .manager-header h1,
        .manager-header p {
            color: rgba(248, 250, 252, 0.95);
            margin: 0;
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }
        
        .manager-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-5);
            margin-bottom: var(--space-5);
        }
        
        @media (max-width: 768px) {
            .manager-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: var(--bg-secondary);
            border: 1px solid rgba(99, 102, 241, 0.18);
            border-radius: var(--radius-lg);
            padding: var(--space-5);
            box-shadow: var(--shadow-md);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            inset: 0 0 auto 0;
            height: 4px;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            background: linear-gradient(120deg, rgba(37, 99, 235, 0.85), rgba(236, 72, 153, 0.85));
        }
        
        .card h3 {
            margin-top: 0;
            margin-bottom: var(--space-3);
            color: var(--text-primary);
            font-size: var(--text-xl);
            font-weight: 600;
        }
        
        .form-group {
            margin-bottom: var(--space-3);
        }
        
        .form-group label {
            display: block;
            margin-bottom: var(--space-2);
            color: var(--text-secondary);
            font-size: var(--text-sm);
            font-weight: 500;
        }
        
        .form-group input[type="text"] {
            width: 100%;
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: var(--text-sm);
            background: var(--bg-primary);
            color: var(--text-primary);
        }
        
        .form-group input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .table-container {
            overflow-x: auto;
            margin: var(--space-3) 0;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: var(--space-3);
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        th {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: var(--text-xs);
            text-transform: uppercase;
            font-weight: 600;
        }
        
        td {
            color: var(--text-primary);
            font-size: var(--text-sm);
        }
        
        .note {
            background: rgba(251, 191, 36, 0.12);
            border: 1px solid rgba(245, 158, 11, 0.35);
            border-radius: var(--radius-md);
            padding: var(--space-3);
            margin-top: var(--space-3);
            font-size: var(--text-sm);
            color: #b45309;
        }

        .component-title {
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .component-title::before {
            content: '';
            width: 8px;
            height: 8px;
            border-radius: var(--radius-full);
            background: linear-gradient(120deg, rgba(37, 99, 235, 0.9), rgba(236, 72, 153, 0.9));
            box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.15);
        }

        .progress-row {
            display: none;
            flex-direction: column;
            gap: var(--space-2);
            margin-top: var(--space-2);
        }

        .progress-row.active {
            display: flex;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 999px;
            overflow: hidden;
            position: relative;
        }

        .progress-fill {
            width: 0%;
            height: 100%;
            background: #6366f1;
            transition: width 0.25s ease;
        }

        .progress-fill.indeterminate {
            background: linear-gradient(270deg, rgba(99, 102, 241, 0) 0%, rgba(99, 102, 241, 0.55) 50%, rgba(99, 102, 241, 0) 100%);
            background-size: 200% 100%;
            animation: progress-indeterminate 1.2s infinite linear;
        }

        .progress-text {
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        .progress-row.error .progress-fill {
            background: #ef4444;
        }

        .progress-row.error .progress-text {
            color: #b91c1c;
        }

        .update-message {
            display: none;
            margin-bottom: var(--space-3);
            font-size: var(--text-sm);
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            border: 1px solid transparent;
        }

        .update-message.active {
            display: block;
            background: rgba(99, 102, 241, 0.12);
            color: #4338ca;
            border-color: rgba(99, 102, 241, 0.35);
        }

        .update-message.error {
            background: rgba(248, 113, 113, 0.15);
            color: #b91c1c;
            border-color: rgba(248, 113, 113, 0.45);
        }

        @keyframes progress-indeterminate {
            0% {
                background-position: 200% 0;
            }
            100% {
                background-position: -200% 0;
            }
        }
        
        .footer-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-lg);
            padding: var(--space-6);
            text-align: center;
        }
        
        .button-group {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
            margin-top: var(--space-4);
        }
        
        #updating {
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            font-family: monospace;
            font-size: var(--text-sm);
        }
        
        #updating div {
            margin-bottom: var(--space-1);
            color: var(--text-primary);
        }
        
        .theme-toggle {
            background: rgba(248, 250, 252, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: var(--radius-md);
            padding: var(--space-2);
            cursor: pointer;
            transition: all var(--transition-default);
            color: #f8fafc;
        }
        
        .theme-toggle:hover {
            background: rgba(248, 250, 252, 0.25);
            border-color: rgba(255, 255, 255, 0.45);
        }

        .setup-overlay {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0, 0, 0, 0.45);
            backdrop-filter: blur(4px);
            z-index: 10000;
        }

        .setup-overlay.hidden {
            display: none;
        }

        .setup-modal {
            background: var(--bg-secondary);
            border-radius: var(--radius-xl, 24px);
            padding: var(--space-7, 3rem);
            max-width: 640px;
            width: min(92%, 640px);
            box-shadow: 0 24px 60px rgba(15, 23, 42, 0.35);
            border: 1px solid var(--border-color);
            max-height: 90vh;
            overflow-y: auto;
            animation: setupSlideIn 0.25s ease-out;
        }

        @keyframes setupSlideIn {
            from {
                opacity: 0;
                transform: translateY(-24px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .setup-header {
            text-align: center;
            margin-bottom: var(--space-6, 2rem);
        }

        .setup-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto var(--space-4);
            border-radius: var(--radius-lg);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        .setup-header h2 {
            margin-bottom: var(--space-2);
            font-size: var(--text-2xl);
            color: var(--text-primary);
        }

        .setup-header p {
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        .missing-components {
            background: rgba(234, 179, 8, 0.1);
            border-left: 4px solid rgba(202, 138, 4, 0.85);
            border-radius: var(--radius-lg);
            padding: var(--space-4, 1.5rem);
            margin-bottom: var(--space-5, 1.5rem);
        }

        .missing-components h3 {
            font-size: var(--text-base);
            font-weight: 600;
            color: #b45309;
            margin-bottom: var(--space-2);
        }

        .missing-components ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .missing-components li {
            display: flex;
            align-items: center;
            gap: var(--space-2, 0.75rem);
            padding: var(--space-2, 0.75rem) 0;
            color: #92400e;
            font-size: var(--text-sm);
        }

        .missing-components li::before {
            content: "‚ö†Ô∏è";
        }

        .missing-components.empty {
            border-left-color: rgba(22, 163, 74, 0.7);
            background: rgba(22, 163, 74, 0.12);
        }

        .missing-components.empty h3 {
            color: #166534;
        }

        .missing-components .empty-message {
            display: none;
            color: #166534;
            font-weight: 600;
            font-size: var(--text-sm);
        }

        .missing-components.empty .empty-message {
            display: block;
        }

        .missing-components.empty ul {
            display: none;
        }

        .setup-error-box {
            display: none;
            background: rgba(248, 113, 113, 0.12);
            border-left: 4px solid rgba(220, 38, 38, 0.9);
            border-radius: var(--radius-lg);
            padding: var(--space-4, 1.5rem);
            margin-bottom: var(--space-5, 1.5rem);
        }

        .setup-error-box.active {
            display: block;
        }

        .setup-error-box h3 {
            font-size: var(--text-base);
            font-weight: 600;
            color: #b91c1c;
            margin-bottom: var(--space-2);
        }

        .setup-error-box ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .setup-error-box li {
            display: flex;
            align-items: center;
            gap: var(--space-2, 0.75rem);
            padding: var(--space-2, 0.75rem) 0;
            color: #b91c1c;
            font-size: var(--text-sm);
        }

        .setup-error-box li::before {
            content: "‚õî";
        }

        .error-hint {
            font-size: var(--text-xs);
            color: #b91c1c;
            margin-top: var(--space-2);
        }

        .setup-progress {
            display: none;
            background: var(--bg-tertiary);
            border-radius: var(--radius-lg);
            border: 1px solid var(--border-color);
            padding: var(--space-4, 1.5rem);
            margin-bottom: var(--space-5, 1.5rem);
        }

        .setup-progress.active {
            display: block;
        }

        .setup-progress-text {
            color: var(--text-secondary);
            font-size: var(--text-sm);
            margin-bottom: var(--space-3, 1rem);
            text-align: center;
        }

        .setup-progress-bar {
            width: 100%;
            height: 10px;
            background: var(--border-color);
            border-radius: 999px;
            overflow: hidden;
        }

        .setup-progress-fill {
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s ease;
        }

        .setup-actions {
            display: flex;
            justify-content: flex-end;
            gap: var(--space-3, 1rem);
        }

        .setup-actions .btn {
            min-width: 140px;
        }

        .setup-log-footer {
            display: flex;
            align-items: center;
            gap: var(--space-3, 1rem);
            margin-top: var(--space-5, 1.5rem);
        }

        .setup-log-footer .setup-log-text {
            flex: 1;
            font-size: var(--text-sm);
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            min-width: 0;
        }

        .setup-log-footer .btn {
            flex-shrink: 0;
        }
    </style>
</head>

<body>
    <div id="connectionBanner" class="connection-banner" role="status" aria-live="polite">
        <span id="connectionBannerText">Connection lost. Attempting to reconnect...</span>
        <button type="button" id="connectionBannerAction">Reload</button>
    </div>
    <!-- Header -->
    <header class="manager-header">
        <div class="container">
            <div class="header-content">
                <div class="branding">
                    <img src="/sdsm.png" alt="SDSM logo" class="branding-logo" width="64" height="64">
                    <div>
                        <h1>Server Manager</h1>
                        <p class="text-secondary">Configure and update SDSM</p>
                    </div>
                </div>
                <div class="header-actions">
                    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                        <span id="theme-icon">üåô</span>
                    </button>
                    <a href="/dashboard" class="btn btn-secondary">Dashboard</a>
                    <a href="/logout" class="btn btn-secondary">Logout</a>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="manager-grid">
            <div class="card">
                <h3>Configuration</h3>
                <form action="/update" method="POST">
                    <div class="form-group">
                        <label for="steam_id">Steam ID</label>
                        <input type="text" id="steam_id" name="steam_id" value="{{ .steam_id }}" required>
                    </div>
                    <div class="form-group">
                        <label for="port">Port</label>
                        <input type="text" id="port" name="port" value="{{ .port }}" required>
                    </div>
                    <div class="form-group">
                        <label for="language">Language</label>
                        <select id="language" name="language">
                            {{ range .languages }}
                            <option value="{{ . }}" {{ if eq . $.language }}selected{{ end }}>{{ . }}</option>
                            {{ end }}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="root_path">Root Path</label>
                        <input type="text" id="root_path" name="root_path" value="{{ .root_path }}" required>
                    </div>
                    <div class="form-group">
                        <label for="auto_update">Auto Update Time</label>
                        <input type="text" id="auto_update" name="auto_update" value="{{ .auto_update }}" required>
                    </div>
                    <div class="form-group">
                        <label for="start_update">Update at Start</label>
                        <input type="checkbox" id="start_update" name="start_update" {{if .start_update}}checked{{end}}>
                    </div>
                    <div class="form-group">
                        <button type="submit" name="update_config" class="btn btn-primary" {{if .updating}}disabled{{end}}>
                            Update Config
                        </button>
                    </div>
                </form>
                <div class="note">
                    <strong>Note:</strong> After updating the configuration, SDSM may restart so changes can take effect.
                </div>
            </div>

            <div class="card">
                {{if not .updating}}
                <div id="versions">
                    <h3>Software Versions</h3><h6>(WIP)</h6>
                    <form action="/update" method="POST" id="updateForm">
                        <div id="updateMessage" class="update-message" role="status" aria-live="polite"></div>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Component</th>
                                        <th>Deployed</th>
                                        <th>Latest</th>
                                        <th>Action</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>
                                            <div class="component-title">rocketstation_DedicatedServer Release</div>
                                            <div class="progress-row" data-progress="release">
                                                <div class="progress-bar"><div class="progress-fill"></div></div>
                                                <div class="progress-text"></div>
                                            </div>
                                        </td>
                                        <td>{{ .release_deployed }}</td>
                                        <td>{{ .release_latest }}</td>
                                        <td>
                                            <button type="submit" name="update_release" data-update-target="update_release" data-component="release" class="btn {{if eq .release_deployed .release_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                Update
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="component-title">rocketstation_DedicatedServer Beta</div>
                                            <div class="progress-row" data-progress="beta">
                                                <div class="progress-bar"><div class="progress-fill"></div></div>
                                                <div class="progress-text"></div>
                                            </div>
                                        </td>
                                        <td>{{ .beta_deployed }}</td>
                                        <td>{{ .beta_latest }}</td>
                                        <td>
                                            <button type="submit" name="update_beta" data-update-target="update_beta" data-component="beta" class="btn {{if eq .beta_deployed .beta_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                Update
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="component-title">steamcmd</div>
                                            <div class="progress-row" data-progress="steamcmd">
                                                <div class="progress-bar"><div class="progress-fill"></div></div>
                                                <div class="progress-text"></div>
                                            </div>
                                        </td>
                                        <td>{{ .steamcmd_deployed }}</td>
                                        <td>{{ .steamcmd_latest }}</td>
                                        <td>
                                            <button type="submit" name="update_steamcmd" data-update-target="update_steamcmd" data-component="steamcmd" class="btn {{if eq .steamcmd_deployed .steamcmd_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                Update
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="component-title">BEPINEX</div>
                                            <div class="progress-row" data-progress="bepinex">
                                                <div class="progress-bar"><div class="progress-fill"></div></div>
                                                <div class="progress-text"></div>
                                            </div>
                                        </td>
                                        <td>{{ .bepinex_deployed }}</td>
                                        <td>{{ .bepinex_latest }}</td>
                                        <td>
                                            <button type="submit" name="update_bepinex" data-update-target="update_bepinex" data-component="bepinex" class="btn {{if eq .bepinex_deployed .bepinex_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                Update
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td>
                                            <div class="component-title">Stationeers LaunchPad</div>
                                            <div class="progress-row" data-progress="launchpad">
                                                <div class="progress-bar"><div class="progress-fill"></div></div>
                                                <div class="progress-text"></div>
                                            </div>
                                        </td>
                                        <td>{{ .launchpad_deployed }}</td>
                                        <td>{{ .launchpad_latest }}</td>
                                        <td>
                                            <button type="submit" name="update_launchpad" data-update-target="update_launchpad" data-component="launchpad" class="btn {{if eq .launchpad_deployed .launchpad_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                Update
                                            </button>
                                        </td>
                                    </tr>
                                    <tr>
                                        <td colspan="3"></td>
                                        <td>
                                            <button type="submit" name="update_all" data-update-target="update_all" data-component="all" class="btn btn-primary update-trigger" {{if .updating}}disabled{{end}}>
                                                Update All
                                            </button>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </form>
                </div>
                {{else}}
                <div>
                    <h3>Updating...</h3>
                    <div id="updating">Nothing to see here...</div>
                    <script>
                        const eventSource = new EventSource('/updating');
                        const messagesDiv = document.getElementById('updating');

                        eventSource.onmessage = function (event) {
                            const newMessage = document.createElement('div');
                            newMessage.textContent = event.data;
                            messagesDiv.appendChild(newMessage);
                            messagesDiv.scrollTop = messagesDiv.scrollHeight;
                        };
                    </script>
                </div>
                {{end}}
            </div>
        </div>
        
        <!-- Footer with Actions -->
        <div class="footer-card">
            <p>There are <strong>{{.server_count_active}}</strong> servers currently running.</p>
            <div class="button-group">
                <form action="/update" method="POST" style="display: contents;">
                    <button type="submit" name="shutdown" value="1" class="btn btn-danger" {{if .updating}}disabled{{end}}
                            onclick="return confirm('Are you sure you want to shutdown SDSM? All servers will be stopped.');">
                        Shutdown SDSM
                    </button>
                    <button type="submit" name="restart" value="1" class="btn btn-primary" {{if .updating}}disabled{{end}}
                            onclick="return confirm('Are you sure you want to restart SDSM? All servers will be temporarily stopped.');">
                        Restart SDSM
                    </button>
                </form>
                <a class="btn btn-secondary" href="/logs/sdsm" target="_blank" rel="noopener">
                    View Log
                </a>
            </div>
        </div>
    </main>

    <script>
        (function () {
            const buttons = Array.from(document.querySelectorAll('.update-trigger'));
            const messageEl = document.getElementById('updateMessage');
            let pollTimer = null;

            function showMessage(text, isError) {
                if (!messageEl) {
                    return;
                }
                if (!text) {
                    messageEl.classList.remove('active', 'error');
                    messageEl.textContent = '';
                    return;
                }
                messageEl.textContent = text;
                messageEl.classList.add('active');
                messageEl.classList.toggle('error', !!isError);
            }

            function setButtonsDisabled(disabled) {
                buttons.forEach((btn) => {
                    btn.disabled = disabled;
                });
            }

            function selectProgressRow(key) {
                if (!key) {
                    return null;
                }
                return document.querySelector('.progress-row[data-progress="' + key.toLowerCase() + '"]');
            }

            function formatBytes(bytes) {
                if (!bytes || bytes <= 0) {
                    return '0 B';
                }
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let value = bytes;
                let index = 0;
                while (value >= 1024 && index < units.length - 1) {
                    value /= 1024;
                    index++;
                }
                const fixed = value < 10 && index > 0 ? value.toFixed(1) : Math.round(value).toString();
                return fixed + ' ' + units[index];
            }

            function updateProgressRow(component) {
                const row = selectProgressRow(component.key || component.component);
                if (!row) {
                    return;
                }
                const fill = row.querySelector('.progress-fill');
                const text = row.querySelector('.progress-text');
                const active = component.running || component.percent > 0 || !!component.error;

                row.classList.toggle('active', active);
                row.classList.toggle('error', !!component.error);

                if (fill) {
                    if (component.total > 0) {
                        fill.style.width = Math.min(component.percent || 0, 100) + '%';
                        fill.classList.remove('indeterminate');
                    } else if (component.running) {
                        fill.style.width = '100%';
                        fill.classList.add('indeterminate');
                    } else {
                        fill.style.width = '0%';
                        fill.classList.remove('indeterminate');
                    }
                }

                if (text) {
                    let status = component.stage || '';
                    if (component.error) {
                        status = 'Error: ' + component.error;
                    } else if (component.total > 0 && component.running) {
                        status = status + ' (' + (component.percent || 0) + '% of ' + formatBytes(component.total) + ')';
                    } else if (!component.running && component.percent >= 100 && !component.error) {
                        status = status || 'Completed';
                    }
                    text.textContent = status.trim();
                }
            }

            function handleProgressSnapshot(snapshot) {
                if (!snapshot || !Array.isArray(snapshot.components)) {
                    return;
                }

                snapshot.components.forEach(updateProgressRow);

                setButtonsDisabled(snapshot.updating);

                if (!snapshot.updating && pollTimer) {
                    clearInterval(pollTimer);
                    pollTimer = null;
                }
            }

            function fetchProgress() {
                fetch('/update/progress', {
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                    .then((res) => res.ok ? res.json() : null)
                    .then(handleProgressSnapshot)
                    .catch(() => {
                        // Ignore polling errors; retry on next interval
                    });
            }

            function ensurePolling() {
                if (!pollTimer) {
                    pollTimer = setInterval(fetchProgress, 2000);
                }
            }

            buttons.forEach((btn) => {
                btn.addEventListener('click', (event) => {
                    event.preventDefault();
                    if (btn.disabled) {
                        return;
                    }

                    const target = btn.dataset.updateTarget;
                    if (!target) {
                        return;
                    }

                    const params = new URLSearchParams();
                    params.append(target, '1');

                    setButtonsDisabled(true);
                    showMessage('Starting update...', false);

                    fetch('/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: params.toString()
                    })
                        .then((res) => {
                            if (!res.ok) {
                                return res.json().then((data) => Promise.reject(data));
                            }
                            return res.json();
                        })
                        .then((data) => {
                            if (data && data.status === 'started') {
                                const label = btn.closest('tr')?.querySelector('.component-title')?.textContent?.trim() || 'Update';
                                showMessage(label + ' started...', false);
                                fetchProgress();
                                ensurePolling();
                            } else if (data && data.status === 'ok') {
                                showMessage('Configuration updated.', false);
                                setButtonsDisabled(false);
                            } else {
                                showMessage('', false);
                                setButtonsDisabled(false);
                            }
                        })
                        .catch((err) => {
                            const errorText = err && err.error ? err.error : 'Unable to start update. Please try again.';
                            showMessage(errorText, true);
                            setButtonsDisabled(false);
                            fetchProgress();
                        });
                });
            });

            // Initial progress fetch
            fetchProgress();
            ensurePolling();
        })();
    </script>

    <script>
        (function () {
            const HEALTH_ENDPOINT = '/healthz';
            const HEALTH_TIMEOUT = 4000;
            const INTERVAL_OK = 15000;
            const INTERVAL_LOST = 5000;

            let healthTimer = null;
            let connectionLost = false;

            function setBanner(active, message) {
                const banner = document.getElementById('connectionBanner');
                const text = document.getElementById('connectionBannerText');
                if (!banner) {
                    return;
                }
                if (active) {
                    banner.classList.add('active');
                    if (text && message) {
                        text.textContent = message;
                    }
                    document.body.style.paddingTop = '4rem';
                } else {
                    banner.classList.remove('active');
                    document.body.style.paddingTop = '';
                }
            }

            function scheduleNext(delay) {
                if (healthTimer) {
                    clearTimeout(healthTimer);
                }
                healthTimer = setTimeout(runHealthCheck, delay);
            }

            function runHealthCheck() {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), HEALTH_TIMEOUT);

                fetch(HEALTH_ENDPOINT, {
                    cache: 'no-store',
                    credentials: 'same-origin',
                    signal: controller.signal
                })
                    .then((response) => {
                        clearTimeout(timeoutId);
                        if (!response.ok) {
                            throw new Error('Health check failed');
                        }
                        if (connectionLost) {
                            connectionLost = false;
                            setBanner(true, 'Connection restored. Reloading...');
                            setTimeout(() => {
                                setBanner(false);
                                window.location.reload();
                            }, 1200);
                            return;
                        }
                        setBanner(false);
                    })
                    .catch(() => {
                        clearTimeout(timeoutId);
                        if (!connectionLost) {
                            connectionLost = true;
                            setBanner(true, 'Connection lost. Attempting to reconnect...');
                        }
                    })
                    .finally(() => {
                        scheduleNext(connectionLost ? INTERVAL_LOST : INTERVAL_OK);
                    });
            }

            document.addEventListener('DOMContentLoaded', () => {
                const reloadButton = document.getElementById('connectionBannerAction');
                if (reloadButton) {
                    reloadButton.addEventListener('click', () => window.location.reload());
                }
                runHealthCheck();
            });
        })();
    </script>

        {{ $missingCount := len .missing_components }}
        {{ $errorCount := len .deploy_errors }}
        {{ $shouldShowSetup := or .needs_setup (or .setup_in_progress (or (gt $missingCount 0) (gt $errorCount 0))) }}
        <div id="setupOverlay" class="setup-overlay{{if not $shouldShowSetup}} hidden{{end}}" data-needs="{{if .needs_setup}}true{{else}}false{{end}}" data-in-progress="{{if .setup_in_progress}}true{{else}}false{{end}}" data-log-fallback="{{.setup_log_fallback}}" data-last-log="{{.setup_last_log_line}}">
            <div class="setup-modal" role="dialog" aria-modal="true" aria-labelledby="setupTitle">
                <div class="setup-header">
                    <div class="setup-icon">üîß</div>
                    <h2 id="setupTitle">Initial Setup Required</h2>
                    <p>We need to download a few components before everything is ready.</p>
                </div>

                <div id="setupMissingContainer" class="missing-components{{if eq $missingCount 0}} empty{{end}}">
                    <h3>Missing Components</h3>
                    <p id="setupMissingEmpty" class="empty-message">All components are present. You're good to go!</p>
                    <ul id="setupMissingList">
                        {{range .missing_components}}
                        <li>{{.}}</li>
                        {{end}}
                    </ul>
                </div>

                <div id="setupErrorBox" class="setup-error-box{{if gt $errorCount 0}} active{{end}}">
                    <h3>Installation Issues Detected</h3>
                    <ul id="setupErrorList">
                        {{range .deploy_errors}}
                        <li>{{.}}</li>
                        {{end}}
                    </ul>
                    <p class="error-hint">Review the setup log for details, then try again.</p>
                </div>

                <div id="setupProgress" class="setup-progress{{if .setup_in_progress}} active{{end}}">
                    <div class="setup-progress-text" id="setupProgressText">{{if .setup_in_progress}}‚è≥ Installing components, please wait...{{else}}Ready when you are.{{end}}</div>
                    <div class="setup-progress-bar">
                        <div class="setup-progress-fill" id="setupProgressFill" style="width: {{if .setup_in_progress}}35%{{else}}0%{{end}};"></div>
                    </div>
                </div>

                <div class="setup-actions">
                    <button type="button" class="btn btn-secondary" id="setupSkipBtn">Skip for Now</button>
                    <button type="button" class="btn btn-primary" id="setupStartBtn">Start Setup</button>
                </div>

                <div class="setup-log-footer">
                    <a id="setupViewLogBtn" class="btn btn-secondary" href="/logs/updates" target="_blank" rel="noopener">
                        View Log
                    </a>
                    <div class="setup-log-text" id="setupLogLine">
                        {{if .setup_last_log_line}}Last log entry: {{.setup_last_log_line}}{{else}}Last log entry: {{.setup_log_fallback}}{{end}}
                    </div>
                </div>
            </div>
        </div>
    
    <!-- Theme Toggle Script -->
        <script>
            (function () {
                const overlay = document.getElementById('setupOverlay');
                if (!overlay) {
                    return;
                }

                const progressContainer = document.getElementById('setupProgress');
                const progressFill = document.getElementById('setupProgressFill');
                const progressText = document.getElementById('setupProgressText');
                const setupButton = document.getElementById('setupStartBtn');
                const skipButton = document.getElementById('setupSkipBtn');
                const errorBox = document.getElementById('setupErrorBox');
                const errorList = document.getElementById('setupErrorList');
                const missingContainer = document.getElementById('setupMissingContainer');
                const missingList = document.getElementById('setupMissingList');
                const missingEmpty = document.getElementById('setupMissingEmpty');
                const logLineElement = document.getElementById('setupLogLine');
                const logFallback = overlay.dataset.logFallback || 'No update activity recorded yet.';
                const logPrefix = '';
                let lastLogValue = overlay.dataset.lastLog ? overlay.dataset.lastLog.trim() : '';

                if (logLineElement) {
                    logLineElement.textContent = logPrefix + (lastLogValue || logFallback);
                }

                let statusInterval = null;
                let progressInterval = null;

                function setButtonsDisabled(disabled) {
                    if (setupButton) {
                        setupButton.disabled = disabled;
                    }
                    if (skipButton) {
                        skipButton.disabled = disabled;
                    }
                }

                function updateErrorBox(errors) {
                    if (!errorBox || !errorList) {
                        return;
                    }

                    errorList.innerHTML = '';

                    if (errors && errors.length) {
                        errors.forEach((msg) => {
                            const item = document.createElement('li');
                            item.textContent = msg;
                            errorList.appendChild(item);
                        });
                        errorBox.classList.add('active');
                    } else {
                        errorBox.classList.remove('active');
                    }
                }

                function updateMissingComponents(items) {
                    if (!missingContainer || !missingList || !missingEmpty) {
                        return;
                    }

                    missingList.innerHTML = '';

                    if (!items || !items.length) {
                        missingContainer.classList.add('empty');
                        return;
                    }

                    missingContainer.classList.remove('empty');
                    items.forEach((item) => {
                        const li = document.createElement('li');
                        li.textContent = item;
                        missingList.appendChild(li);
                    });
                }

                function stopProgressAnimation() {
                    if (progressInterval) {
                        clearInterval(progressInterval);
                        progressInterval = null;
                    }
                }

                function startProgressAnimation() {
                    stopProgressAnimation();
                    if (progressFill) {
                        progressFill.style.width = '0%';
                    }
                    let width = 0;
                    progressInterval = setInterval(() => {
                        width += 1;
                        if (progressFill && width <= 95) {
                            progressFill.style.width = width + '%';
                        }
                        if (width > 95) {
                            stopProgressAnimation();
                        }
                    }, 300);
                }

                function showOverlay() {
                    overlay.classList.remove('hidden');
                }

                function hideOverlay() {
                    overlay.classList.add('hidden');
                    overlay.dataset.needs = 'false';
                    overlay.dataset.inProgress = 'false';
                }

                function stopStatusPolling() {
                    if (statusInterval) {
                        clearInterval(statusInterval);
                        statusInterval = null;
                    }
                }

                function startStatusPolling() {
                    stopStatusPolling();
                    statusInterval = setInterval(checkSetupStatus, 2000);
                    checkSetupStatus();
                }

                function handleSetupStart() {
                    setButtonsDisabled(true);
                    if (progressContainer) {
                        progressContainer.classList.add('active');
                    }
                    if (progressText) {
                        progressText.textContent = '‚è≥ Installing components, please wait...';
                    }
                    startProgressAnimation();
                    showOverlay();

                    fetch('/setup/install', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        }
                    }).then((response) => {
                        if (!response.ok) {
                            throw new Error('Failed to start setup');
                        }
                        overlay.dataset.inProgress = 'true';
                        startStatusPolling();
                    }).catch((error) => {
                        stopProgressAnimation();
                        if (progressText) {
                            progressText.textContent = `‚ö†Ô∏è ${error.message}`;
                        }
                        setButtonsDisabled(false);
                    });
                }

                function skipSetup() {
                    setButtonsDisabled(true);
                    fetch('/setup/skip', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json'
                        }
                    }).then((response) => {
                        if (!response.ok) {
                            throw new Error('Failed to skip setup');
                        }
                        return response.json();
                    }).then(() => {
                        stopProgressAnimation();
                        stopStatusPolling();
                        hideOverlay();
                    }).catch((error) => {
                        if (progressText) {
                            progressText.textContent = `‚ö†Ô∏è ${error.message}`;
                        }
                        setButtonsDisabled(false);
                    });
                }

                function checkSetupStatus() {
                    fetch('/setup/status', {
                        headers: {
                            'Accept': 'application/json'
                        }
                    })
                        .then((response) => response.json())
                        .then((data) => {
                            overlay.dataset.needs = data.needsUploadPrompt ? 'true' : 'false';
                            overlay.dataset.inProgress = data.inProgress ? 'true' : 'false';

                            updateMissingComponents(data.missingComponents || []);
                            updateErrorBox(data.errors || []);

                            const lastLog = (data.lastUpdateLog || '').trim();
                            lastLogValue = lastLog;
                            overlay.dataset.lastLog = lastLog;
                            if (logLineElement) {
                                logLineElement.textContent = logPrefix + (lastLog || logFallback);
                            }

                            const stillMissing = Array.isArray(data.missingComponents) && data.missingComponents.length > 0;

                            if (data.inProgress) {
                                if (progressContainer) {
                                    progressContainer.classList.add('active');
                                }
                                if (progressText) {
                                    progressText.textContent = '‚è≥ Installing components, please wait...';
                                }
                                if (!progressInterval) {
                                    startProgressAnimation();
                                }
                                setButtonsDisabled(true);
                                showOverlay();
                                return;
                            }

                            stopProgressAnimation();
                            if (progressFill) {
                                progressFill.style.width = stillMissing ? '0%' : '100%';
                            }

                            if (data.errors && data.errors.length) {
                                if (progressContainer) {
                                    progressContainer.classList.add('active');
                                }
                                if (progressText) {
                                    progressText.textContent = '‚ö†Ô∏è Setup encountered errors. Review the details below.';
                                }
                                setButtonsDisabled(false);
                                showOverlay();
                                return;
                            }

                            if (!data.needsUploadPrompt && !stillMissing) {
                                if (progressContainer) {
                                    progressContainer.classList.add('active');
                                }
                                if (progressText) {
                                    progressText.textContent = '‚úÖ Setup complete! Refreshing‚Ä¶';
                                }
                                setButtonsDisabled(true);
                                stopStatusPolling();
                                setTimeout(() => {
                                    hideOverlay();
                                    window.location.reload();
                                }, 800);
                            } else {
                                if (progressContainer) {
                                    progressContainer.classList.add('active');
                                }
                                if (progressText) {
                                    progressText.textContent = '‚ö†Ô∏è Some components are still missing. Please try again.';
                                }
                                setButtonsDisabled(false);
                                showOverlay();
                            }
                        })
                        .catch((error) => {
                            console.error('Error checking setup status:', error);
                        });
                }

                if (setupButton) {
                    setupButton.addEventListener('click', handleSetupStart);
                }

                if (skipButton) {
                    skipButton.addEventListener('click', skipSetup);
                }

                const shouldAutoShow = overlay.dataset.needs === 'true' || overlay.dataset.inProgress === 'true';
                if (shouldAutoShow) {
                    showOverlay();
                    if (overlay.dataset.inProgress === 'true') {
                        setButtonsDisabled(true);
                        if (progressContainer) {
                            progressContainer.classList.add('active');
                        }
                        if (progressText) {
                            progressText.textContent = '‚è≥ Installing components, please wait...';
                        }
                        startProgressAnimation();
                    }
                    startStatusPolling();
                }
            })();
        </script>
    <script>
        // Theme management
        function getStoredTheme() {
            return localStorage.getItem('theme') || 'light';
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const icon = document.getElementById('theme-icon');
            icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        
        function toggleTheme() {
            const currentTheme = getStoredTheme();
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }
        
        // Initialize theme
        setTheme(getStoredTheme());
    </script>
</body>

</html>