<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.server.Name}} - SDSM</title>
    <link rel="stylesheet" href="/static/styles.css">
    <style>
        :root {
            --space-1: 0.25rem;
            --space-2: 0.5rem;
            --space-3: 0.75rem;
            --space-4: 1rem;
            --space-6: 1.5rem;
            --space-8: 2rem;
            --text-sm: 0.875rem;
            --text-base: 1rem;
            --text-lg: 1.125rem;
            --text-xl: 1.25rem;
            --text-2xl: 1.5rem;
            --radius-md: 0.375rem;
            --radius-lg: 0.5rem;
        }

        [data-theme="light"] {
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #94a3b8;
            --border-color: #e2e8f0;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --success-500: #22c55e;
            --danger-500: #ef4444;
            --warning-500: #f59e0b;
        }

        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-tertiary: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #64748b;
            --border-color: #334155;
            --primary-500: #3b82f6;
            --primary-600: #2563eb;
            --success-500: #22c55e;
            --danger-500: #ef4444;
            --warning-500: #f59e0b;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.5;
            padding: var(--space-3);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: grid;
            grid-template-columns: auto 1fr auto;
            gap: var(--space-3);
            align-items: start;
            margin-bottom: var(--space-3);
            padding: var(--space-4);
            background: linear-gradient(120deg, rgba(37, 99, 235, 0.9) 0%, rgba(124, 58, 237, 0.9) 60%, rgba(236, 72, 153, 0.85) 100%);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            color: #f8fafc;
        }

        .planet-section {
            display: flex;
            gap: var(--space-3);
            align-items: center;
        }

        .planet-img {
            width: 72px;
            height: 72px;
            border-radius: 18px;
            border: 2px solid rgba(255, 255, 255, 0.25);
            box-shadow: 0 10px 20px rgba(15, 23, 42, 0.25);
        }

        .server-info-header {
            display: flex;
            flex-direction: column;
            gap: var(--space-1);
        }

        .server-name-large {
            font-size: 1.75rem;
            font-weight: 600;
            margin: 0;
            color: rgba(248, 250, 252, 0.96);
        }

        .version-info {
            font-size: var(--text-sm);
            color: rgba(248, 250, 252, 0.7);
        }

        .world-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .world-name {
            font-size: var(--text-lg);
            font-weight: 600;
            margin: 0;
            color: rgba(248, 250, 252, 0.92);
        }

        .world-description {
            font-size: var(--text-sm);
            color: rgba(248, 250, 252, 0.7);
            line-height: 1.5;
            margin: 0;
        }

        .nav-buttons {
            display: flex;
            gap: var(--space-2);
            align-items: start;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-3);
        }

        .btn {
            padding: var(--space-2) var(--space-4);
            border-radius: var(--radius-md);
            border: 1px solid rgba(99, 102, 241, 0.25);
            font-size: var(--text-sm);
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--space-2);
            background: rgba(255, 255, 255, 0.92);
            color: var(--text-primary);
            box-shadow: var(--shadow-sm);
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.98);
            transform: translateY(-1px);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: rgba(148, 163, 184, 0.25);
            color: var(--text-tertiary);
        }

        .btn:disabled:hover {
            background: rgba(148, 163, 184, 0.25);
            transform: none;
        }

        select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            pointer-events: none;
        }

        .btn-secondary {
            background: linear-gradient(120deg, rgba(241, 245, 249, 0.95) 0%, rgba(226, 232, 240, 0.95) 100%);
            color: var(--text-primary);
            border: 1px solid rgba(148, 163, 184, 0.35);
        }

        .btn-control {
            min-width: 120px;
            padding: var(--space-2) var(--space-3);
        }

        .btn-start {
            background: var(--success-500);
            color: white;
            border-color: var(--success-500);
        }

        .btn-start:hover {
            background: var(--success-500);
        }

        .btn-stop {
            background: var(--danger-500);
            color: white;
            border-color: var(--danger-500);
        }

        .btn-stop:hover {
            border-color: var(--danger-500);
        }

        .btn-player-action {
            min-width: 60px;
            padding: var(--space-1) var(--space-3);
            font-size: 0.8rem;
        }

        .btn-update {
            min-width: 150px;
            background: var(--primary-500);
            color: white;
            border-color: var(--primary-500);
        }

        .btn-update:hover {
            background: var(--primary-600);
        }

        .btn-send {
            min-width: 100px;
        }

        .card {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 1px solid rgba(99, 102, 241, 0.18);
            padding: var(--space-4);
            display: flex;
            flex-direction: column;
            box-shadow: var(--shadow-md);
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            inset: 0 0 auto 0;
            height: 4px;
            border-radius: var(--radius-lg) var(--radius-lg) 0 0;
            background: linear-gradient(120deg, rgba(37, 99, 235, 0.85), rgba(236, 72, 153, 0.85));
        }

        .card-title {
            font-size: var(--text-lg);
            font-weight: 600;
            margin-bottom: var(--space-3);
            color: var(--text-primary);
        }

        .control-section {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .control-row {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .control-row label {
            min-width: 80px;
            font-weight: 500;
        }

        .button-group {
            display: flex;
            gap: var(--space-2);
        }

        .control-actions {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .update-progress {
            display: none;
            flex-direction: column;
            gap: var(--space-2);
            margin-top: var(--space-2);
            min-width: 240px;
        }

        .update-progress.active {
            display: flex;
        }

        .update-progress-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 999px;
            overflow: hidden;
        }

        .update-progress-fill {
            width: 0%;
            height: 100%;
            background: #6366f1;
            transition: width 0.25s ease;
        }

        .update-progress-text {
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }

        .update-progress.error .update-progress-fill {
            background: #ef4444;
        }

        .update-progress.error .update-progress-text {
            color: #b91c1c;
        }

        .status-info {
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
            margin: var(--space-2) 0;
            padding: var(--space-2) var(--space-3);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }

        .status-row {
            display: flex;
            gap: var(--space-2);
            font-size: var(--text-sm);
        }

        .status-label {
            font-weight: 600;
            min-width: 100px;
        }

        .status-dot {
            display: inline-flex;
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            color: var(--text-secondary);
        }

        .status-dot-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--danger-500);
        }

        .status-dot-indicator.running {
            background: var(--success-500);
        }

        .status-dot-indicator.paused {
            background: var(--warning-500);
        }

        .status-dot-indicator.starting {
            background: var(--primary-500);
        }

        .control-buttons {
            display: flex;
            gap: var(--space-2);
            margin-top: var(--space-2);
        }

        .form-grid-compact {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: var(--space-3);
        }

        .form-row {
            display: grid;
            grid-template-columns: 120px minmax(0, 1fr);
            align-items: center;
            gap: var(--space-2);
            font-size: var(--text-sm);
            width: 100%;
        }

        .form-row-full {
            grid-column: 1 / -1;
        }

        .form-row label {
            font-weight: 500;
        }

        .form-input-inline, .form-select-inline {
            padding: var(--space-2);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--text-sm);
            width: 100%;
        }

        .form-input-inline:focus, .form-select-inline:focus {
            outline: none;
            border-color: var(--primary-500);
        }

        .readonly-field {
            padding: var(--space-2);
            color: var(--text-secondary);
            font-size: var(--text-sm);
        }

        .radio-group {
            display: flex;
            flex-wrap: wrap;
            gap: var(--space-2);
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            font-weight: normal;
            cursor: pointer;
        }

        .update-button-container {
            margin-top: var(--space-3);
            display: flex;
            justify-content: flex-end;
        }

        .log-preview {
            margin-top: var(--space-2);
            padding: var(--space-2) var(--space-3);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        .log-line {
            flex: 1;
            font-family: monospace;
            font-size: 0.75rem;
            color: var(--text-secondary);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .btn-log {
            min-width: 100px;
            flex-shrink: 0;
        }

        .log-popup {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .log-popup.active {
            display: flex;
        }

        .log-popup-content {
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            border: 2px solid var(--border-color);
            padding: var(--space-6);
            width: 90%;
            max-width: 1000px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
        }

        .log-popup-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-4);
        }

        .log-popup-title {
            font-size: var(--text-xl);
            font-weight: 600;
        }

        .log-popup-body {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            font-family: monospace;
            font-size: 0.75rem;
            line-height: 1.5;
            white-space: pre-wrap;
        }

        .tabs {
            display: flex;
            gap: 0;
            margin-bottom: var(--space-3);
            border-bottom: 2px solid var(--border-color);
        }

        .tab {
            padding: var(--space-2) var(--space-4);
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            margin-bottom: -2px;
        }

        .tab.active {
            color: var(--text-primary);
            border-bottom-color: var(--primary-500);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .players-section {
            flex: 1;
            overflow: auto;
        }

        .players-table {
            width: 100%;
            border-collapse: collapse;
        }

        .player-name {
            display: inline-flex;
            align-items: center;
            gap: var(--space-1);
        }

        .player-admin-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.15rem 0.35rem;
            border-radius: var(--radius-full);
            background: rgba(59, 130, 246, 0.16);
            color: var(--primary-500);
            font-size: 0.8rem;
            font-weight: 600;
        }

        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: var(--space-2) var(--space-4);
            background: var(--danger-500);
            color: #ffffff;
            text-align: center;
            font-weight: 600;
            display: none;
            z-index: 2000;
            box-shadow: var(--shadow-md);
        }

        .connection-banner.active {
            display: block;
        }

        .players-table thead th {
            text-align: left;
            padding: var(--space-2);
            border-bottom: 2px solid var(--border-color);
            font-size: var(--text-sm);
            font-weight: 600;
            color: var(--text-secondary);
        }

        .players-table tbody td {
            padding: var(--space-2);
            border-bottom: 1px solid var(--border-color);
            font-size: var(--text-sm);
        }

        .players-table tbody tr:hover {
            background: var(--bg-secondary);
        }

        .chat-section {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-3);
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            margin-bottom: var(--space-3);
            max-height: 300px;
        }

        .chat-message {
            display: flex;
            gap: var(--space-2);
            margin-bottom: var(--space-2);
            font-size: var(--text-sm);
        }

        .chat-time {
            color: var(--text-tertiary);
            min-width: 40px;
        }

        .chat-player {
            color: var(--text-secondary);
            font-weight: 600;
        }

        .chat-text {
            color: var(--text-primary);
            word-break: break-word;
        }

        .chat-input-form {
            display: flex;
            gap: var(--space-2);
        }

        .chat-input {
            flex: 1;
            padding: var(--space-2) var(--space-3);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: var(--text-sm);
        }

        .chat-input:focus {
            outline: none;
            border-color: var(--primary-500);
        }

        .empty-state {
            text-align: center;
            padding: var(--space-4);
            color: var(--text-tertiary);
            font-size: var(--text-sm);
        }

        .theme-toggle {
            background: rgba(248, 250, 252, 0.15);
            border: 1px solid rgba(255, 255, 255, 0.35);
            border-radius: var(--radius-md);
            padding: var(--space-2);
            cursor: pointer;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #f8fafc;
            transition: transform 0.2s ease;
        }

        .theme-toggle:hover {
            transform: translateY(-1px);
        }

        .checkbox-inline {
            display: flex;
            align-items: center;
            gap: var(--space-2);
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 720px) {
            .form-grid-compact {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: var(--space-1);
            }

            .form-row label {
                font-weight: 600;
            }

            .radio-group {
                justify-content: flex-start;
            }
        }
    </style>
</head>
<body data-server-running="{{if .server.Running}}true{{else}}false{{end}}" data-server-starting="{{if .server.Starting}}true{{else}}false{{end}}" data-server-paused="{{if .server.Paused}}true{{else}}false{{end}}" data-server-id="{{.server.ID}}" data-start-location="{{.server.StartLocation}}" data-start-condition="{{.server.StartCondition}}">
    <div id="connection-status" class="connection-banner" role="status" aria-live="polite">
        <span id="connection-status-text">Connection lost. Attempting to reconnect...</span>
    </div>
    <div class="container">
        <!-- Header with planet image, name, version and world description -->
        <div class="header">
            <div class="planet-section">
                <img src="/server/{{.server.ID}}/world-image?v={{urlquery .server.World}}" alt="{{.server.World}}" class="planet-img" onerror="this.onerror=null;this.src='https://www.stationeers.net/wp-content/uploads/2017/07/Stationeers-Logo-White.png';">
                <div class="server-info-header">
                    <h1 class="server-name-large">{{.server.Name}}</h1>
                    <div class="version-info">Version: 12121212.2.23</div>
                </div>
            </div>
            <div class="world-section">
                <h2 class="world-name">{{.worldInfo.Name}}</h2>
                <p class="world-description">{{.worldInfo.Description}}</p>
            </div>
            <div class="nav-buttons">
                <button class="theme-toggle" onclick="toggleTheme()">üåì</button>
                <a href="/dashboard" class="btn btn-secondary">‚Üê Dashboard</a>
                <a href="/manager" class="btn btn-secondary">Manager</a>
            </div>
        </div>

        <!-- Main grid layout: 2 columns x 2 rows -->
        <div class="main-grid">
            <!-- Top Left: Server Control -->
            <div class="card">
                <div class="card-title" style="display:flex; align-items:center; justify-content:space-between; gap:var(--space-2);">
                    <span>Server Control</span>
                    <span class="status-dot">
                        <span id="status-dot-indicator" class="status-dot-indicator {{if .server.Running}}running{{end}}"></span>
                        <span id="status-dot-text">{{if .server.Running}}Running{{else}}Stopped{{end}}</span>
                    </span>
                </div>
                <form method="POST">
                    <div class="control-section">
                        <div class="control-row">
                            <label>Server:</label>
                            <div class="button-group">
                                <button type="submit" name="start" value="true" class="btn btn-control btn-start" id="btn-start" {{if .server.Running}}style="display:none;" disabled aria-disabled="true"{{end}}>Start</button>
                                <button type="submit" name="stop" value="true" class="btn btn-control btn-stop" id="btn-stop" {{if not .server.Running}}style="display:none;" disabled aria-disabled="true"{{end}}>Stop</button>
                                <button type="submit" name="restart" value="true" class="btn btn-control btn-secondary" id="btn-restart">Restart</button>
                                <button type="button" class="btn btn-control" id="btn-pause" {{if not .server.Running}}disabled aria-disabled="true"{{end}}>{{if .server.Paused}}Resume{{else}}Pause{{end}}</button>
                                <button type="button" class="btn btn-control" id="btn-save" {{if not .server.Running}}disabled aria-disabled="true"{{end}}>Save</button>
                            </div>
                        </div>
                        <div class="control-row">
                            <label>Storm:</label>
                            <div class="button-group">
                                {{if .server.Running}}
                                <button type="button" class="btn btn-control">Start/Stop</button>
                                {{else}}
                                <button type="button" class="btn btn-control" disabled>Start/Stop</button>
                                {{end}}
                            </div>
                        </div>
                        <div class="control-row">
                            <label>Difficulty:</label>
                            <select name="difficulty" class="form-select-inline" {{if not .server.Running}}disabled{{end}}>
                                {{range .manager.GetDifficulties}}
                                <option value="{{.}}" {{if eq . $.server.Difficulty}}selected{{end}}>{{.}}</option>
                                {{end}}
                            </select>
                        </div>
                        <div class="status-info">
                            <div class="status-row">
                                <span class="status-label">Started:</span>
                                <span id="server-started-value">{{if .server.ServerStarted}}{{.server.ServerStarted.Format "01/02/2006 15:04:05"}}{{else}}Not started{{end}}</span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">Last Saved:</span>
                                <span id="server-saved-value">{{if .server.ServerSaved}}{{.server.ServerSaved.Format "01/02/2006 15:04:05"}}{{else}}Not saved{{end}}</span>
                            </div>
                        </div>
                        <div class="log-preview">
                            <div id="last-log-line" class="log-line">{{if .server.LastLogLine}}{{.server.LastLogLine}}{{else}}No log data{{end}}</div>
                            <button type="button" class="btn btn-log" onclick="openLogPopup({{.server.ID}})">View Log</button>
                        </div>
                        <div class="control-row" style="margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid var(--border-color);">
                            <label></label>
                            <div class="control-actions">
                                <div class="button-group">
                                    <button type="submit" name="update_server" value="true" class="btn btn-secondary" {{if or .server.Running .server.Starting}}disabled aria-disabled="true"{{end}}>Update Server</button>
                                <button type="submit" name="delete" value="true" id="btn-delete" class="btn" style="background: var(--danger-500); color: white; border-color: var(--danger-500);" {{if or .server.Running .server.Starting}}disabled aria-disabled="true"{{end}} onclick="return confirm('Are you sure you want to delete this server? This action cannot be undone.')">Delete Server</button>
                                </div>
                                <div id="server-update-progress" class="update-progress" aria-live="polite">
                                    <div class="update-progress-bar">
                                        <div class="update-progress-fill"></div>
                                    </div>
                                    <div class="update-progress-text">Idle</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Top Right: Players List -->
            {{ $live := .server.LiveClients }}
            {{ $liveCount := len $live }}
            {{ $history := .server.Clients }}
            {{ $historyCount := len $history }}
            <div class="card">
                <h2 class="card-title">Players List <span id="players-live-count" style="font-size: var(--text-sm); color: var(--text-secondary); margin-left: var(--space-2);">{{if gt $liveCount 0}}{{printf "%d online" $liveCount}}{{else}}0 online{{end}}</span></h2>
                <div class="tabs">
                    <button type="button" class="tab active" data-target="players-live">Live</button>
                    <button type="button" class="tab" data-target="players-history">History</button>
                </div>
                <div class="players-section">
                    <div class="tab-content active" id="players-live">
                        <table class="players-table" id="players-live-table" {{if eq $liveCount 0}}style="display:none;"{{end}}>
                            <thead>
                                <tr>
                                    <th>Player Name</th>
                                    <th>Steam ID</th>
                                    <th>Connected At</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="players-live-body">
                                {{range $live}}
                                <tr>
                                    <td>
                                        <span class="player-name">
                                            {{.Name}}
                                            {{if .IsAdmin}}
                                            <span class="player-admin-icon" title="Admin" aria-label="Admin">üõ°Ô∏è</span>
                                            {{end}}
                                        </span>
                                    </td>
                                    <td>{{.SteamID}}</td>
                                    <td>{{.ConnectDatetime.Format "2006-01-02 15:04:05"}}</td>
                                    <td>
                                        <form method="POST" style="display: inline;">
                                            <button type="submit" name="kick" value="{{.Name}}" class="btn btn-player-action">Kick</button>
                                        </form>
                                    </td>
                                    <td>
                                        <form method="POST" style="display: inline;">
                                            <button type="submit" name="ban" value="{{.Name}}" class="btn btn-player-action">Ban</button>
                                        </form>
                                    </td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                        <div class="empty-state" id="players-live-empty" {{if gt $liveCount 0}}style="display:none;"{{end}}>No players currently connected</div>
                    </div>
                    <div class="tab-content" id="players-history">
                        <table class="players-table" id="players-history-table" {{if eq $historyCount 0}}style="display:none;"{{end}}>
                            <thead>
                                <tr>
                                    <th>Player Name</th>
                                    <th>Steam ID</th>
                                    <th>Connected At</th>
                                    <th>Disconnected At</th>
                                    <th>Session Length</th>
                                </tr>
                            </thead>
                            <tbody id="players-history-body">
                                {{range $history}}
                                <tr>
                                    <td>
                                        <span class="player-name">
                                            {{.Name}}
                                            {{if .IsAdmin}}
                                            <span class="player-admin-icon" title="Admin" aria-label="Admin">üõ°Ô∏è</span>
                                            {{end}}
                                        </span>
                                    </td>
                                    <td>{{.SteamID}}</td>
                                    <td>{{.ConnectDatetime.Format "2006-01-02 15:04:05"}}</td>
                                    <td>{{if .DisconnectDatetime}}{{.DisconnectDatetime.Format "2006-01-02 15:04:05"}}{{else}}Active{{end}}</td>
                                    <td>{{.SessionDurationString}}</td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                        <div class="empty-state" id="players-history-empty" {{if gt $historyCount 0}}style="display:none;"{{end}}>No player sessions recorded</div>
                    </div>
                </div>
            </div>

            <!-- Bottom Left: Startup Parameters -->
            <div class="card">
                <h2 class="card-title">Startup Parameters</h2>
                <form method="POST">
                    <div class="form-grid-compact">
                        <div class="form-row form-row-full">
                            <label>Server Path:</label>
                            <span class="readonly-field">{{.serverPath}}</span>
                        </div>
                        <div class="form-row">
                            <label>Name:</label>
                            <input type="text" name="name" value="{{.server.Name}}" class="form-input-inline">
                        </div>
                        <div class="form-row">
                            <label>World:</label>
                            <select name="world" id="world" class="form-select-inline">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Start Location:</label>
                            <select name="start_location" id="start_location" class="form-select-inline">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Start Condition:</label>
                            <select name="start_condition" id="start_condition" class="form-select-inline">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Difficulty:</label>
                            <select name="difficulty_param" class="form-select-inline">
                                {{range .manager.GetDifficulties}}
                                <option value="{{.}}" {{if eq . $.server.Difficulty}}selected{{end}}>{{.}}</option>
                                {{end}}
                            </select>
                        </div>
                        <div class="form-row">
                            <label>Port:</label>
                            <input type="number" name="port" value="{{.server.Port}}" class="form-input-inline">
                        </div>
                        <div class="form-row">
                            <label>Save Interval (sec):</label>
                            <input type="number" name="save_interval" value="{{.server.SaveInterval}}" class="form-input-inline">
                        </div>
                        <div class="form-row">
                            <label>Restart Delay (sec):</label>
                            <input type="number" name="restart_delay_seconds" value="{{.server.RestartDelaySeconds}}" class="form-input-inline" min="0" max="3600">
                        </div>
                        <div class="form-row">
                            <label>Auth Secret:</label>
                            <input type="text" name="auth_secret" value="{{.server.AuthSecret}}" class="form-input-inline">
                        </div>
                        <div class="form-row">
                            <label>Server Password:</label>
                            <input type="password" name="password" value="{{.server.Password}}" class="form-input-inline">
                        </div>
                        <div class="form-row">
                            <label>Max Players:</label>
                            <input type="number" name="max_clients" value="{{.server.MaxClients}}" class="form-input-inline">
                        </div>
                        <div class="form-row">
                            <label>Release:</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="beta" value="false" {{if not .server.Beta}}checked{{end}}> Release
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="beta" value="true" {{if .server.Beta}}checked{{end}}> Beta
                                </label>
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Server Visible:</label>
                            <div class="checkbox-inline">
                                <input type="checkbox" name="server_visible" {{if .server.Visible}}checked{{end}}>
                                <span>Public</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Auto Update:</label>
                            <div class="checkbox-inline">
                                <input type="checkbox" name="auto_update" {{if .server.AutoUpdate}}checked{{end}}>
                                <span>Enable</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Auto Save:</label>
                            <div class="checkbox-inline">
                                <input type="checkbox" name="auto_save" {{if .server.AutoSave}}checked{{end}}>
                                <span>Enable</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Auto Pause:</label>
                            <div class="checkbox-inline">
                                <input type="checkbox" name="auto_pause" {{if .server.AutoPause}}checked{{end}}>
                                <span>Enable</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <label>Auto Start:</label>
                            <div class="checkbox-inline">
                                <input type="checkbox" name="auto_start" {{if .server.AutoStart}}checked{{end}}>
                                <span>Enable</span>
                            </div>
                        </div>
                    </div>
                    <div class="update-button-container">
                        <button type="submit" name="update" value="true" class="btn btn-update" {{if or .server.Running .server.Starting}}disabled aria-disabled="true"{{end}}>Update</button>
                    </div>
                </form>
            </div>

            <!-- Bottom Right: Chat -->
            <div class="card">
                <h2 class="card-title">Chat</h2>
                <div class="chat-section">
                    <div class="chat-messages">
                        {{if .server.Chat}}
                        {{range .server.Chat}}
                        <div class="chat-message">
                            <span class="chat-time">{{.Time.Format "15:04"}}</span>
                            <span class="chat-player">{{.Player}}:</span>
                            <span class="chat-text">{{.Message}}</span>
                        </div>
                        {{end}}
                        {{else}}
                        <div class="empty-state">No chat messages</div>
                        {{end}}
                    </div>
                    <form method="POST" class="chat-input-form">
                        <input type="text" name="chat_message" placeholder="Type message..." class="chat-input">
                        <button type="submit" name="send_chat" value="true" class="btn btn-send">Send</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Log Popup -->
    <div id="logPopup" class="log-popup">
        <div class="log-popup-content">
            <div class="log-popup-header">
                <h2 class="log-popup-title">Server Log</h2>
                <button class="btn btn-secondary" onclick="closeLogPopup()">Close</button>
            </div>
            <div id="logPopupBody" class="log-popup-body">
                Loading...
            </div>
        </div>
    </div>

    <script>
        function openLogPopup(serverId) {
            const popup = document.getElementById('logPopup');
            const body = document.getElementById('logPopupBody');
            popup.classList.add('active');
            body.textContent = 'Loading log...';
            
            // Fetch server log via server route
            fetch(`/server/${serverId}/log`, { credentials: 'same-origin' })
                .then(r => r.text())
                .then(log => {
                    body.textContent = log || 'No log data available';
                    // Auto-scroll to bottom
                    body.scrollTop = body.scrollHeight;
                })
                .catch(err => {
                    body.textContent = 'Error loading log: ' + err.message;
                });
        }

        function closeLogPopup() {
            document.getElementById('logPopup').classList.remove('active');
        }

        // Close popup when clicking outside
        document.getElementById('logPopup').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLogPopup();
            }
        });

        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme') || 'dark';
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
        }

        // Load saved theme
        const savedTheme = localStorage.getItem('theme') || 'dark';
        document.documentElement.setAttribute('data-theme', savedTheme);
        const rootEl = document.body;
        const statusIndicator = document.getElementById('status-dot-indicator');
        const statusText = document.getElementById('status-dot-text');
        const startedValueEl = document.getElementById('server-started-value');
        const savedValueEl = document.getElementById('server-saved-value');
        const lastLogLineEl = document.getElementById('last-log-line');
        const playersLiveTable = document.getElementById('players-live-table');
        const playersLiveBody = document.getElementById('players-live-body');
        const playersLiveEmpty = document.getElementById('players-live-empty');
        const playersLiveCount = document.getElementById('players-live-count');
        const playersHistoryTable = document.getElementById('players-history-table');
        const playersHistoryBody = document.getElementById('players-history-body');
        const playersHistoryEmpty = document.getElementById('players-history-empty');
        const startButton = document.getElementById('btn-start');
        const stopButton = document.getElementById('btn-stop');
        const restartButton = document.getElementById('btn-restart');
        const pauseButton = document.getElementById('btn-pause');
        const saveButton = document.getElementById('btn-save');
        const deleteButton = document.getElementById('btn-delete');
        const connectionBanner = document.getElementById('connection-status');
        const connectionBannerText = document.getElementById('connection-status-text');

        let serverIsRunning = rootEl.dataset.serverRunning === "true";
        let serverIsPaused = rootEl.dataset.serverPaused === "true";
        let serverIsStarting = rootEl.dataset.serverStarting === "true";
        let updateButton = null;
        let progressContainer = null;
        let progressFill = null;
        let progressText = null;
        let progressTimer = null;
        let statusTimer = null;
        let progressActive = false;
        let connectionLost = false;
        let reconnectTimer = null;
        let setUpdateButtonDisabled = function() {};
        let stopProgressPolling = function() {};
        let startProgressPolling = function() {};
        let refreshUpdateButtonState = function() {};
        let updateServerStatusUI = function() {};
        let fetchProgress = function() {};
        let fetchStatus = function() {};
        let stopStatusUpdates = function() {};
        let startStatusUpdates = function() {};

        updateControlButtons({ running: serverIsRunning, paused: serverIsPaused, starting: serverIsStarting });

        function pad2(value) {
            return String(value).padStart(2, '0');
        }

        function formatDateTimeDisplay(value, fallback) {
            if (!value) {
                return fallback;
            }
            const dt = new Date(value);
            if (Number.isNaN(dt.getTime())) {
                return fallback;
            }
            return `${pad2(dt.getMonth() + 1)}/${pad2(dt.getDate())}/${dt.getFullYear()} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}:${pad2(dt.getSeconds())}`;
        }

        function setTextContent(el, text) {
            if (el) {
                el.textContent = text;
            }
        }

        function showElement(el, shouldShow, displayValue) {
            if (!el) {
                return;
            }
            if (shouldShow) {
                if (displayValue) {
                    el.style.display = displayValue;
                } else {
                    el.style.removeProperty('display');
                }
            } else {
                el.style.display = 'none';
            }
        }

        function setButtonDisabled(btn, disabled) {
            if (!btn) {
                return;
            }
            const isDisabled = !!disabled;
            btn.disabled = isDisabled;
            if (isDisabled) {
                btn.setAttribute('aria-disabled', 'true');
            } else {
                btn.removeAttribute('aria-disabled');
            }
        }

        function updateLiveCount(count) {
            if (!playersLiveCount) {
                return;
            }
            const value = Number(count) || 0;
            playersLiveCount.textContent = value === 1 ? '1 online' : `${value} online`;
        }

        function createTextCell(text) {
            const td = document.createElement('td');
            td.textContent = text;
            return td;
        }

        function createPlayerNameCell(player) {
            const td = document.createElement('td');
            const wrapper = document.createElement('span');
            wrapper.className = 'player-name';

            const nameSpan = document.createElement('span');
            nameSpan.textContent = player && player.name ? player.name : 'Unknown';
            wrapper.appendChild(nameSpan);

            if (player && player.is_admin) {
                const badge = document.createElement('span');
                badge.className = 'player-admin-icon';
                badge.title = 'Admin';
                badge.setAttribute('aria-label', 'Admin');
                badge.textContent = 'üõ°Ô∏è';
                wrapper.appendChild(badge);
            }

            td.appendChild(wrapper);
            return td;
        }

        function createActionCell(playerName, action) {
            const td = document.createElement('td');
            const form = document.createElement('form');
            form.method = 'POST';
            form.style.display = 'inline';

            const button = document.createElement('button');
            button.type = 'submit';
            button.name = action;
            button.value = playerName || '';
            button.className = 'btn btn-player-action';
            button.textContent = action.charAt(0).toUpperCase() + action.slice(1);

            form.appendChild(button);
            td.appendChild(form);
            return td;
        }

        function renderLivePlayers(players) {
            if (!playersLiveBody) {
                return;
            }
            playersLiveBody.textContent = '';

            if (!Array.isArray(players) || players.length === 0) {
                showElement(playersLiveTable, false);
                showElement(playersLiveEmpty, true);
                updateLiveCount(0);
                return;
            }

            showElement(playersLiveTable, true, 'table');
            showElement(playersLiveEmpty, false);

            players.forEach(player => {
                const row = document.createElement('tr');
                row.appendChild(createPlayerNameCell(player));
                row.appendChild(createTextCell(player.steam_id || ''));
                row.appendChild(createTextCell(formatDateTimeDisplay(player.connected_at, '‚Äî')));
                row.appendChild(createActionCell(player.name || '', 'kick'));
                row.appendChild(createActionCell(player.name || '', 'ban'));
                playersLiveBody.appendChild(row);
            });

            updateLiveCount(players.length);
        }

        function renderHistoryPlayers(history) {
            if (!playersHistoryBody) {
                return;
            }
            playersHistoryBody.textContent = '';

            if (!Array.isArray(history) || history.length === 0) {
                showElement(playersHistoryTable, false);
                showElement(playersHistoryEmpty, true);
                return;
            }

            showElement(playersHistoryTable, true, 'table');
            showElement(playersHistoryEmpty, false);

            history.forEach(entry => {
                const row = document.createElement('tr');
                row.appendChild(createPlayerNameCell(entry));
                row.appendChild(createTextCell(entry.steam_id || ''));
                row.appendChild(createTextCell(formatDateTimeDisplay(entry.connected_at, '‚Äî')));
                row.appendChild(createTextCell(entry.disconnect_at ? formatDateTimeDisplay(entry.disconnect_at, '‚Äî') : 'Active'));
                row.appendChild(createTextCell(entry.session_length || '‚Äî'));
                playersHistoryBody.appendChild(row);
            });
        }

        function setConnectionBanner(active, message) {
            if (!connectionBanner) {
                return;
            }
            if (active) {
                connectionBanner.classList.add('active');
                if (connectionBannerText && message) {
                    connectionBannerText.textContent = message;
                }
                document.body.style.paddingTop = '3rem';
            } else {
                connectionBanner.classList.remove('active');
                document.body.style.paddingTop = '';
            }
        }

        function clearReconnectTimer() {
            if (reconnectTimer) {
                clearInterval(reconnectTimer);
                reconnectTimer = null;
            }
        }

        function handleConnectionLost() {
            if (connectionLost) {
                return;
            }
            connectionLost = true;
            setConnectionBanner(true, 'Connection lost. Attempting to reconnect...');
            stopStatusUpdates();
            stopProgressPolling();
            setUpdateButtonDisabled(true);
            updateControlButtons();
            if (!reconnectTimer) {
                reconnectTimer = setInterval(attemptReconnect, 5000);
            }
            attemptReconnect();
        }

        function handleConnectionRestored() {
            if (!connectionLost) {
                return;
            }
            connectionLost = false;
            clearReconnectTimer();
            setConnectionBanner(false);
            refreshUpdateButtonState();
            updateControlButtons();
            startStatusUpdates();
            if (progressActive) {
                startProgressPolling();
            }
        }

        function attemptReconnect() {
            const serverId = rootEl.dataset.serverId;
            if (!serverId) {
                return;
            }
            fetch(`/server/${serverId}/status.json`, {
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server unavailable');
                    }
                    return response.json();
                })
                .then(data => {
                    handleConnectionRestored();
                    updateServerStatusUI(data);
                    fetchProgress();
                })
                .catch(() => {
                    // Keep retrying until server responds again
                });
        }

        function updateControlButtons(status) {
            const statusObj = status || {};
            const running = typeof statusObj.running === 'boolean' ? statusObj.running : serverIsRunning;
            const paused = typeof statusObj.paused === 'boolean' ? statusObj.paused : serverIsPaused;
            const starting = typeof statusObj.starting === 'boolean' ? statusObj.starting : serverIsStarting;

            if (connectionLost) {
                setButtonDisabled(startButton, true);
                setButtonDisabled(stopButton, true);
                setButtonDisabled(restartButton, true);
                setButtonDisabled(pauseButton, true);
                setButtonDisabled(saveButton, true);
                setButtonDisabled(deleteButton, true);
                serverIsRunning = running;
                serverIsPaused = paused;
                serverIsStarting = starting;
                return;
            }

            if (startButton) {
                showElement(startButton, !running);
                setButtonDisabled(startButton, running || progressActive);
            }

            if (stopButton) {
                showElement(stopButton, running);
                setButtonDisabled(stopButton, !running || progressActive);
            }

            if (restartButton) {
                setButtonDisabled(restartButton, progressActive || starting);
            }

            if (pauseButton) {
                pauseButton.textContent = paused ? 'Resume' : 'Pause';
                setButtonDisabled(pauseButton, !running || progressActive || starting);
            }

            if (saveButton) {
                setButtonDisabled(saveButton, !running || progressActive || starting);
            }

            if (deleteButton) {
                setButtonDisabled(deleteButton, running || starting);
            }

            serverIsRunning = running;
            serverIsPaused = paused;
            serverIsStarting = starting;
        }

        let worldLists = {"release": [], "beta": []};
        let worldDataByVersion = {"release": {}, "beta": {}};

        {{ if and .worldLists .worldData }}
        {{ $worldLists := .worldLists }}
        {{ $worldData := .worldData }}
        worldLists = {
            "release": [
                {{ $release := index $worldLists "release" }}
                {{ range $idx, $world := $release }}
                {{ if $idx}}, {{ end }}
                "{{js $world}}"
                {{ end }}
            ],
            "beta": [
                {{ $beta := index $worldLists "beta" }}
                {{ range $idx, $world := $beta }}
                {{ if $idx}}, {{ end }}
                "{{js $world}}"
                {{ end }}
            ]
        };

        worldDataByVersion = {
            "release": {
                {{ $releaseData := index $worldData "release" }}
                {{ $releaseList := index $worldLists "release" }}
                {{ range $idx, $world := $releaseList }}
                {{ if $idx}}, {{ end }}
                "{{js $world}}": {
                    "locations": [
                        {{ with index $releaseData $world }}
                        {{ range $locIdx, $loc := index . "locations" }}
                        {{ if $locIdx}}, {{ end }}
                        {"ID": "{{js $loc.ID}}", "Name": "{{js $loc.Name}}", "Description": "{{js $loc.Description}}"}
                        {{ end }}
                        {{ end }}
                    ],
                    "conditions": [
                        {{ with index $releaseData $world }}
                        {{ range $condIdx, $cond := index . "conditions" }}
                        {{ if $condIdx}}, {{ end }}
                        {"ID": "{{js $cond.ID}}", "Name": "{{js $cond.Name}}", "Description": "{{js $cond.Description}}"}
                        {{ end }}
                        {{ end }}
                    ]
                }
                {{ end }}
            },
            "beta": {
                {{ $betaData := index $worldData "beta" }}
                {{ $betaList := index $worldLists "beta" }}
                {{ range $idx, $world := $betaList }}
                {{ if $idx}}, {{ end }}
                "{{js $world}}": {
                    "locations": [
                        {{ with index $betaData $world }}
                        {{ range $locIdx, $loc := index . "locations" }}
                        {{ if $locIdx}}, {{ end }}
                        {"ID": "{{js $loc.ID}}", "Name": "{{js $loc.Name}}", "Description": "{{js $loc.Description}}"}
                        {{ end }}
                        {{ end }}
                    ],
                    "conditions": [
                        {{ with index $betaData $world }}
                        {{ range $condIdx, $cond := index . "conditions" }}
                        {{ if $condIdx}}, {{ end }}
                        {"ID": "{{js $cond.ID}}", "Name": "{{js $cond.Name}}", "Description": "{{js $cond.Description}}"}
                        {{ end }}
                        {{ end }}
                    ]
                }
                {{ end }}
            }
        };
        {{ end }}

        const initialVersionKey = {{if .server.Beta}}"beta"{{else}}"release"{{end}};
        const initialWorld = {{if .server.World}}"{{js .server.World}}"{{else}}""{{end}};
        const initialStartLocation = {{if .server.StartLocation}}"{{js .server.StartLocation}}"{{else}}""{{end}};
        const initialStartCondition = {{if .server.StartCondition}}"{{js .server.StartCondition}}"{{else}}""{{end}};

        const versionState = {
            release: {
                world: initialVersionKey === 'release' ? initialWorld : '',
                startLocation: initialVersionKey === 'release' ? initialStartLocation : '',
                startCondition: initialVersionKey === 'release' ? initialStartCondition : ''
            },
            beta: {
                world: initialVersionKey === 'beta' ? initialWorld : '',
                startLocation: initialVersionKey === 'beta' ? initialStartLocation : '',
                startCondition: initialVersionKey === 'beta' ? initialStartCondition : ''
            }
        };

        function currentVersionKey() {
            const checked = document.querySelector('input[name="beta"]:checked');
            return checked && checked.value === "true" ? "beta" : "release";
        }

        function selectOptionWithFallback(select, value, fallbackLabel = ' (configured)') {
            if (!select) {
                return;
            }
            if (!value) {
                select.value = '';
                return;
            }
            const existing = Array.from(select.options).find(opt => opt.value === value);
            if (existing) {
                existing.selected = true;
                select.value = value;
                return;
            }
            const option = document.createElement('option');
            option.value = value;
            option.textContent = fallbackLabel ? value + fallbackLabel : value;
            option.dataset.fallback = 'true';
            select.appendChild(option);
            select.value = value;
        }

        function populateWorldOptions() {
            const worldSelect = document.getElementById('world');
            const versionKey = currentVersionKey();
            const worlds = worldLists[versionKey] || [];
            const state = versionState[versionKey];

            worldSelect.innerHTML = '';

            if (!worlds.length) {
                worldSelect.innerHTML = '<option value="">No worlds available</option>';
                selectOptionWithFallback(worldSelect, state.world, ' (configured)');
                updateWorldOptions();
                return;
            }

            if (!state.world) {
                state.world = worlds[0];
                state.startLocation = '';
                state.startCondition = '';
            }

            worlds.forEach(world => {
                const option = document.createElement('option');
                option.value = world;
                option.textContent = world;
                worldSelect.appendChild(option);
            });

            selectOptionWithFallback(worldSelect, state.world, ' (configured)');
            state.world = worldSelect.value;

            updateWorldOptions();
        }

        function updateWorldOptions() {
            const worldSelect = document.getElementById('world');
            const locSelect = document.getElementById('start_location');
            const condSelect = document.getElementById('start_condition');
            const versionKey = currentVersionKey();
            const world = worldSelect.value;
            const worldData = (worldDataByVersion[versionKey] || {})[world];
            const state = versionState[versionKey];

            locSelect.innerHTML = '<option value="">-- Select Start Location --</option>';
            condSelect.innerHTML = '<option value="">-- Select Start Condition --</option>';

            if (worldData) {
                (worldData.locations || []).forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.ID;
                option.textContent = loc.Name || loc.ID;
                if (loc.Description) {
                    option.title = loc.Description;
                }
                locSelect.appendChild(option);
            });

                (worldData.conditions || []).forEach(cond => {
                const option = document.createElement('option');
                option.value = cond.ID;
                option.textContent = cond.Name || cond.ID;
                if (cond.Description) {
                    option.title = cond.Description;
                }
                condSelect.appendChild(option);
            });
            }
            selectOptionWithFallback(locSelect, state.startLocation);
            selectOptionWithFallback(condSelect, state.startCondition);
        }

        document.addEventListener('DOMContentLoaded', () => {
            const worldSelect = document.getElementById('world');
            const locSelect = document.getElementById('start_location');
            const condSelect = document.getElementById('start_condition');
            const versionRadios = document.querySelectorAll('input[name="beta"]');

            populateWorldOptions();

            const tabButtons = document.querySelectorAll('.tabs .tab');
            const tabContents = document.querySelectorAll('.tab-content');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    const targetId = button.getAttribute('data-target');
                    const target = targetId ? document.getElementById(targetId) : null;
                    if (target) {
                        target.classList.add('active');
                    }
                });
            });

            if (worldSelect) {
                worldSelect.addEventListener('change', () => {
                    const versionKey = currentVersionKey();
                    const state = versionState[versionKey];
                    state.world = worldSelect.value;
                    state.startLocation = '';
                    state.startCondition = '';
                    updateWorldOptions();
                });
            }

            versionRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    populateWorldOptions();
                });
            });

            if (locSelect) {
                locSelect.addEventListener('change', () => {
                    const state = versionState[currentVersionKey()];
                    state.startLocation = locSelect.value;
                });
            }

            if (condSelect) {
                condSelect.addEventListener('change', () => {
                    const state = versionState[currentVersionKey()];
                    state.startCondition = condSelect.value;
                });
            }

            const serverId = Number(rootEl.dataset.serverId || '0');
            updateButton = document.querySelector('button[name="update_server"]');
            progressContainer = document.getElementById('server-update-progress');
            progressFill = progressContainer ? progressContainer.querySelector('.update-progress-fill') : null;
            progressText = progressContainer ? progressContainer.querySelector('.update-progress-text') : null;

            setUpdateButtonDisabled = function(disabled) {
                if (!updateButton) {
                    return;
                }
                updateButton.disabled = !!disabled;
                if (disabled) {
                    updateButton.setAttribute('aria-disabled', 'true');
                } else {
                    updateButton.removeAttribute('aria-disabled');
                }
            };

            function clampPercent(value) {
                if (Number.isNaN(value)) {
                    return 0;
                }
                return Math.max(0, Math.min(100, value));
            }

            stopProgressPolling = function() {
                if (progressTimer) {
                    clearInterval(progressTimer);
                    progressTimer = null;
                }
            };

            startProgressPolling = function() {
                if (!serverId || progressTimer || connectionLost) {
                    return;
                }
                progressTimer = setInterval(fetchProgress, 2000);
            };

            refreshUpdateButtonState = function() {
                if (!updateButton) {
                    return;
                }
                if (connectionLost || serverIsRunning || serverIsStarting || progressActive) {
                    setUpdateButtonDisabled(true);
                } else {
                    setUpdateButtonDisabled(false);
                }
            };

            function updateProgressUI(data) {
                if (!progressContainer) {
                    return;
                }
                const stage = (data && data.stage ? data.stage : '').trim();
                const percentRaw = data && typeof data.percent === 'number' ? data.percent : parseInt(data && data.percent, 10) || 0;
                const percent = clampPercent(percentRaw);
                const running = !!(data && data.running);
                const hasError = !!(data && data.error);
                const isIdleStage = !running && !hasError && percent === 0 && (stage === '' || stage === 'Idle');

                progressActive = running;

                progressContainer.classList.toggle('active', !isIdleStage);
                progressContainer.classList.toggle('error', hasError);

                if (progressFill) {
                    progressFill.style.width = (isIdleStage ? 0 : percent) + '%';
                }

                if (progressText) {
                    let text = stage;
                    if (hasError) {
                        text = 'Error: ' + data.error;
                    } else if (running) {
                        text = text || 'Copying files';
                        text += percent > 0 ? ' (' + percent + '%)' : '...';
                    } else if (percent >= 100 && !hasError) {
                        text = text || 'Completed';
                    } else if (isIdleStage) {
                        text = 'Idle';
                    }
                    progressText.textContent = text.trim();
                }

                if (running) {
                    startProgressPolling();
                } else {
                    stopProgressPolling();
                }

                updateControlButtons();
                refreshUpdateButtonState();
            }

            fetchProgress = function() {
                if (!serverId) {
                    return;
                }
                fetch(`/server/${serverId}/progress`, {
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                    .then(res => (res.ok ? res.json() : null))
                    .then(data => {
                        if (data) {
                            updateProgressUI(data);
                        }
                    })
                    .catch(() => {
                        // Ignore polling errors
                    });
            };

            function handleUpdateClick(event) {
                event.preventDefault();
                if (!updateButton || updateButton.disabled || serverIsRunning || serverIsStarting) {
                    return;
                }

                progressActive = true;
                updateControlButtons();
                refreshUpdateButtonState();

                if (progressContainer) {
                    progressContainer.classList.add('active');
                    progressContainer.classList.remove('error');
                }
                if (progressFill) {
                    progressFill.style.width = '0%';
                }
                if (progressText) {
                    progressText.textContent = 'Starting update...';
                }

                fetch(window.location.pathname, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: 'update_server=1',
                    credentials: 'same-origin'
                })
                    .then(res => {
                        if (!res.ok) {
                            return res.json().then(data => Promise.reject(data));
                        }
                        return res.json();
                    })
                    .then(() => {
                        fetchProgress();
                        startProgressPolling();
                    })
                    .catch(err => {
                        const message = err && err.error ? err.error : 'Unable to start update.';
                        updateProgressUI({ stage: 'Error', percent: 0, running: false, error: message });
                        progressActive = false;
                        updateControlButtons();
                        refreshUpdateButtonState();
                    });
            }

            if (updateButton) {
                updateButton.addEventListener('click', handleUpdateClick);
            }

            updateServerStatusUI = function(data) {
                if (!data) {
                    return;
                }

                const running = !!data.running;
                const starting = !!data.starting;
                serverIsRunning = running;
                serverIsStarting = starting;
                rootEl.dataset.serverRunning = running ? 'true' : 'false';
                rootEl.dataset.serverStarting = starting ? 'true' : 'false';
                serverIsPaused = !!data.paused && running;
                rootEl.dataset.serverPaused = serverIsPaused ? 'true' : 'false';

                if (statusIndicator) {
                    statusIndicator.classList.toggle('starting', running && starting);
                    statusIndicator.classList.toggle('running', running && !serverIsPaused && !starting);
                    statusIndicator.classList.toggle('paused', serverIsPaused && !starting);
                }
                if (statusText) {
                    if (starting && running) {
                        statusText.textContent = 'Starting';
                    } else if (!running) {
                        statusText.textContent = 'Stopped';
                    } else if (serverIsPaused) {
                        statusText.textContent = 'Paused';
                    } else {
                        statusText.textContent = 'Running';
                    }
                }

                const lastLine = data.last_log_line && data.last_log_line.trim() ? data.last_log_line : 'No log data';
                setTextContent(lastLogLineEl, lastLine);

                setTextContent(startedValueEl, formatDateTimeDisplay(data.server_started, 'Not started'));
                setTextContent(savedValueEl, formatDateTimeDisplay(data.server_saved, 'Not saved'));

                if (Array.isArray(data.players)) {
                    renderLivePlayers(data.players);
                } else {
                    renderLivePlayers([]);
                }

                if (Array.isArray(data.clients)) {
                    renderHistoryPlayers(data.clients);
                } else {
                    renderHistoryPlayers([]);
                }

                updateControlButtons(data);
                refreshUpdateButtonState();
            };

            fetchStatus = function() {
                if (!serverId) {
                    return;
                }
                fetch(`/server/${serverId}/status.json`, {
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                    .then(res => {
                        if (res.status === 401) {
                            stopStatusUpdates();
                            return null;
                        }
                        if (!res.ok) {
                            throw new Error('Failed to fetch server status');
                        }
                        return res.json();
                    })
                    .then(data => {
                        if (data) {
                            handleConnectionRestored();
                            updateServerStatusUI(data);
                        }
                    })
                    .catch(() => {
                        handleConnectionLost();
                    });
            };

            stopStatusUpdates = function() {
                if (statusTimer) {
                    clearInterval(statusTimer);
                    statusTimer = null;
                }
            };

            startStatusUpdates = function() {
                if (!serverId || statusTimer || connectionLost) {
                    return;
                }
                statusTimer = setInterval(fetchStatus, 4000);
            };

            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    stopStatusUpdates();
                    stopProgressPolling();
                } else {
                    fetchStatus();
                    fetchProgress();
                    startStatusUpdates();
                    if (progressActive) {
                        startProgressPolling();
                    }
                }
            });

            refreshUpdateButtonState();
            fetchProgress();
            fetchStatus();
            startStatusUpdates();
        });
    </script>
</body>
</html>