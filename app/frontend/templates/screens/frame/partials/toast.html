<div id="toast-container" class="toast-container" role="region" aria-live="polite" data-duration="5000"></div>
<div id="global-htmx-indicator" class="global-htmx-indicator" aria-hidden="true">
    <span class="spinner" aria-hidden="true"></span>
    <span class="label">Loadingâ€¦</span>
 </div>

<script>
    (function() {
        const toastIcons = {
            success: '<i data-feather="check-circle"></i>',
            error: '<i data-feather="x-circle"></i>',
            info: '<i data-feather="info"></i>',
            warning: '<i data-feather="alert-triangle"></i>'
        };

        let toastCounter = 0;
        let inflight = 0;

        function getGlobalToastDuration() {
            const container = document.getElementById('toast-container');
            const raw = container?.dataset?.duration;
            const val = raw ? parseInt(raw, 10) : NaN;
            return Number.isFinite(val) && val >= 0 ? val : 5000;
        }

        function showToast(options) {
            const {
                type = 'info',
                title = '',
                message = '',
                closable = true
            } = options;

            const container = document.getElementById('toast-container');
            if (!container) return;

            const toastId = `toast-${++toastCounter}`;
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast toast-${type}`;
            toast.setAttribute('role', 'alert');

            const icon = toastIcons[type] || toastIcons.info;

            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                ${closable ? `
                    <button class="toast-close" onclick="window.closeToast('${toastId}')" aria-label="Close notification">
                        <i data-feather="x"></i>
                    </button>
                ` : ''}
            `;

            container.appendChild(toast);
            if (window.feather) {
                window.feather.replace({ width: '20', height: '20' });
            }

            const duration = getGlobalToastDuration();
            if (duration > 0) {
                setTimeout(() => {
                    window.closeToast(toastId);
                }, duration);
            }

            return toastId;
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (!toast) return;

            toast.classList.add('toast-exit');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }

        function showGlobalIndicator() {
            const el = document.getElementById('global-htmx-indicator');
            if (el) el.classList.add('active');
        }

        function hideGlobalIndicator() {
            const el = document.getElementById('global-htmx-indicator');
            if (el) el.classList.remove('active');
        }

        window.showToast = showToast;
        window.closeToast = closeToast;
        window.setGlobalToastDuration = function(ms) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const n = parseInt(ms, 10);
            if (Number.isFinite(n) && n >= 0) {
                container.dataset.duration = String(n);
            }
        };

        document.body.addEventListener('htmx:beforeRequest', function() {
            inflight++;
            showGlobalIndicator();
        });

        const handleHtmxResponse = (event) => {
            const xhr = event.detail?.xhr;
            if (!xhr || xhr._toastShown) return;

            const toastType = xhr.getResponseHeader('X-Toast-Type');
            const toastTitle = xhr.getResponseHeader('X-Toast-Title');
            const toastMessage = xhr.getResponseHeader('X-Toast-Message');

            if (toastMessage) {
                showToast({
                    type: toastType || (event.type === 'htmx:responseError' ? 'error' : 'info'),
                    title: toastTitle || (event.type === 'htmx:responseError' ? 'Request Failed' : ''),
                    message: toastMessage
                });
                xhr._toastShown = true;
            }
        };
        
        document.body.addEventListener('htmx:afterRequest', handleHtmxResponse);
        document.body.addEventListener('htmx:responseError', function(event) {
            handleHtmxResponse(event);
            const xhr = event.detail?.xhr;
            if (!xhr?._toastShown) {
                 showToast({
                    type: 'error',
                    title: 'Request Failed',
                    message: 'An error occurred while processing your request.'
                });
            }
        });

        document.body.addEventListener('htmx:afterRequest', function() {
            inflight = Math.max(0, inflight - 1);
            if (inflight === 0) hideGlobalIndicator();
        });
        document.body.addEventListener('htmx:responseError', function() {
            inflight = Math.max(0, inflight - 1);
            if (inflight === 0) hideGlobalIndicator();
        });

        document.body.addEventListener('showToast', (e) => {
            if (e.detail) {
                showToast(e.detail);
            }
        });

    })();
</script>
