{{define "cards/server_status_players.html"}}
{{$liveClients := .liveClients}}
{{$historyClients := .historyClients}}
{{$bannedEntries := .banned}}
<div class="card card-players" id="players-card"
    data-card-id="server-status-players"
    hx-get="/server/{{.server.ID}}/cards/server-status-players"
    hx-trigger="sdsm:card-refresh[event.detail.cardId == 'server-status-players'] from:body"
    hx-target="this"
    hx-swap="outerHTML">
    <div class="card-header card-header-with-actions">
        <div>
            <h2 class="card-title">Players</h2>
            <p class="card-subtitle">Monitor active sessions, historic joins, and ban state in one place.</p>
        </div>
        <div class="chip-row" aria-label="Server player configuration">
            <span class="chip chip-sm {{if .server.PlayerSaves}}chip-success{{else}}chip-muted{{end}}">
                <i data-feather="save"></i>
                Player Saves {{if .server.PlayerSaves}}Enabled{{else}}Disabled{{end}}
            </span>
            <span class="chip chip-sm {{if .server.AutoPause}}chip-success{{else}}chip-muted{{end}}">
                <i data-feather="pause"></i>
                Auto Pause {{if .server.AutoPause}}On{{else}}Off{{end}}
            </span>
            <span class="chip chip-sm chip-muted">
                <i data-feather="users"></i>
                Max {{if gt .server.MaxClients 0}}{{.server.MaxClients}}{{else}}—{{end}} Clients
            </span>
        </div>
    </div>

    <div class="card-body p-0">
        <div class="tabs" role="tablist">
            <button class="tab active" id="tab-live" role="tab" aria-selected="true" aria-controls="players-live-panel">
                Live <span class="badge" id="live-count">{{len $liveClients}}</span>
            </button>
            <button class="tab" id="tab-history" role="tab" aria-selected="false" aria-controls="players-history-panel">
                History <span class="badge" id="history-count">{{len $historyClients}}</span>
            </button>
            {{if eq .role "admin"}}
            <button class="tab" id="tab-banned" role="tab" aria-selected="false" aria-controls="players-banned-panel">
                Banned <span class="badge" id="banned-count">{{len $bannedEntries}}</span>
            </button>
            {{end}}
        </div>

        <div id="players-live-panel" role="tabpanel" aria-labelledby="tab-live">
            <div class="table-container">
                <table class="table table-players">
                    <thead>
                        <tr>
                            <th scope="col">Player</th>
                            <th scope="col">Connection</th>
                            <th scope="col">Status</th>
                            {{if eq .role "admin"}}<th scope="col" class="text-right">Actions</th>{{end}}
                        </tr>
                    </thead>
                    <tbody id="live-players-table">
                        {{range $liveClients}}
                            {{$steamID := .SteamID}}
                            {{$playerSaveEligible := and $.server.PlayerSaves (ne $steamID "") (not ($.server.HasPlayerSaveExclude $steamID))}}
                            <tr class="player-row" data-steam-id="{{$steamID}}" {{if $steamID}}data-guid="{{$steamID}}"{{end}} data-player-save="{{if $playerSaveEligible}}enabled{{else}}disabled{{end}}">
                                <td class="player-cell">
                                    <div class="player-name">{{if .Name}}{{.Name}}{{else}}Unknown Player{{end}}</div>
                                    <div class="player-meta">
                                        {{if $steamID}}<span class="player-meta-item">Steam: {{$steamID}}</span>{{else}}<span class="player-meta-item text-muted">Steam ID unavailable</span>{{end}}
                                        {{if .IsAdmin}}<span class="player-pill is-admin" title="Server administrator">Admin</span>{{end}}
                                    </div>
                                </td>
                                <td class="player-connection">
                                    <div class="player-meta-item">Joined {{if .ConnectDatetime.IsZero}}—{{else}}{{.ConnectDatetime.Format "Jan 2, 2006 3:04 PM"}}{{end}}</div>
                                    <div class="player-meta-item">Session {{.SessionDurationString}}</div>
                                </td>
                                <td class="player-status">
                                    {{if $playerSaveEligible}}
                                        <span class="player-pill is-save-enabled" title="Player saves enabled">
                                            <i data-feather="save"></i> Save Active
                                        </span>
                                    {{else if and $.server.PlayerSaves (ne $steamID "")}}
                                        <span class="player-pill is-save-disabled" title="Excluded from automatic player saves">
                                            <i data-feather="slash"></i> Save Excluded
                                        </span>
                                    {{else if $.server.PlayerSaves}}
                                        <span class="player-pill is-save-disabled" title="Steam ID required for player saves">Steam ID Needed</span>
                                    {{else}}
                                        <span class="player-pill is-save-disabled">Manual Saves Only</span>
                                    {{end}}
                                </td>
                                {{if eq $.role "admin"}}
                                <td class="player-actions text-right">
                                    <button class="btn btn-icon btn-sm btn-danger btn-kick" {{if not $steamID}}disabled title="Steam ID required"{{else}}title="Kick player"{{end}} data-steam-id="{{$steamID}}" {{if $steamID}}data-guid="{{$steamID}}"{{end}}>
                                        <i data-feather="user-x"></i>
                                    </button>
                                    <button class="btn btn-icon btn-sm btn-warning btn-ban" {{if not $steamID}}disabled title="Steam ID required"{{else}}title="Ban player"{{end}} data-steam-id="{{$steamID}}" {{if $steamID}}data-guid="{{$steamID}}"{{end}}>
                                        <i data-feather="slash"></i>
                                    </button>
                                </td>
                                {{end}}
                            </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div id="live-players-empty" class="empty-state {{if $liveClients}}hidden{{end}}">
                <i data-feather="users"></i>
                <h3 class="empty-state-title">No Players Online</h3>
                <p class="empty-state-description">Players will appear here immediately after they join.</p>
            </div>
        </div>

        <div id="players-history-panel" role="tabpanel" aria-labelledby="tab-history" class="hidden">
            <div class="table-container">
                <table class="table table-players">
                    <thead>
                        <tr>
                            <th scope="col">
                                <button type="button" class="history-view-toggle active" data-history-view="player">Player</button>
                            </th>
                            <th scope="col">
                                <button type="button" class="history-view-toggle" data-history-view="session">Session</button>
                            </th>
                            <th scope="col">Status</th>
                            {{if eq .role "admin"}}<th scope="col" class="text-right">Actions</th>{{end}}
                        </tr>
                    </thead>
                    <tbody id="history-players-table">
                        {{range $historyClients}}
                            {{$steamID := .SteamID}}
                            {{$playerSaveEligible := and $.server.PlayerSaves (ne $steamID "") (not ($.server.HasPlayerSaveExclude $steamID))}}
                            {{$isBanned := has $.banned_ids $steamID}}
                            <tr class="player-row" data-steam-id="{{$steamID}}" {{if $steamID}}data-guid="{{$steamID}}"{{end}} data-player-save="{{if $playerSaveEligible}}enabled{{else}}disabled{{end}}">
                                <td class="player-cell">
                                    <div class="player-name">{{if .Name}}{{.Name}}{{else}}Unknown Player{{end}}</div>
                                    <div class="player-meta">
                                        {{if $steamID}}<span class="player-meta-item">Steam: {{$steamID}}</span>{{end}}
                                        {{if .IsAdmin}}<span class="player-pill is-admin">Admin</span>{{end}}
                                        {{if $isBanned}}<span class="player-pill is-banned">Banned</span>{{end}}
                                    </div>
                                </td>
                                <td class="player-connection">
                                    <div class="player-meta-item">Joined {{if .ConnectDatetime.IsZero}}—{{else}}{{.ConnectDatetime.Format "Jan 2, 2006 3:04 PM"}}{{end}}</div>
                                    <div class="player-meta-item">{{if .DisconnectDatetime}}Last seen {{.DisconnectDatetime.Format "Jan 2, 2006 3:04 PM"}}{{else}}Currently online{{end}}</div>
                                </td>
                                <td class="player-status">
                                    {{if $playerSaveEligible}}
                                        <span class="player-pill is-save-enabled"><i data-feather="save"></i> Save Active</span>
                                    {{else if and $.server.PlayerSaves (ne $steamID "")}}
                                        <span class="player-pill is-save-disabled">Excluded</span>
                                    {{else if $.server.PlayerSaves}}
                                        <span class="player-pill is-save-disabled">Steam ID Needed</span>
                                    {{else}}
                                        <span class="player-pill is-save-disabled">Manual Only</span>
                                    {{end}}
                                </td>
                                {{if eq $.role "admin"}}
                                <td class="player-actions text-right">
                                    <button class="btn btn-icon btn-sm btn-warning btn-ban" {{if or (not $steamID) $isBanned}}disabled{{end}} data-steam-id="{{$steamID}}" {{if $steamID}}data-guid="{{$steamID}}"{{end}} title="Ban player"><i data-feather="slash"></i></button>
                                </td>
                                {{end}}
                            </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div id="history-players-empty" class="empty-state {{if $historyClients}}hidden{{end}}">
                <i data-feather="clock"></i>
                <h3 class="empty-state-title">No Player History</h3>
                <p class="empty-state-description">History is populated once the server captures player log data.</p>
            </div>
        </div>

        {{if eq .role "admin"}}
        <div id="players-banned-panel" role="tabpanel" aria-labelledby="tab-banned" class="hidden">
            <div class="table-container">
                <table class="table table-players">
                    <thead>
                        <tr>
                            <th scope="col">Steam ID</th>
                            <th scope="col">Last Known Name</th>
                            <th scope="col" class="text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="banned-players-table">
                        {{range $bannedEntries}}
                            <tr class="player-row" data-steam-id="{{.SteamID}}" data-guid="{{.SteamID}}">
                                <td>
                                    <div class="player-name">{{if .SteamID}}{{.SteamID}}{{else}}Unknown ID{{end}}</div>
                                </td>
                                <td>{{if .Name}}{{.Name}}{{else}}Unknown Player{{end}}</td>
                                <td class="player-actions text-right">
                                    <button class="btn btn-icon btn-sm btn-success btn-unban" data-steam-id="{{.SteamID}}" data-guid="{{.SteamID}}" title="Remove ban">
                                        <i data-feather="check-circle"></i>
                                    </button>
                                </td>
                            </tr>
                        {{end}}
                    </tbody>
                </table>
            </div>
            <div id="banned-players-empty" class="empty-state {{if $bannedEntries}}hidden{{end}}">
                <i data-feather="shield-off"></i>
                <h3 class="empty-state-title">No Banned Players</h3>
                <p class="empty-state-description">Ban a player from the Live or History tabs to populate this list.</p>
            </div>
        </div>
        {{end}}
    </div>
</div>
{{end}}
