<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{.server.Name}} - SDSM</title>
    <meta name="description" content="Stationeers Server Status - Monitor live state, players, and logs">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/ui-theme.css">
    <style>
        /* Lightweight modal styles (scoped to this page) */
        .confirm-modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.5);z-index:1000}
        .confirm-modal.active{display:flex}
        .confirm-modal .modal-card{max-width:520px;width:92%;background:var(--card-bg, #111);color:var(--text-color, #fff);border:1px solid var(--border-color, #333);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
        .confirm-modal .modal-header{padding:16px 20px;border-bottom:1px solid var(--border-color, #333);display:flex;align-items:center;gap:10px}
        .confirm-modal .modal-header .icon{width:20px;height:20px;color:var(--danger, #e74c3c)}
        .confirm-modal .modal-title{font-size:16px;font-weight:600;margin:0}
        .confirm-modal .modal-body{padding:16px 20px;line-height:1.5}
        .confirm-modal .modal-actions{padding:16px 20px;border-top:1px solid var(--border-color, #333);display:flex;gap:10px;justify-content:flex-end}
        .btn-danger-ghost{background:transparent;border:1px solid var(--danger, #e74c3c);color:var(--danger, #e74c3c)}
    </style>
    
    </head>
    <body class="page-shell" data-server-running="{{if .server.Running}}true{{else}}false{{end}}" data-server-starting="{{if .server.Starting}}true{{else}}false{{end}}" data-server-paused="{{if .server.Paused}}true{{else}}false{{end}}" data-server-id="{{.server.ID}}" data-world="{{.server.World}}" data-start-location="{{.server.StartLocation}}" data-start-condition="{{.server.StartCondition}}">
        <div id="connection-banner" class="connection-banner" role="status" aria-live="polite">
            <span id="connection-banner-text">Connection lost. Attempting to reconnect...</span>
            <button type="button" id="connection-banner-action" title="Reload the page">Reload</button>
        </div>
        <div class="container">
            <!-- Consistent hero header -->
            <header class="hero-card">
                <div class="hero-main">
                    <img src="/sdsm.png" alt="SDSM logo" class="hero-logo" width="72" height="72">
                    <div class="hero-heading">
                        <h1 class="hero-title">Server Control</h1>
                        <p class="hero-subtitle">Manage and monitor your Stationeers server.</p>
                    </div>
                </div>
                <div class="hero-meta">
                    <div class="hero-meta-title">Controls &amp; Status</div>
                    <p class="hero-meta-text">Use the sections below to start, stop, and configure your server.</p>
                    <span class="pill">Real-time</span>
                </div>
                <div class="hero-actions" style="flex-direction: column; align-items: flex-end;">
                    <div style="display: flex; align-items: center; gap: var(--space-2);">
                    <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme"><span id="theme-icon">üåô</span></button>
                    <a href="/dashboard" class="btn btn-secondary">
                        <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <rect x="3" y="3" width="7" height="7" rx="1"/>
                            <rect x="14" y="3" width="7" height="7" rx="1"/>
                            <rect x="3" y="14" width="7" height="7" rx="1"/>
                            <rect x="14" y="14" width="7" height="7" rx="1"/>
                        </svg>
                        Dashboard
                    </a>
                    <a href="/manager" class="btn btn-secondary">
                        <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <circle cx="12" cy="12" r="3"/>
                            <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 8.62 4.6 1.65 1.65 0 0 0 10.13 3H10a2 2 0 1 1 4 0v.09c0 .66.38 1.26.98 1.54.2.1.41.17.63.2.53.08 1.06-.07 1.46-.47l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.4.4-.55.93-.47 1.46.03.22.1.43.2.63.28.6.88.98 1.54.98H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                        </svg>
                        Manager
                    </a>
                    <a href="/logout" class="btn btn-secondary">
                        <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                            <polyline points="16 17 21 12 16 7"/>
                            <line x1="21" y1="12" x2="9" y2="12"/>
                        </svg>
                        Logout
                    </a>
                    </div>
                    <span style="font-size: 0.7rem; color: var(--text-muted, #888); margin-top: 4px;">{{buildTime}}</span>
                </div>
            </header>

            <!-- Server information moved out of the header into a dedicated card -->
            <div class="server-content">
            {{ if .server.LastError }}
            <div id="server-error-banner" class="alert alert-danger" role="alert" aria-live="polite">
                <div class="alert-icon" aria-hidden="true">
                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12" y2="16"></line>
                    </svg>
                </div>
                <div class="alert-content">
                    <div class="alert-title">Startup error detected</div>
                    <div class="alert-message" id="server-error-text">{{ .server.LastError }}</div>
                    {{ if .server.LastErrorAt }}
                    <div class="alert-meta">Occurred at <span id="server-error-time">{{ .server.LastErrorAt.Format "01/02/2006 15:04:05" }}</span></div>
                    {{ end }}
                </div>
            </div>
            {{ else }}
            <div id="server-error-banner" class="alert alert-danger" role="alert" style="display:none;" aria-live="polite">
                <div class="alert-icon" aria-hidden="true">
                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="8" x2="12" y2="12"></line>
                        <line x1="12" y1="16" x2="12" y2="16"></line>
                    </svg>
                </div>
                <div class="alert-content">
                    <div class="alert-title">Startup error detected</div>
                    <div class="alert-message" id="server-error-text"></div>
                    <div class="alert-meta">Occurred at <span id="server-error-time"></span></div>
                </div>
            </div>
            {{ end }}
            <div class="glass-card">
                <h3 class="server-title" title="{{ if .server.Beta }}Beta channel{{ else }}Release channel{{ end }}">
                    {{ if .server.Beta }}
                    <!-- Beta icon: lab flask (matches dashboard) -->
                    <svg class="icon-inline icon-beta" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" title="Beta">
                        <path d="M10 2v5L4.8 16.4a2.5 2.5 0 0 0 2.2 3.6h10a2.5 2.5 0 0 0 2.2-3.6L13 7V2"/>
                        <path d="M7 14h10"/>
                    </svg>
                    {{ else }}
                    <!-- Release icon: server stack (matches dashboard) -->
                    <svg class="icon-inline icon-release" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" title="Release">
                        <rect x="2" y="2" width="20" height="8" rx="2" ry="2"></rect>
                        <rect x="2" y="14" width="20" height="8" rx="2" ry="2"></rect>
                        <line x1="6" y1="6" x2="6.01" y2="6"></line>
                        <line x1="6" y1="18" x2="6.01" y2="18"></line>
                    </svg>
                    {{ end }}
                    {{.server.Name}}
                </h3>

                <div class="server-info-row">
                    <img 
                        class="world-thumb" 
                        src="/server/{{.server.ID}}/world-image?v={{.server.WorldID}}" 
                        alt="World image for {{.server.World}}" 
                        data-world-image="{{ if .worldInfo }}{{ .worldInfo.Image }}{{ end }}"
                        onerror="this.style.display='none'">

                    <div class="server-info">
                        {{ if .worldInfo }}
                        <p class="card-subtitle">
                            {{.worldInfo.Name}} ‚Äî {{.worldInfo.Description}}
                        </p>
                        {{ end }}
                        <div class="info-inline-row">
                            <span class="info-label">World</span>
                            <span class="info-value world" title="{{.server.World}}">{{.server.World}}</span>
                            <span class="info-sep" aria-hidden="true">‚Ä¢</span>
                            <span class="info-label">Port</span>
                            <span class="info-value port">{{.server.Port}}</span>
                            <span class="info-sep" aria-hidden="true">‚Ä¢</span>
                            <span class="info-label">Max Players</span>
                            <span class="info-value max">{{ .server.MaxClients }}</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Server Control moved here: full-width under Server Info -->
            <div class="card card-control">
                <div class="card-header">
                    <h2 class="card-title">Server Control</h2>
                    <span class="status-pill status-dot">
                        <span id="status-dot-indicator" class="status-dot-indicator {{if .server.Running}}running{{end}}"></span>
                        <span id="status-dot-text">{{if .server.Running}}Running{{else}}Stopped{{end}}</span>
                    </span>
                </div>
                <form method="POST">
                    <div class="control-section">
                        <div class="control-row">
                            <label>Server:</label>
                            <div class="button-group">
                                <button type="submit" name="start" value="true" class="btn btn-control btn-success" id="btn-start" {{if .server.Running}}style="display:none;" disabled aria-disabled="true"{{end}}>
                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <polygon points="5 3 19 12 5 21 5 3"/>
                                    </svg>
                                    Start
                                </button>
                                <button type="submit" name="stop" value="true" class="btn btn-control btn-danger" id="btn-stop" {{if not .server.Running}}style="display:none;" disabled aria-disabled="true"{{end}}>
                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <rect x="6" y="6" width="12" height="12" rx="2"/>
                                    </svg>
                                    Stop
                                </button>
                                <button type="submit" name="restart" value="true" class="btn btn-control btn-secondary" id="btn-restart">
                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                                        <path d="M21 3v5h-5"/>
                                    </svg>
                                    Restart
                                </button>
                                <button type="button" class="btn btn-control" id="btn-pause" {{if not .server.Running}}disabled aria-disabled="true"{{end}}>{{if .server.Paused}}Resume{{else}}Pause{{end}}</button>
                                <button type="button" class="btn btn-control" id="btn-save" {{if not .server.Running}}disabled aria-disabled="true"{{end}}>
                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                        <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                        <polyline points="17 21 17 13 7 13 7 21"/>
                                        <polyline points="7 3 7 8 15 8"/>
                                    </svg>
                                    Save
                                </button>
                                <span class="control-sep" aria-hidden="true">‚Ä¢</span>
                                {{/* Storm control moved inline with server controls */}}
                                {{if .server.Running}}
                                <button type="button" class="btn btn-control btn-storm" id="btn-storm">
                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" title="Storm">
                                        <path d="M19 16.9A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 3 15"/>
                                        <polyline points="13 11 9 17 15 17 11 23"/>
                                    </svg>
                                    Start
                                </button>
                                {{else}}
                                <button type="button" class="btn btn-control btn-storm" id="btn-storm" disabled aria-disabled="true">
                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" title="Storm">
                                        <path d="M19 16.9A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 3 15"/>
                                        <polyline points="13 11 9 17 15 17 11 23"/>
                                    </svg>
                                    Start
                                </button>
                                {{end}}
                            </div>
                        </div>
                        <div class="status-info">
                            <div class="status-row">
                                <span class="status-label">Started:</span>
                                <span id="server-started-value">{{if .server.ServerStarted}}{{.server.ServerStarted.Format "01/02/2006 15:04:05"}}{{else}}Not started{{end}}</span>
                            </div>
                            <div class="status-row">
                                <span class="status-label">Last Saved:</span>
                                <span id="server-saved-value">{{if .server.ServerSaved}}{{.server.ServerSaved.Format "01/02/2006 15:04:05"}}{{else}}Not saved{{end}}</span>
                            </div>
                        </div>
                            <div class="log-preview">
                            <div id="last-log-line" class="log-line">{{if .server.LastLogLine}}{{.server.LastLogLine}}{{else}}No log data{{end}}</div>
                            <button type="button" class="btn btn-secondary btn-min-sm" onclick="openLogPopup({{.server.ID}})">
                                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                                    <polyline points="14 2 14 8 20 8"/>
                                    <line x1="16" y1="13" x2="8" y2="13"/>
                                    <line x1="16" y1="17" x2="8" y2="17"/>
                                </svg>
                                View Log
                            </button>
                        </div>
                        <div class="control-row" style="margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid var(--border-color);">
                            <label></label>
                            <div class="control-actions">
                                <div class="button-group">
                                    <button type="submit" name="update_server" value="true" class="btn btn-primary" {{if or .server.Running .server.Starting}}disabled aria-disabled="true"{{end}}>
                                        <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                            <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
                                            <path d="M21 3v5h-5"/>
                                        </svg>
                                        Update Server
                                    </button>
                                <button type="submit" name="delete" value="true" id="btn-delete" class="btn btn-danger" {{if or .server.Running .server.Starting}}disabled aria-disabled="true"{{end}} onclick="return confirm('Are you sure you want to delete this server? This action cannot be undone.')">
                                        <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                            <polyline points="3 6 5 6 21 6"/>
                                            <path d="M19 6l-1 14a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2L5 6"/>
                                            <path d="M10 11v6"/>
                                            <path d="M14 11v6"/>
                                        </svg>
                                        Delete Server
                                    </button>
                                </div>
                                <div id="server-update-progress" class="update-progress" aria-live="polite">
                                    <div class="update-progress-bar">
                                        <div class="update-progress-fill"></div>
                                    </div>
                                    <div class="update-progress-text">Idle</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>

        <!-- Main grid layout: 2 columns x 2 rows -->
        <div class="main-grid">
            <!-- Top Left: Players List -->
            {{ $live := .server.LiveClients }}
            {{ $liveCount := len $live }}
            {{ $history := .server.Clients }}
            {{ $historyCount := len $history }}
            <div class="card card-players">
                <div class="card-header">
                    <h2 class="card-title">Players Online</h2>
                    <span class="pill" id="players-live-count">{{if gt $liveCount 0}}{{printf "%d online" $liveCount}}{{else}}0 online{{end}}</span>
                </div>
                <div class="tab-set">
                    <button type="button" class="tab-btn active" data-target="players-live">Live</button>
                    <button type="button" class="tab-btn" data-target="players-history">History</button>
                    <button type="button" class="tab-btn" data-target="players-banned">Banned</button>
                </div>
                <div class="players-section">
                    <div class="tab-panel active" id="players-live">
                        <table class="players-table" id="players-live-table" {{if eq $liveCount 0}}style="display:none;"{{end}}>
                            <thead>
                                <tr>
                                    <th>Player Name</th>
                                    <th>Steam ID</th>
                                    <th>Connected At</th>
                                    <th></th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="players-live-body">
                                {{range $live}}
                                <tr>
                                    <td>
                                        <span class="player-name">
                                            {{if .IsAdmin}}
                                            <span class="player-admin-icon" title="Admin" aria-label="Admin">üõ°Ô∏è</span>
                                            {{end}}
                                            {{.Name}}
                                        </span>
                                    </td>
                                    <td>{{.SteamID}}</td>
                                    <td>{{.ConnectDatetime.Format "2006-01-02 15:04:05"}}</td>
                                    <td>
                                        <form method="POST" style="display: inline;">
                                            <button type="submit" name="kick" value="{{.Name}}" class="btn btn-warning btn-icon" aria-label="Kick" title="Kick">
                                                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                    <circle cx="12" cy="12" r="9"></circle>
                                                    <line x1="8" y1="12" x2="16" y2="12"></line>
                                                </svg>
                                            </button>
                                        </form>
                                    </td>
                                    <td>
                                        <form method="POST" style="display: inline;">
                                            <button type="submit" name="ban" value="{{.SteamID}}" class="btn btn-danger btn-icon" aria-label="Ban" title="Ban">
                                                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                    <circle cx="12" cy="12" r="9"></circle>
                                                    <line x1="5" y1="19" x2="19" y2="5"></line>
                                                </svg>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                        <div class="empty-state" id="players-live-empty" {{if gt $liveCount 0}}style="display:none;"{{end}}>No players currently connected</div>
                    </div>
                    <div class="tab-panel" id="players-history">
                        <table class="players-table" id="players-history-table" {{if eq $historyCount 0}}style="display:none;"{{end}}>
                            <thead>
                                <tr>
                                    <th>Player Name</th>
                                    <th>Steam ID</th>
                                    <th>Connected At</th>
                                    <th>Session Length</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="players-history-body">
                                {{range $history}}
                                <tr>
                                    <td>
                                        <span class="player-name">
                                            {{if .IsAdmin}}
                                            <span class="player-admin-icon" title="Admin" aria-label="Admin">üõ°Ô∏è</span>
                                            {{end}}
                                            {{.Name}}
                                        </span>
                                    </td>
                                    <td>{{.SteamID}}</td>
                                    <td>{{.ConnectDatetime.Format "2006-01-02 15:04:05"}}</td>
                                    <td>{{.SessionDurationString}}</td>
                                    <td>
                                        <form method="POST" style="display: inline;">
                                            <button type="submit" name="ban" value="{{.SteamID}}" class="btn btn-danger btn-icon" aria-label="Ban" title="Ban">
                                                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                    <circle cx="12" cy="12" r="9"></circle>
                                                    <line x1="5" y1="19" x2="19" y2="5"></line>
                                                </svg>
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {{end}}
                            </tbody>
                        </table>
                        <div class="empty-state" id="players-history-empty" {{if gt $historyCount 0}}style="display:none;"{{end}}>No player sessions recorded</div>
                    </div>
                    <div class="tab-panel" id="players-banned">
                        {{ $banned := .banned }}
                        <table class="players-table" id="players-banned-table" {{if or (not $banned) (eq (len $banned) 0)}}style="display:none;"{{end}}>
                            <thead>
                                <tr>
                                    <th>Player Name</th>
                                    <th>Steam ID</th>
                                    <th></th>
                                </tr>
                            </thead>
                            <tbody id="players-banned-body">
                                {{if $banned}}
                                    {{range $banned}}
                                    <tr>
                                        <td>
                                            {{if .Name}}{{.Name}}{{else}}‚Äî{{end}}
                                        </td>
                                        <td>{{.SteamID}}</td>
                                        <td>
                                            <form method="POST" style="display: inline;">
                                                <button type="submit" name="unban" value="{{.SteamID}}" class="btn btn-success btn-icon" aria-label="Unban" title="Unban">
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                                        <circle cx="12" cy="12" r="9"></circle>
                                                        <polyline points="9 12 12 15 17 10"></polyline>
                                                    </svg>
                                                </button>
                                            </form>
                                        </td>
                                    </tr>
                                    {{end}}
                                {{end}}
                            </tbody>
                        </table>
                        <div class="empty-state" id="players-banned-empty" {{if and $banned (gt (len $banned) 0)}}style="display:none;"{{end}}>No banned players</div>

                        <form method="POST" id="banned-add-form" class="form-inline" style="margin-top: var(--space-3);">
                            <label for="ban_steam_id" class="sr-only">Steam ID</label>
                            <input type="text" id="ban_steam_id" name="ban_steam_id" placeholder="Enter Steam ID" class="form-input-inline" style="min-width: 240px;" autocomplete="off">
                            <button type="submit" name="add_ban" value="true" class="btn btn-primary btn-min-sm">
                                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                                    <circle cx="12" cy="12" r="9"></circle>
                                    <line x1="12" y1="8" x2="12" y2="16"></line>
                                    <line x1="8" y1="12" x2="16" y2="12"></line>
                                </svg>
                                <span style="margin-left: 6px;">Add</span>
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <!-- Top Right: Chat -->
            <div class="card card-chat">
                <div class="card-header">
                    <h2 class="card-title">Chat</h2>
                    <span class="pill">Live Stream</span>
                </div>
                <div class="chat-section">
                    <div class="chat-messages" id="chat-messages">
                        {{if gt (len .server.Chat) 0}}
                            {{range .server.Chat}}
                            <div class="chat-message">
                                <span class="chat-time">{{.Datetime.Format "15:04"}}</span>
                                <span class="chat-player">{{.Name}}:</span>
                                <span class="chat-text">{{.Message}}</span>
                            </div>
                            {{end}}
                        {{end}}
                    </div>
                    <div class="empty-state" id="chat-empty" {{if gt (len .server.Chat) 0}}style="display:none;"{{end}}>No chat messages</div>
                    <form method="POST" class="chat-input-form" id="chat-send-form">
                        <label for="chat-input" class="sr-only">Chat message</label>
                        <input type="text" name="chat_message" id="chat-input" placeholder="Type message..." class="chat-input" autocomplete="off">
                        <button type="submit" name="send_chat" value="true" class="btn btn-primary btn-min-sm" id="chat-send-button">
                            <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <polygon points="22 2 15 22 11 13 2 9 22 2"/>
                                <line x1="22" y1="2" x2="11" y2="13"/>
                            </svg>
                            Send
                        </button>
                    </form>
                </div>
            </div>

            <!-- Bottom Left: Backups (placeholder where Control used to be) -->
            <div class="card card-backups">
                <div class="card-header">
                    <h2 class="card-title">Backups</h2>
                    <span class="pill">Coming Soon</span>
                </div>
                <div class="empty-state">Backup management will appear here.</div>
            </div>

            <!-- Bottom Right: Startup Parameters -->
            <div class="card card-config">
                <div class="card-header">
                    <h2 class="card-title">Startup Parameters</h2>
                </div>
                <form method="POST" id="startup-params-form">
                    <input type="hidden" name="confirm_reset_saves" id="confirm-reset-saves-flag" value="0" />
                    <div class="form-grid-compact">
                        <div class="form-row form-row-full">
                            <label>Server Path:</label>
                            <span class="readonly-field">{{.serverPath}}</span>
                        </div>
                        <div class="form-row">
                            <label for="name">Name:</label>
                            <input type="text" id="name" name="name" value="{{.server.Name}}" class="form-input-inline" placeholder="Server Name" autocomplete="off">
                        </div>
                        <div class="form-row">
                            <label for="world">World:</label>
                            <select name="world" id="world" class="form-select-inline" aria-label="World">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="start_location">Start Location:</label>
                            <select name="start_location" id="start_location" class="form-select-inline" aria-label="Start Location">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="start_condition">Start Condition:</label>
                            <select name="start_condition" id="start_condition" class="form-select-inline" aria-label="Start Condition">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="difficulty">Difficulty:</label>
                            <select name="difficulty" id="difficulty" class="form-select-inline" aria-label="Difficulty">
                                <option value="">Loading...</option>
                            </select>
                        </div>
                        <div class="form-row">
                            <label for="port">Port:</label>
                            <input type="number" id="port" name="port" value="{{.server.Port}}" class="form-input-inline" placeholder="7777" autocomplete="off">
                        </div>
                        <div class="form-row">
                            <label for="save_interval">Save Interval (sec):</label>
                            <input type="number" id="save_interval" name="save_interval" value="{{.server.SaveInterval}}" class="form-input-inline" placeholder="300" autocomplete="off">
                        </div>
                        <div class="form-row">
                            <label for="restart_delay_seconds">Restart Delay (sec):</label>
                            <input type="number" id="restart_delay_seconds" name="restart_delay_seconds" value="{{.server.RestartDelaySeconds}}" class="form-input-inline" min="0" max="3600" placeholder="0" autocomplete="off">
                        </div>
                        <div class="form-row">
                            <label for="auth_secret">Auth Secret:</label>
                            <input type="text" id="auth_secret" name="auth_secret" value="{{.server.AuthSecret}}" class="form-input-inline" placeholder="Auth Secret" autocomplete="off">
                        </div>
                        <div class="form-row">
                            <label for="password">Server Password:</label>
                            <input type="password" id="password" name="password" value="{{.server.Password}}" class="form-input-inline" placeholder="Password" autocomplete="current-password">
                        </div>
                        <div class="form-row">
                            <label for="max_clients">Max Players:</label>
                            <input type="number" id="max_clients" name="max_clients" value="{{.server.MaxClients}}" class="form-input-inline" placeholder="8" autocomplete="off">
                        </div>
                        <div class="form-row">
                            <label>Release:</label>
                            <div class="radio-group">
                                <label class="radio-label">
                                    <input type="radio" name="beta" value="false" {{if not .server.Beta}}checked{{end}}> Release
                                </label>
                                <label class="radio-label">
                                    <input type="radio" name="beta" value="true" {{if .server.Beta}}checked{{end}}> Beta
                                </label>
                            </div>
                        </div>
                        <div class="form-row">
                            <label for="server_visible">Server Visible:</label>
                            <div class="checkbox-inline">
                                <input type="checkbox" id="server_visible" name="server_visible" {{if .server.Visible}}checked{{end}}>
                                <span>Public</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <label for="auto_update">Auto Update:</label>
                            <div class="checkbox-inline">
                                <input type="checkbox" id="auto_update" name="auto_update" {{if .server.AutoUpdate}}checked{{end}}>
                                <span>Enable</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <label for="auto_save">Auto Save:</label>
                            <div class="checkbox-inline">
                                <input type="checkbox" id="auto_save" name="auto_save" {{if .server.AutoSave}}checked{{end}}>
                                <span>Enable</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <label for="auto_pause">Auto Pause:</label>
                            <div class="checkbox-inline">
                                <input type="checkbox" id="auto_pause" name="auto_pause" {{if .server.AutoPause}}checked{{end}}>
                                <span>Enable</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <label for="auto_start">Auto Start:</label>
                            <div class="checkbox-inline">
                                <input type="checkbox" id="auto_start" name="auto_start" {{if .server.AutoStart}}checked{{end}}>
                                <span>Enable</span>
                            </div>
                        </div>
                    </div>
                    <div class="update-button-container">
                        <button type="button" id="btn-update-params" class="btn btn-primary btn-min-lg" {{if or .server.Running .server.Starting}}disabled aria-disabled="true"{{end}}>
                            <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                                <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
                                <polyline points="17 21 17 13 7 13 7 21"/>
                                <polyline points="7 3 7 8 15 8"/>
                            </svg>
                            Update
                        </button>
                    </div>
                </form>
            </div>

            
        </div>
    </div>
    </div>

    <!-- Confirm Modal for destructive Startup Parameters change -->
    <div id="paramChangeModal" class="confirm-modal" role="dialog" aria-modal="true" aria-labelledby="paramChangeModalTitle" aria-describedby="paramChangeModalDesc">
        <div class="modal-card">
            <div class="modal-header">
                <svg class="icon-inline icon-danger icon modal-icon icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12" y2="16"></line>
                </svg>
                <h3 id="paramChangeModalTitle" class="modal-title">This will reset your saves</h3>
            </div>
            <div id="paramChangeModalDesc" class="modal-body">
                Changing World, Start Location, or Start Condition will cause existing saves for this server to be purged on the next start. This cannot be undone.
                <br><br>
                Do you want to continue?
            </div>
            <div class="modal-actions">
                <button type="button" id="paramChangeCancel" class="btn btn-secondary">Cancel</button>
                <button type="button" id="paramChangeConfirm" class="btn btn-danger btn-danger-ghost">Continue</button>
            </div>
        </div>
    </div>

    <!-- Log Popup -->
    <div id="logPopup" class="log-popup" title="Server Log" aria-label="Server log popup">
        <div class="log-popup-content">
            <div class="log-popup-header">
                <h2 class="log-popup-title">Server Log</h2>
                <button class="btn btn-secondary" onclick="closeLogPopup()">Close</button>
            </div>
            <div id="logPopupBody" class="log-popup-body">
                Loading...
            </div>
        </div>
    </div>

    <script>
        // Global guard to prevent ReferenceError if handlers run before DOMContentLoaded sets locals
        window.__sdsmPendingSubmit = window.__sdsmPendingSubmit || false;
        function openLogPopup(serverId) {
            const popup = document.getElementById('logPopup');
            const body = document.getElementById('logPopupBody');
            popup.classList.add('active');
            body.textContent = 'Loading log...';
            
            // Fetch server log via server route
            fetch(`/server/${serverId}/log`, { credentials: 'same-origin' })
                .then(r => r.text())
                .then(log => {
                    body.textContent = log || 'No log data available';
                    // Auto-scroll to bottom
                    body.scrollTop = body.scrollHeight;
                })
                .catch(err => {
                    body.textContent = 'Error loading log: ' + err.message;
                });
        }

        function closeLogPopup() {
            document.getElementById('logPopup').classList.remove('active');
        }

        // Close popup when clicking outside
        document.getElementById('logPopup').addEventListener('click', function(e) {
            if (e.target === this) {
                closeLogPopup();
            }
        });

        function getStoredTheme() {
            return localStorage.getItem('theme') || 'dark';
        }

        function setTheme(theme) {
            const html = document.documentElement;
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.textContent = theme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || getStoredTheme();
            const next = current === 'dark' ? 'light' : 'dark';
            setTheme(next);
        }

        // Initialize theme
        setTheme(getStoredTheme());
        const rootEl = document.body;
        const statusIndicator = document.getElementById('status-dot-indicator');
        const statusText = document.getElementById('status-dot-text');
        const startedValueEl = document.getElementById('server-started-value');
        const savedValueEl = document.getElementById('server-saved-value');
        const lastLogLineEl = document.getElementById('last-log-line');
        const playersLiveTable = document.getElementById('players-live-table');
        const playersLiveBody = document.getElementById('players-live-body');
        const playersLiveEmpty = document.getElementById('players-live-empty');
        const playersLiveCount = document.getElementById('players-live-count');
        const playersHistoryTable = document.getElementById('players-history-table');
        const playersHistoryBody = document.getElementById('players-history-body');
        const playersHistoryEmpty = document.getElementById('players-history-empty');
        const startButton = document.getElementById('btn-start');
        const stopButton = document.getElementById('btn-stop');
        const restartButton = document.getElementById('btn-restart');
        const pauseButton = document.getElementById('btn-pause');
        const saveButton = document.getElementById('btn-save');
        const stormButton = document.getElementById('btn-storm');
        const deleteButton = document.getElementById('btn-delete');
        const connectionBanner = document.getElementById('connection-banner');
        const connectionBannerText = document.getElementById('connection-banner-text');
        const chatMessagesContainer = document.getElementById('chat-messages');
        const chatEmptyState = document.getElementById('chat-empty');
        const playersBannedTable = document.getElementById('players-banned-table');
        const playersBannedBody = document.getElementById('players-banned-body');
        const playersBannedEmpty = document.getElementById('players-banned-empty');
        const errorBanner = document.getElementById('server-error-banner');
        const errorTextEl = document.getElementById('server-error-text');
        const errorTimeEl = document.getElementById('server-error-time');
        let bannedSteamSet = new Set();
        const worldThumb = document.querySelector('.world-thumb');

        let serverIsRunning = rootEl.dataset.serverRunning === "true";
        let serverIsPaused = rootEl.dataset.serverPaused === "true";
        let serverIsStarting = rootEl.dataset.serverStarting === "true";
        let updateButton = null;
        let progressContainer = null;
        let progressFill = null;
        let progressText = null;
        let progressTimer = null;
        let statusTimer = null;
        let progressActive = false;
        let connectionLost = false;
        let statusFailureCount = 0;
        let reconnectTimer = null;
        let setUpdateButtonDisabled = function() {};
        let stopProgressPolling = function() {};
        let startProgressPolling = function() {};
        let refreshUpdateButtonState = function() {};
        let updateServerStatusUI = function() {};
        let fetchProgress = function() {};
        let fetchStatus = function() {};
        let stopStatusUpdates = function() {};
        let startStatusUpdates = function() {};

        let serverIsStorming = false;

        updateControlButtons({ running: serverIsRunning, paused: serverIsPaused, starting: serverIsStarting });

        function pad2(value) {
            return String(value).padStart(2, '0');
        }

        function formatDateTimeDisplay(value, fallback) {
            if (!value) {
                return fallback;
            }
            const dt = new Date(value);
            if (Number.isNaN(dt.getTime())) {
                return fallback;
            }
            return `${pad2(dt.getMonth() + 1)}/${pad2(dt.getDate())}/${dt.getFullYear()} ${pad2(dt.getHours())}:${pad2(dt.getMinutes())}:${pad2(dt.getSeconds())}`;
        }

        function formatTimeDisplay(value, fallback) {
            if (!value) {
                return fallback;
            }
            const dt = new Date(value);
            if (Number.isNaN(dt.getTime())) {
                return fallback;
            }
            return `${pad2(dt.getHours())}:${pad2(dt.getMinutes())}`;
        }

        function setTextContent(el, text) {
            if (el) {
                el.textContent = text;
            }
        }

        function showElement(el, shouldShow, displayValue) {
            if (!el) {
                return;
            }
            if (shouldShow) {
                if (displayValue) {
                    el.style.display = displayValue;
                } else {
                    el.style.removeProperty('display');
                }
            } else {
                el.style.display = 'none';
            }
        }

        function setButtonDisabled(btn, disabled) {
            if (!btn) {
                return;
            }
            const isDisabled = !!disabled;
            btn.disabled = isDisabled;
            if (isDisabled) {
                btn.setAttribute('aria-disabled', 'true');
            } else {
                btn.removeAttribute('aria-disabled');
            }
        }

            function toggleButtonSpinner(btn, on) {
                if (!btn) return;
                btn.setAttribute('aria-busy', on ? 'true' : 'false');
                let sp = btn.querySelector('.btn-spinner');
                if (on) {
                    if (!sp) {
                        sp = document.createElement('span');
                        sp.className = 'btn-spinner';
                        sp.setAttribute('aria-hidden', 'true');
                        btn.appendChild(sp);
                    }
                } else if (sp) {
                    sp.remove();
                }
            }

        function updateLiveCount(count) {
            if (!playersLiveCount) {
                return;
            }
            const value = Number(count) || 0;
            playersLiveCount.textContent = value === 1 ? '1 online' : `${value} online`;
        }

        function createTextCell(text) {
            const td = document.createElement('td');
            td.textContent = text;
            return td;
        }

        function createPlayerNameCell(player, opts) {
            const td = document.createElement('td');
            const wrapper = document.createElement('span');
            wrapper.className = 'player-name';

            if (player && player.is_admin) {
                const badge = document.createElement('span');
                badge.className = 'player-admin-icon';
                badge.title = 'Admin';
                badge.setAttribute('aria-label', 'Admin');
                badge.textContent = 'üõ°Ô∏è';
                wrapper.appendChild(badge);
            }

            // Optional banned indicator when requested (used on History tab)
            if (opts && opts.banned) {
                const bannedIcon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                bannedIcon.setAttribute('class', 'icon-inline player-banned-icon');
                bannedIcon.setAttribute('width', '14');
                bannedIcon.setAttribute('height', '14');
                bannedIcon.setAttribute('viewBox', '0 0 24 24');
                bannedIcon.setAttribute('fill', 'none');
                bannedIcon.setAttribute('stroke', 'currentColor');
                bannedIcon.setAttribute('stroke-width', '2');
                bannedIcon.setAttribute('aria-hidden', 'true');
                const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                circle.setAttribute('cx', '12');
                circle.setAttribute('cy', '12');
                circle.setAttribute('r', '9');
                const slash = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                slash.setAttribute('x1', '5');
                slash.setAttribute('y1', '19');
                slash.setAttribute('x2', '19');
                slash.setAttribute('y2', '5');
                bannedIcon.appendChild(circle);
                bannedIcon.appendChild(slash);
                bannedIcon.setAttribute('title', 'Banned');
                wrapper.appendChild(bannedIcon);
            }

            const nameSpan = document.createElement('span');
            nameSpan.textContent = player && player.name ? player.name : 'Unknown';
            wrapper.appendChild(nameSpan);

            td.appendChild(wrapper);
            return td;
        }

        function createActionCell(playerName, action) {
            const td = document.createElement('td');
            const form = document.createElement('form');
            form.method = 'POST';
            form.style.display = 'inline';

            const button = document.createElement('button');
            button.type = 'submit';
            button.name = action;
            button.value = playerName || '';
            // Assign color by action: ban=red, unban=green, kick=amber
            if (action === 'ban') {
                button.className = 'btn btn-danger btn-icon';
            } else if (action === 'unban') {
                button.className = 'btn btn-success btn-icon';
            } else if (action === 'kick') {
                button.className = 'btn btn-warning btn-icon';
            } else {
                button.className = 'btn btn-secondary btn-icon';
            }
            button.setAttribute('aria-label', action.charAt(0).toUpperCase() + action.slice(1));
            button.title = action.charAt(0).toUpperCase() + action.slice(1);
            if (action === 'ban') {
                button.innerHTML = '<svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"></circle><line x1="5" y1="19" x2="19" y2="5"></line></svg>';
            } else if (action === 'unban') {
                button.innerHTML = '<svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"></circle><polyline points="9 12 12 15 17 10"></polyline></svg>';
            } else if (action === 'kick') {
                button.innerHTML = '<svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"></circle><line x1="8" y1="12" x2="16" y2="12"></line></svg>';
            } else {
                button.textContent = action.charAt(0).toUpperCase() + action.slice(1);
            }

            form.appendChild(button);
            td.appendChild(form);
            return td;
        }

        function renderLivePlayers(players) {
            if (!playersLiveBody) {
                return;
            }
            playersLiveBody.textContent = '';

            if (!Array.isArray(players) || players.length === 0) {
                showElement(playersLiveTable, false);
                showElement(playersLiveEmpty, true);
                updateLiveCount(0);
                return;
            }

            showElement(playersLiveTable, true, 'table');
            showElement(playersLiveEmpty, false);

            players.forEach(player => {
                const row = document.createElement('tr');
                row.appendChild(createPlayerNameCell(player));
                row.appendChild(createTextCell(player.steam_id || ''));
                row.appendChild(createTextCell(formatDateTimeDisplay(player.connected_at, '‚Äî')));
                row.appendChild(createActionCell(player.name || '', 'kick'));
                row.appendChild(createActionCell(player.steam_id || '', 'ban'));
                playersLiveBody.appendChild(row);
            });

            updateLiveCount(players.length);
        }

        function renderHistoryPlayers(history) {
            if (!playersHistoryBody) {
                return;
            }
            playersHistoryBody.textContent = '';

            if (!Array.isArray(history) || history.length === 0) {
                showElement(playersHistoryTable, false);
                showElement(playersHistoryEmpty, true);
                return;
            }

            showElement(playersHistoryTable, true, 'table');
            showElement(playersHistoryEmpty, false);

            history.forEach(entry => {
                const row = document.createElement('tr');
                const isBanned = !!(entry && entry.steam_id && bannedSteamSet && bannedSteamSet.has(entry.steam_id));
                if (isBanned) {
                    row.classList.add('row-banned');
                }
                row.appendChild(createPlayerNameCell(entry, { banned: isBanned }));
                row.appendChild(createTextCell(entry.steam_id || ''));
                row.appendChild(createTextCell(formatDateTimeDisplay(entry.connected_at, '‚Äî')));
                row.appendChild(createTextCell(entry.session_length || '‚Äî'));
                row.appendChild(createActionCell(entry.steam_id || '', isBanned ? 'unban' : 'ban'));
                playersHistoryBody.appendChild(row);
            });
        }

        function renderChatMessages(messages) {
            if (!chatMessagesContainer || !chatEmptyState) {
                return;
            }

            chatMessagesContainer.textContent = '';

            if (!Array.isArray(messages) || messages.length === 0) {
                chatEmptyState.style.removeProperty('display');
                return;
            }

            chatEmptyState.style.display = 'none';

            messages.forEach((entry) => {
                if (!entry) {
                    return;
                }
                const row = document.createElement('div');
                row.className = 'chat-message';

                const timeSpan = document.createElement('span');
                timeSpan.className = 'chat-time';
                timeSpan.textContent = formatTimeDisplay(entry.time, '--:--');

                const playerSpan = document.createElement('span');
                playerSpan.className = 'chat-player';
                playerSpan.textContent = `${entry.player || 'Unknown'}:`;

                const messageSpan = document.createElement('span');
                messageSpan.className = 'chat-text';
                messageSpan.textContent = entry.message || '';

                row.appendChild(timeSpan);
                row.appendChild(playerSpan);
                row.appendChild(messageSpan);

                chatMessagesContainer.appendChild(row);
            });

            chatMessagesContainer.scrollTop = chatMessagesContainer.scrollHeight;
        }

        function renderBanned(list) {
            if (!playersBannedBody) {
                return;
            }
            playersBannedBody.textContent = '';

            if (!Array.isArray(list) || list.length === 0) {
                showElement(playersBannedTable, false);
                showElement(playersBannedEmpty, true);
                return;
            }

            showElement(playersBannedTable, true, 'table');
            showElement(playersBannedEmpty, false);

            list.forEach(entry => {
                const row = document.createElement('tr');
                const nameTd = document.createElement('td');
                nameTd.textContent = (entry && entry.name) ? entry.name : '‚Äî';
                const idTd = document.createElement('td');
                idTd.textContent = entry && entry.steam_id ? entry.steam_id : '';
                const actionTd = document.createElement('td');
                const form = document.createElement('form');
                form.method = 'POST';
                form.style.display = 'inline';
                const btn = document.createElement('button');
                btn.type = 'submit';
                btn.name = 'unban';
                btn.value = (entry && entry.steam_id) ? entry.steam_id : '';
                btn.className = 'btn btn-success btn-icon';
                btn.setAttribute('aria-label', 'Unban');
                btn.title = 'Unban';
                btn.innerHTML = '<svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="12" cy="12" r="9"></circle><polyline points="9 12 12 15 17 10"></polyline></svg>';
                form.appendChild(btn);
                actionTd.appendChild(form);
                row.appendChild(nameTd);
                row.appendChild(idTd);
                row.appendChild(actionTd);
                playersBannedBody.appendChild(row);
            });
        }

        function setConnectionBanner(active, message) {
            if (!connectionBanner) {
                return;
            }
            if (active) {
                connectionBanner.classList.add('active');
                if (connectionBannerText && message) {
                    connectionBannerText.textContent = message;
                }
                document.body.style.paddingTop = '3rem';
            } else {
                connectionBanner.classList.remove('active');
                document.body.style.paddingTop = '';
            }
        }

        // Reload button
        (function(){
            const reloadBtn = document.getElementById('connection-banner-action');
            if (reloadBtn) {
                reloadBtn.addEventListener('click', () => window.location.reload());
            }
        })();

        function clearReconnectTimer() {
            if (reconnectTimer) {
                clearInterval(reconnectTimer);
                reconnectTimer = null;
            }
        }

        function handleConnectionLost() {
            if (connectionLost) {
                return;
            }
            connectionLost = true;
            setConnectionBanner(true, 'Connection lost. Attempting to reconnect...');
            stopStatusUpdates();
            stopProgressPolling();
            setUpdateButtonDisabled(true);
            updateControlButtons();
            if (!reconnectTimer) {
                reconnectTimer = setInterval(attemptReconnect, 5000);
            }
            attemptReconnect();
        }

        function handleConnectionRestored() {
            if (!connectionLost) {
                return;
            }
            connectionLost = false;
            clearReconnectTimer();
            setConnectionBanner(false);
            refreshUpdateButtonState();
            updateControlButtons();
            startStatusUpdates();
            if (progressActive) {
                startProgressPolling();
            }
        }

        function attemptReconnect() {
            const serverId = rootEl.dataset.serverId;
            if (!serverId) {
                return;
            }
            fetch(`/server/${serverId}/status.json`, {
                credentials: 'same-origin',
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Server unavailable');
                    }
                    return response.json();
                })
                .then(data => {
                    statusFailureCount = 0;
                    handleConnectionRestored();
                    updateServerStatusUI(data);
                    fetchProgress();
                })
                .catch(() => {
                    // Keep retrying until server responds again
                });
        }

        function updateControlButtons(status) {
            const statusObj = status || {};
            const running = typeof statusObj.running === 'boolean' ? statusObj.running : serverIsRunning;
            const paused = typeof statusObj.paused === 'boolean' ? statusObj.paused : serverIsPaused;
            const starting = typeof statusObj.starting === 'boolean' ? statusObj.starting : serverIsStarting;

            if (connectionLost) {
                setButtonDisabled(startButton, true);
                setButtonDisabled(stopButton, true);
                setButtonDisabled(restartButton, true);
                setButtonDisabled(pauseButton, true);
                setButtonDisabled(saveButton, true);
                setButtonDisabled(deleteButton, true);
                serverIsRunning = running;
                serverIsPaused = paused;
                serverIsStarting = starting;
                return;
            }

            if (startButton) {
                showElement(startButton, !running);
                setButtonDisabled(startButton, running || progressActive);
            }

            if (stopButton) {
                showElement(stopButton, running);
                setButtonDisabled(stopButton, !running || progressActive);
            }

            if (restartButton) {
                setButtonDisabled(restartButton, progressActive || starting);
            }

            if (pauseButton) {
                pauseButton.textContent = paused ? 'Resume' : 'Pause';
                setButtonDisabled(pauseButton, !running || progressActive || starting);
            }

            if (saveButton) {
                setButtonDisabled(saveButton, !running || progressActive || starting);
            }

            if (stormButton) {
                setButtonDisabled(stormButton, !running || progressActive || starting);
            }

            if (deleteButton) {
                setButtonDisabled(deleteButton, running || starting);
            }

            serverIsRunning = running;
            serverIsPaused = paused;
            serverIsStarting = starting;
        }

        let worldLists = {"release": [], "beta": []};
        let worldDataByVersion = {"release": {}, "beta": {}};

        {{ if and .worldLists .worldData }}
        {{ $worldLists := .worldLists }}
        {{ $worldData := .worldData }}
        worldLists = {
            "release": [
                {{ $release := index $worldLists "release" }}
                {{ range $idx, $world := $release }}
                {{ if $idx}}, {{ end }}
                "{{js $world}}"
                {{ end }}
            ],
            "beta": [
                {{ $beta := index $worldLists "beta" }}
                {{ range $idx, $world := $beta }}
                {{ if $idx}}, {{ end }}
                "{{js $world}}"
                {{ end }}
            ]
        };

        worldDataByVersion = {
            "release": {
                {{ $releaseData := index $worldData "release" }}
                {{ $releaseList := index $worldLists "release" }}
                {{ range $idx, $world := $releaseList }}
                {{ if $idx}}, {{ end }}
                "{{js $world}}": {
                    "locations": [
                        {{ with index $releaseData $world }}
                        {{ range $locIdx, $loc := index . "locations" }}
                        {{ if $locIdx}}, {{ end }}
                        {"ID": "{{js $loc.ID}}", "Name": "{{js $loc.Name}}", "Description": "{{js $loc.Description}}"}
                        {{ end }}
                        {{ end }}
                    ],
                    "conditions": [
                        {{ with index $releaseData $world }}
                        {{ range $condIdx, $cond := index . "conditions" }}
                        {{ if $condIdx}}, {{ end }}
                        {"ID": "{{js $cond.ID}}", "Name": "{{js $cond.Name}}", "Description": "{{js $cond.Description}}"}
                        {{ end }}
                        {{ end }}
                    ]
                }
                {{ end }}
            },
            "beta": {
                {{ $betaData := index $worldData "beta" }}
                {{ $betaList := index $worldLists "beta" }}
                {{ range $idx, $world := $betaList }}
                {{ if $idx}}, {{ end }}
                "{{js $world}}": {
                    "locations": [
                        {{ with index $betaData $world }}
                        {{ range $locIdx, $loc := index . "locations" }}
                        {{ if $locIdx}}, {{ end }}
                        {"ID": "{{js $loc.ID}}", "Name": "{{js $loc.Name}}", "Description": "{{js $loc.Description}}"}
                        {{ end }}
                        {{ end }}
                    ],
                    "conditions": [
                        {{ with index $betaData $world }}
                        {{ range $condIdx, $cond := index . "conditions" }}
                        {{ if $condIdx}}, {{ end }}
                        {"ID": "{{js $cond.ID}}", "Name": "{{js $cond.Name}}", "Description": "{{js $cond.Description}}"}
                        {{ end }}
                        {{ end }}
                    ]
                }
                {{ end }}
            }
        };
        {{ end }}

        // Difficulties per version from server payload
        const releaseDifficulties = [
            {{- range $idx, $d := .release_difficulties -}}
            {{- if $idx}}, {{- end -}}
            "{{ js $d }}"
            {{- end -}}
        ];
        const betaDifficulties = [
            {{- range $idx, $d := .beta_difficulties -}}
            {{- if $idx}}, {{- end -}}
            "{{ js $d }}"
            {{- end -}}
        ];

        const initialVersionKey = {{if .server.Beta}}"beta"{{else}}"release"{{end}};
        const initialWorld = {{if .server.World}}"{{js .server.World}}"{{else}}""{{end}};
        const initialStartLocation = {{if .server.StartLocation}}"{{js .server.StartLocation}}"{{else}}""{{end}};
        const initialStartCondition = {{if .server.StartCondition}}"{{js .server.StartCondition}}"{{else}}""{{end}};
        const initialDifficulty = {{if .server.Difficulty}}"{{js .server.Difficulty}}"{{else}}""{{end}};

        const versionState = {
            release: {
                world: initialVersionKey === 'release' ? initialWorld : '',
                startLocation: initialVersionKey === 'release' ? initialStartLocation : '',
                startCondition: initialVersionKey === 'release' ? initialStartCondition : ''
            },
            beta: {
                world: initialVersionKey === 'beta' ? initialWorld : '',
                startLocation: initialVersionKey === 'beta' ? initialStartLocation : '',
                startCondition: initialVersionKey === 'beta' ? initialStartCondition : ''
            }
        };

        function currentVersionKey() {
            const checked = document.querySelector('input[name="beta"]:checked');
            return checked && checked.value === "true" ? "beta" : "release";
        }

        function selectOptionWithFallback(select, value, fallbackLabel = ' (configured)') {
            if (!select) {
                return;
            }
            if (!value) {
                select.value = '';
                return;
            }
            const existing = Array.from(select.options).find(opt => opt.value === value);
            if (existing) {
                existing.selected = true;
                select.value = value;
                return;
            }
            const option = document.createElement('option');
            option.value = value;
            option.textContent = fallbackLabel ? value + fallbackLabel : value;
            option.dataset.fallback = 'true';
            select.appendChild(option);
            select.value = value;
        }

        function populateWorldOptions() {
            const worldSelect = document.getElementById('world');
            const versionKey = currentVersionKey();
            const worlds = worldLists[versionKey] || [];
            const state = versionState[versionKey];

            worldSelect.innerHTML = '';

            if (!worlds.length) {
                worldSelect.innerHTML = '<option value="">No worlds available</option>';
                selectOptionWithFallback(worldSelect, state.world, ' (configured)');
                updateWorldOptions();
                updateWorldThumb();
                return;
            }

            if (!state.world) {
                state.world = worlds[0];
                state.startLocation = '';
                state.startCondition = '';
            }

            worlds.forEach(world => {
                const option = document.createElement('option');
                option.value = world;
                option.textContent = world;
                worldSelect.appendChild(option);
            });

            selectOptionWithFallback(worldSelect, state.world, ' (configured)');
            state.world = worldSelect.value;

            updateWorldOptions();
            updateWorldThumb();
        }

        function updateWorldOptions() {
            const worldSelect = document.getElementById('world');
            const locSelect = document.getElementById('start_location');
            const condSelect = document.getElementById('start_condition');
            const versionKey = currentVersionKey();
            const world = worldSelect.value;
            const worldData = (worldDataByVersion[versionKey] || {})[world];
            const state = versionState[versionKey];

            locSelect.innerHTML = '<option value="">-- Select Start Location --</option>';
            condSelect.innerHTML = '<option value="">-- Select Start Condition --</option>';

            if (worldData) {
                (worldData.locations || []).forEach(loc => {
                const option = document.createElement('option');
                option.value = loc.ID;
                option.textContent = loc.Name || loc.ID;
                if (loc.Description) {
                    option.title = loc.Description;
                }
                locSelect.appendChild(option);
            });

                (worldData.conditions || []).forEach(cond => {
                const option = document.createElement('option');
                option.value = cond.ID;
                option.textContent = cond.Name || cond.ID;
                if (cond.Description) {
                    option.title = cond.Description;
                }
                condSelect.appendChild(option);
            });
            }
            selectOptionWithFallback(locSelect, state.startLocation);
            selectOptionWithFallback(condSelect, state.startCondition);
        }

        function updateWorldThumb() {
            try {
                if (!worldThumb) return;
                const worldSelect = document.getElementById('world');
                const world = worldSelect ? (worldSelect.value || '').trim() : '';
                const serverId = Number(rootEl.dataset.serverId || '0');
                if (!serverId || !world) {
                    worldThumb.style.display = 'none';
                    return;
                }
                // Reset display in case a previous error hid the image
                worldThumb.style.removeProperty('display');
                const betaFlag = currentVersionKey() === 'beta';
                const v = encodeURIComponent((betaFlag ? 'beta' : 'release') + '-' + world);
                const url = `/server/${serverId}/world-image?world=${encodeURIComponent(world)}&beta=${betaFlag}&v=${v}`;
                // Force reload if src is same string
                if (worldThumb.src !== window.location.origin + url) {
                    worldThumb.src = url;
                } else {
                    // Append a tiny nonce to bust cache if the same URL is set
                    worldThumb.src = url + `&t=${Date.now()}`;
                }
            } catch (_) { /* no-op */ }
        }

        function populateDifficultyOptions() {
            const diffSelect = document.getElementById('difficulty');
            const versionKey = currentVersionKey();
            const diffs = versionKey === 'beta' ? betaDifficulties : releaseDifficulties;
            const previous = diffSelect ? diffSelect.value : '';
            if (!diffSelect) return;
            diffSelect.innerHTML = '';
            if (!diffs || !diffs.length) {
                const opt = document.createElement('option');
                opt.value = '';
                opt.textContent = 'No difficulties';
                diffSelect.appendChild(opt);
                return;
            }
            diffs.forEach((d) => {
                const opt = document.createElement('option');
                opt.value = d;
                opt.textContent = d;
                diffSelect.appendChild(opt);
            });
            const desired = diffs.includes(initialDifficulty) ? initialDifficulty : (diffs.includes(previous) ? previous : diffs[0]);
            diffSelect.value = desired;
        }

        document.addEventListener('DOMContentLoaded', () => {
            const worldSelect = document.getElementById('world');
            const locSelect = document.getElementById('start_location');
            const condSelect = document.getElementById('start_condition');
            const difficultySelect = document.getElementById('difficulty');
            const versionRadios = document.querySelectorAll('input[name="beta"]');
            const paramsForm = document.getElementById('startup-params-form');
            const updateParamsBtn = document.getElementById('btn-update-params');
            const modal = document.getElementById('paramChangeModal');
            const modalConfirm = document.getElementById('paramChangeConfirm');
            const modalCancel = document.getElementById('paramChangeCancel');
            const confirmFlag = document.getElementById('confirm-reset-saves-flag');

            populateWorldOptions();
            populateDifficultyOptions();
            updateWorldThumb();

            const tabButtons = document.querySelectorAll('.tab-set .tab-btn');
            const tabContents = document.querySelectorAll('.tab-panel');
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    tabButtons.forEach(b => b.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));
                    button.classList.add('active');
                    const targetId = button.getAttribute('data-target');
                    const target = targetId ? document.getElementById(targetId) : null;
                    if (target) {
                        target.classList.add('active');
                    }
                });
            });

            if (worldSelect) {
                worldSelect.addEventListener('change', () => {
                    const versionKey = currentVersionKey();
                    const state = versionState[versionKey];
                    state.world = worldSelect.value;
                    state.startLocation = '';
                    state.startCondition = '';
                    updateWorldOptions();
                    updateWorldThumb();
                });
            }

            versionRadios.forEach(radio => {
                radio.addEventListener('change', () => {
                    populateWorldOptions();
                    populateDifficultyOptions();
                    updateWorldThumb();
                });
            });

            if (difficultySelect) {
                difficultySelect.addEventListener('change', () => {
                    // Keep initialDifficulty aligned only for UX fallback decisions
                    // Not used as destructive param, so no modal involvement
                });
            }

            if (locSelect) {
                locSelect.addEventListener('change', () => {
                    const state = versionState[currentVersionKey()];
                    state.startLocation = locSelect.value;
                });
            }

            if (condSelect) {
                condSelect.addEventListener('change', () => {
                    const state = versionState[currentVersionKey()];
                    state.startCondition = condSelect.value;
                });
            }

            const serverId = Number(rootEl.dataset.serverId || '0');
            updateButton = document.querySelector('button[name="update_server"]');
            progressContainer = document.getElementById('server-update-progress');
            progressFill = progressContainer ? progressContainer.querySelector('.update-progress-fill') : null;
            progressText = progressContainer ? progressContainer.querySelector('.update-progress-text') : null;

            setUpdateButtonDisabled = function(disabled) {
                if (!updateButton) {
                    return;
                }
                updateButton.disabled = !!disabled;
                if (disabled) {
                    updateButton.setAttribute('aria-disabled', 'true');
                } else {
                    updateButton.removeAttribute('aria-disabled');
                }
            };

            function clampPercent(value) {
                if (Number.isNaN(value)) {
                    return 0;
                }
                return Math.max(0, Math.min(100, value));
            }

            stopProgressPolling = function() {
                if (progressTimer) {
                    clearInterval(progressTimer);
                    progressTimer = null;
                }
            };

            startProgressPolling = function() {
                if (!serverId || progressTimer || connectionLost) {
                    return;
                }
                progressTimer = setInterval(fetchProgress, 2000);
            };

            refreshUpdateButtonState = function() {
                if (!updateButton) {
                    return;
                }
                if (connectionLost || serverIsRunning || serverIsStarting || progressActive) {
                    setUpdateButtonDisabled(true);
                } else {
                    setUpdateButtonDisabled(false);
                }
            };

            function updateProgressUI(data) {
                if (!progressContainer) {
                    return;
                }
                const stage = (data && data.stage ? data.stage : '').trim();
                const percentRaw = data && typeof data.percent === 'number' ? data.percent : parseInt(data && data.percent, 10) || 0;
                const percent = clampPercent(percentRaw);
                const running = !!(data && data.running);
                const hasError = !!(data && data.error);
                const isIdleStage = !running && !hasError && percent === 0 && (stage === '' || stage === 'Idle');

                progressActive = running;

                progressContainer.classList.toggle('active', !isIdleStage);
                progressContainer.classList.toggle('error', hasError);

                if (progressFill) {
                    progressFill.style.width = (isIdleStage ? 0 : percent) + '%';
                }

                if (progressText) {
                    let text = stage;
                    if (hasError) {
                        text = 'Error: ' + data.error;
                    } else if (running) {
                        text = text || 'Copying files';
                        text += percent > 0 ? ' (' + percent + '%)' : '...';
                    } else if (percent >= 100 && !hasError) {
                        text = text || 'Completed';
                    } else if (isIdleStage) {
                        text = 'Idle';
                    }
                    progressText.textContent = text.trim();
                }

                if (running) {
                    startProgressPolling();
                } else {
                    stopProgressPolling();
                }

                updateControlButtons();
                refreshUpdateButtonState();
            }

            fetchProgress = function() {
                if (!serverId) {
                    return;
                }
                fetch(`/server/${serverId}/progress`, {
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                    .then(res => (res.ok ? res.json() : null))
                    .then(data => {
                        if (data) {
                            updateProgressUI(data);
                        }
                    })
                    .catch(() => {
                        // Ignore polling errors
                    });
            };

            function handleUpdateClick(event) {
                event.preventDefault();
                if (!updateButton || updateButton.disabled || serverIsRunning || serverIsStarting) {
                    return;
                }

                progressActive = true;
                updateControlButtons();
                refreshUpdateButtonState();

                if (progressContainer) {
                    progressContainer.classList.add('active');
                    progressContainer.classList.remove('error');
                }
                if (progressFill) {
                    progressFill.style.width = '0%';
                }
                if (progressText) {
                    progressText.textContent = 'Starting update...';
                }

                fetch(window.location.pathname, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    body: 'update_server=1',
                    credentials: 'same-origin'
                })
                    .then(res => {
                        try {
                            if (typeof window.showToast === 'function') {
                                const type = res.headers.get('X-Toast-Type');
                                const title = res.headers.get('X-Toast-Title');
                                const message = res.headers.get('X-Toast-Message');
                                if (message) window.showToast({ type: type || 'info', title: title || '', message });
                            }
                        } catch (_) {}
                        if (!res.ok) {
                            return res.json().then(data => Promise.reject(data));
                        }
                        return res.json();
                    })
                    .then(() => {
                        fetchProgress();
                        startProgressPolling();
                    })
                    .catch(err => {
                        const message = err && err.error ? err.error : 'Unable to start update.';
                        updateProgressUI({ stage: 'Error', percent: 0, running: false, error: message });
                        progressActive = false;
                        updateControlButtons();
                        refreshUpdateButtonState();
                    });
            }

            if (updateButton) {
                updateButton.addEventListener('click', handleUpdateClick);
            }

            updateServerStatusUI = function(data) {
                if (!data) {
                    return;
                }

                const running = !!data.running;
                const starting = !!data.starting;
                serverIsRunning = running;
                serverIsStarting = starting;
                rootEl.dataset.serverRunning = running ? 'true' : 'false';
                rootEl.dataset.serverStarting = starting ? 'true' : 'false';
                serverIsPaused = !!data.paused && running;
                rootEl.dataset.serverPaused = serverIsPaused ? 'true' : 'false';

                if (statusIndicator) {
                    statusIndicator.classList.toggle('starting', running && starting);
                    statusIndicator.classList.toggle('running', running && !serverIsPaused && !starting);
                    statusIndicator.classList.toggle('paused', serverIsPaused && !starting);
                }
                if (statusText) {
                    if (starting && running) {
                        statusText.textContent = 'Starting';
                    } else if (!running) {
                        statusText.textContent = 'Stopped';
                    } else if (serverIsPaused) {
                        statusText.textContent = 'Paused';
                    } else {
                        statusText.textContent = 'Running';
                    }
                }

                const lastLine = data.last_log_line && data.last_log_line.trim() ? data.last_log_line : 'No log data';
                setTextContent(lastLogLineEl, lastLine);

                setTextContent(startedValueEl, formatDateTimeDisplay(data.server_started, 'Not started'));
                setTextContent(savedValueEl, formatDateTimeDisplay(data.server_saved, 'Not saved'));

                // Error banner (last_error)
                const hasError = !!(data.last_error && String(data.last_error).trim());
                if (errorBanner) {
                    showElement(errorBanner, hasError);
                }
                if (hasError) {
                    if (errorTextEl) setTextContent(errorTextEl, data.last_error);
                    if (errorTimeEl) setTextContent(errorTimeEl, formatDateTimeDisplay(data.last_error_at, '‚Äî'));
                } else {
                    if (errorTextEl) setTextContent(errorTextEl, '');
                    if (errorTimeEl) setTextContent(errorTimeEl, '');
                }

                // Update storm button label/state first
                try {
                    serverIsStorming = !!data.storming;
                    if (stormButton) {
                        const label = serverIsStorming ? 'Stop' : 'Start';
                        // Preserve icon markup while updating label
                        stormButton.innerHTML = '<svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true" title="Storm"><path d="M19 16.9A5 5 0 0 0 18 7h-1.26A8 8 0 1 0 3 15"/><polyline points="13 11 9 17 15 17 11 23"/></svg>' + label;
                    }
                } catch (_) {}

                if (Array.isArray(data.players)) {
                    renderLivePlayers(data.players);
                } else {
                    renderLivePlayers([]);
                }

                // Keep banned set updated before rendering History rows so we can annotate
                if (Array.isArray(data.banned)) {
                    try {
                        bannedSteamSet = new Set((data.banned || []).map(b => b && b.steam_id).filter(Boolean));
                    } catch (_) { bannedSteamSet = new Set(); }
                } else {
                    bannedSteamSet = new Set();
                }

                if (Array.isArray(data.clients)) {
                    renderHistoryPlayers(data.clients);
                } else {
                    renderHistoryPlayers([]);
                }

                if (Array.isArray(data.chat_messages)) {
                    renderChatMessages(data.chat_messages);
                } else {
                    renderChatMessages([]);
                }

                if (Array.isArray(data.banned)) {
                    renderBanned(data.banned);
                } else {
                    renderBanned([]);
                }

                updateControlButtons(data);
                refreshUpdateButtonState();
            };

            fetchStatus = function() {
                if (!serverId) {
                    return;
                }
                fetch(`/server/${serverId}/status.json`, {
                    headers: {
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin'
                })
                    .then(res => {
                        if (res.status === 401) {
                            stopStatusUpdates();
                            return null;
                        }
                        if (!res.ok) {
                            throw new Error('Failed to fetch server status');
                        }
                        return res.json();
                    })
                    .then(data => {
                        statusFailureCount = 0;
                        if (data) {
                            handleConnectionRestored();
                            updateServerStatusUI(data);
                        }
                    })
                    .catch(() => {
                        statusFailureCount += 1;
                        if (statusFailureCount >= 2) {
                            handleConnectionLost();
                        }
                    });
            };

            stopStatusUpdates = function() {
                if (statusTimer) {
                    clearInterval(statusTimer);
                    statusTimer = null;
                }
            };

            startStatusUpdates = function() {
                if (!serverId || statusTimer || connectionLost) {
                    return;
                }
                statusTimer = setInterval(fetchStatus, 4000);
            };

            document.addEventListener('visibilitychange', () => {
                if (document.hidden) {
                    stopStatusUpdates();
                    stopProgressPolling();
                } else {
                    fetchStatus();
                    fetchProgress();
                    startStatusUpdates();
                    if (progressActive) {
                        startProgressPolling();
                    }
                }
            });

            refreshUpdateButtonState();
            fetchProgress();
            fetchStatus();
            startStatusUpdates();

            function coreParamsChanged(){
                const currWorld = (document.getElementById('world') && document.getElementById('world').value) || '';
                const currLoc = (document.getElementById('start_location') && document.getElementById('start_location').value) || '';
                const currCond = (document.getElementById('start_condition') && document.getElementById('start_condition').value) || '';
                const initWorldRef = (rootEl && rootEl.dataset && rootEl.dataset.world) ? rootEl.dataset.world : (typeof initialWorld !== 'undefined' ? initialWorld : '');
                const initLocRef = (rootEl && rootEl.dataset && rootEl.dataset.startLocation) ? rootEl.dataset.startLocation : (typeof initialStartLocation !== 'undefined' ? initialStartLocation : '');
                const initCondRef = (rootEl && rootEl.dataset && rootEl.dataset.startCondition) ? rootEl.dataset.startCondition : (typeof initialStartCondition !== 'undefined' ? initialStartCondition : '');
                return (currWorld !== initWorldRef) || (currLoc !== initLocRef) || (currCond !== initCondRef);
            }

            function showParamChangeModal(onConfirm, onCancel){
                if (modal) {
                    modal.classList.add('active');
                    const cleanup = () => {
                        if (modalConfirm) modalConfirm.removeEventListener('click', confirmHandler);
                        if (modalCancel) modalCancel.removeEventListener('click', cancelHandler);
                        modal.removeEventListener('click', backdropHandler);
                    };
                    const confirmHandler = () => { cleanup(); if (typeof onConfirm === 'function') onConfirm(); };
                    const cancelHandler = () => { cleanup(); if (typeof onCancel === 'function') onCancel(); };
                    const backdropHandler = (ev) => { if (ev.target === modal) cancelHandler(); };
                    if (modalConfirm) modalConfirm.addEventListener('click', confirmHandler, { once: true });
                    if (modalCancel) modalCancel.addEventListener('click', cancelHandler, { once: true });
                    modal.addEventListener('click', backdropHandler);
                    return true;
                }
                return false;
            }

            // Intercept Startup Parameters Update submit with blocking confirm when core params changed
            if (paramsForm && updateParamsBtn) {
                paramsForm.addEventListener('submit', function(e){
                    if (window.__sdsmPendingSubmit) return; // allow the second submit after confirm
                    const changed = coreParamsChanged();
                    if (!changed) {
                        return; // allow submit
                    }
                    e.preventDefault();
                    const proceed = () => {
                        // Ensure server gets the expected 'update=true' field
                        let hiddenUpdate = paramsForm.querySelector('input[type="hidden"][name="update"]');
                        if (!hiddenUpdate) {
                            hiddenUpdate = document.createElement('input');
                            hiddenUpdate.type = 'hidden';
                            hiddenUpdate.name = 'update';
                            hiddenUpdate.value = 'true';
                            paramsForm.appendChild(hiddenUpdate);
                        } else {
                            hiddenUpdate.value = 'true';
                        }
                        try { if (confirmFlag) confirmFlag.value = '1'; } catch(_) {}
                        window.__sdsmPendingSubmit = true;
                        paramsForm.submit();
                    };
                    const canceled = () => {};
                    const shown = showParamChangeModal(proceed, () => { try { modal.classList.remove('active'); } catch(_) {} });
                    if (!shown) {
                        // Native fallback confirm if custom modal not available
                        if (window.confirm('Changing World, Start Location, or Start Condition will reset (purge) existing saves on next start. Continue?')) {
                            proceed();
                        }
                    }
                });

                // Also intercept direct button clicks (some browsers may bypass submit listener in edge cases)
                updateParamsBtn.addEventListener('click', function(e){
                    if (window.__sdsmPendingSubmit) return;
                    const changed = coreParamsChanged();
                    if (!changed) {
                        // No confirmation needed; submit the form with update=true
                        let hiddenUpdate = paramsForm.querySelector('input[type="hidden"][name="update"]');
                        if (!hiddenUpdate) {
                            hiddenUpdate = document.createElement('input');
                            hiddenUpdate.type = 'hidden';
                            hiddenUpdate.name = 'update';
                            hiddenUpdate.value = 'true';
                            paramsForm.appendChild(hiddenUpdate);
                        } else {
                            hiddenUpdate.value = 'true';
                        }
                        paramsForm.submit();
                        return;
                    }
                    e.preventDefault();
                    const proceed = () => {
                        let hiddenUpdate = paramsForm.querySelector('input[type="hidden"][name="update"]');
                        if (!hiddenUpdate) {
                            hiddenUpdate = document.createElement('input');
                            hiddenUpdate.type = 'hidden';
                            hiddenUpdate.name = 'update';
                            hiddenUpdate.value = 'true';
                            paramsForm.appendChild(hiddenUpdate);
                        } else {
                            hiddenUpdate.value = 'true';
                        }
                        try { if (confirmFlag) confirmFlag.value = '1'; } catch(_) {}
                        window.__sdsmPendingSubmit = true;
                        paramsForm.submit();
                    };
                    const shown = showParamChangeModal(proceed, () => { try { modal.classList.remove('active'); } catch(_) {} });
                    if (!shown) {
                        if (window.confirm('Changing World, Start Location, or Start Condition will reset (purge) existing saves on next start. Continue?')) {
                            proceed();
                        }
                    }
                });
            }

            // Intercept Chat send form to POST a command to the API
            (function(){
                const chatForm = document.getElementById('chat-send-form');
                const chatInput = document.getElementById('chat-input');
                const chatBtn = document.getElementById('chat-send-button');
                if (!chatForm || !chatInput || !chatBtn || !serverId) return;
                chatForm.addEventListener('submit', function(e){
                    e.preventDefault();
                    const message = (chatInput.value || '').trim();
                    if (!message || chatBtn.disabled) return;
                    setButtonDisabled(chatBtn, true);
                    toggleButtonSpinner(chatBtn, true);
                    fetch(`/api/servers/${serverId}/command`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({ type: 'chat', payload: message })
                    })
                    .then((res) => {
                        try {
                            if (typeof window.showToast === 'function') {
                                const type = res.headers.get('X-Toast-Type');
                                const title = res.headers.get('X-Toast-Title');
                                const msg = res.headers.get('X-Toast-Message');
                                if (msg) window.showToast({ type: type || 'info', title: title || '', message: msg });
                            }
                        } catch(_) {}
                        if (res.ok) {
                            chatInput.value = '';
                        }
                        // Status polling already updates chat view from logs
                    })
                    .catch(() => { /* no-op */ })
                    .finally(() => { toggleButtonSpinner(chatBtn, false); setButtonDisabled(chatBtn, false); });
                });
            })();

            // Intercept Banned Add form submit for async update
            (function(){
                const addForm = document.getElementById('banned-add-form');
                const input = document.getElementById('ban_steam_id');
                const addBtn = addForm ? addForm.querySelector('button[type="submit"]') : null;
                if (addForm && input) {
                    addForm.addEventListener('submit', function(e) {
                        e.preventDefault();
                        const id = (input.value || '').trim();
                        if (!id) return;
                        if (addBtn && addBtn.disabled) return;
                        // Disable input and button while request is in flight
                        if (addBtn) {
                            setButtonDisabled(addBtn, true);
                            toggleButtonSpinner(addBtn, true);
                        }
                        input.disabled = true;
                        fetch(window.location.pathname, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-Requested-With': 'XMLHttpRequest',
                                'Accept': 'application/json'
                            },
                            body: 'add_ban=1&ban_steam_id=' + encodeURIComponent(id),
                            credentials: 'same-origin'
                        }).then((res) => {
                            try {
                                if (typeof window.showToast === 'function') {
                                    const type = res.headers.get('X-Toast-Type');
                                    const title = res.headers.get('X-Toast-Title');
                                    const message = res.headers.get('X-Toast-Message');
                                    if (message) window.showToast({ type: type || 'info', title: title || '', message });
                                }
                            } catch (_) {}
                            input.value = '';
                            fetchStatus();
                        }).catch(() => {
                            // No-op; status poll will reconcile
                        }).finally(() => {
                            if (addBtn) {
                                toggleButtonSpinner(addBtn, false);
                                setButtonDisabled(addBtn, false);
                            }
                            input.disabled = false;
                        });
                    });
                }
            })();

            // Intercept Unban button clicks in banned table
            (function(){
                if (!playersBannedBody) return;
                playersBannedBody.addEventListener('click', function(e){
                    const btn = e.target.closest && e.target.closest('button[name="unban"]');
                    if (!btn) return;
                    e.preventDefault();
                    const id = (btn.value || '').trim();
                    if (!id) return;
                    if (btn.disabled) return;
                    setButtonDisabled(btn, true);
                    toggleButtonSpinner(btn, true);
                    fetch(window.location.pathname, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        body: 'unban=' + encodeURIComponent(id),
                        credentials: 'same-origin'
                    }).then((res) => {
                        try {
                            if (typeof window.showToast === 'function') {
                                const type = res.headers.get('X-Toast-Type');
                                const title = res.headers.get('X-Toast-Title');
                                const message = res.headers.get('X-Toast-Message');
                                if (message) window.showToast({ type: type || 'info', title: title || '', message });
                            }
                        } catch (_) {}
                        fetchStatus();
                    }).catch(() => {
                        // No-op
                    }).finally(() => {
                        toggleButtonSpinner(btn, false);
                        setButtonDisabled(btn, false);
                    });
                });
            })();

            // Intercept Start/Stop/Restart to use async fetch with toast + disable buttons during request
            (function(){
                function postAction(param, btn) {
                    if (!param) return;
                    if (btn && btn.disabled) return;
                    if (btn) { setButtonDisabled(btn, true); toggleButtonSpinner(btn, true); }
                    fetch(window.location.pathname, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        body: encodeURIComponent(param) + '=1',
                        credentials: 'same-origin'
                    })
                    .then((res) => {
                        try {
                            if (typeof window.showToast === 'function') {
                                const type = res.headers.get('X-Toast-Type');
                                const title = res.headers.get('X-Toast-Title');
                                const message = res.headers.get('X-Toast-Message');
                                if (message) window.showToast({ type: type || 'info', title: title || '', message });
                            }
                        } catch (_) {}
                        // status refresh to reflect new state
                        fetchStatus();
                        return res.ok ? res.json().catch(() => ({})) : Promise.resolve({});
                    })
                    .catch(() => { /* ignore, status poll will reconcile */ })
                    .finally(() => {
                        if (btn) { toggleButtonSpinner(btn, false); setButtonDisabled(btn, false); }
                    });
                }

                if (startButton) {
                    startButton.addEventListener('click', function(e){ e.preventDefault(); postAction('start', startButton); });
                }
                if (stopButton) {
                    stopButton.addEventListener('click', function(e){ e.preventDefault(); postAction('stop', stopButton); });
                }
                if (restartButton) {
                    restartButton.addEventListener('click', function(e){ e.preventDefault(); postAction('restart', restartButton); });
                }
            })();

            // Save button: sends FILE save console command via API
            (function(){
                if (!saveButton || !serverId) return;
                saveButton.addEventListener('click', function(e){
                    e.preventDefault();
                    if (saveButton.disabled) return;
                    setButtonDisabled(saveButton, true);
                    toggleButtonSpinner(saveButton, true);
                    fetch(`/api/servers/${serverId}/command`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({ type: 'console', payload: 'FILE save' })
                    })
                    .then((res) => {
                        try {
                            if (typeof window.showToast === 'function') {
                                const type = res.headers.get('X-Toast-Type');
                                const title = res.headers.get('X-Toast-Title');
                                const message = res.headers.get('X-Toast-Message');
                                if (message) window.showToast({ type: type || 'info', title: title || '', message });
                            }
                        } catch(_) {}
                        fetchStatus();
                    })
                    .catch(() => { /* no-op */ })
                    .finally(() => { toggleButtonSpinner(saveButton, false); setButtonDisabled(saveButton, false); });
                });
            })();

            // Pause/Resume button: sends PAUSE true/false console command via API
            (function(){
                if (!pauseButton || !serverId) return;
                pauseButton.addEventListener('click', function(e){
                    e.preventDefault();
                    if (pauseButton.disabled) return;
                    const isPaused = serverIsPaused;
                    const command = isPaused ? 'PAUSE false' : 'PAUSE true';
                    setButtonDisabled(pauseButton, true);
                    toggleButtonSpinner(pauseButton, true);
                    fetch(`/api/servers/${serverId}/command`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({ type: 'console', payload: command })
                    })
                    .then((res) => {
                        try {
                            if (typeof window.showToast === 'function') {
                                const type = res.headers.get('X-Toast-Type');
                                const title = res.headers.get('X-Toast-Title');
                                const message = res.headers.get('X-Toast-Message');
                                if (message) window.showToast({ type: type || 'info', title: title || '', message });
                            }
                        } catch(_) {}
                        fetchStatus();
                    })
                    .catch(() => { /* no-op */ })
                    .finally(() => { toggleButtonSpinner(pauseButton, false); setButtonDisabled(pauseButton, false); });
                });
            })();

            // Storm Start/Stop button: sends STORM start/stop via API and updates label
            (function(){
                if (!stormButton || !serverId) return;
                stormButton.addEventListener('click', function(e){
                    e.preventDefault();
                    if (stormButton.disabled) return;
                    const cmd = serverIsStorming ? 'STORM stop' : 'STORM start';
                    setButtonDisabled(stormButton, true);
                    toggleButtonSpinner(stormButton, true);
                    fetch(`/api/servers/${serverId}/command`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: JSON.stringify({ type: 'console', payload: cmd })
                    }).then((res) => {
                        try {
                            if (typeof window.showToast === 'function') {
                                const type = res.headers.get('X-Toast-Type');
                                const title = res.headers.get('X-Toast-Title');
                                const message = res.headers.get('X-Toast-Message');
                                if (message) window.showToast({ type: type || 'info', title: title || '', message });
                            }
                        } catch(_) {}
                        fetchStatus();
                    }).catch(() => {
                        // no-op; polling will reconcile
                    }).finally(() => {
                        toggleButtonSpinner(stormButton, false);
                        setButtonDisabled(stormButton, false);
                    });
                });
            })();

            // Make Live/History Kick/Ban async as well (with toasts and button disable)
            (function(){
                // Local safe wrappers in case shared helpers aren't present
                function setBtnDisabled(btn, disabled) {
                    try { if (typeof setButtonDisabled === 'function') return setButtonDisabled(btn, disabled); } catch(_) {}
                    btn.disabled = !!disabled;
                }
                function toggleBtnSpinner(btn, on) {
                    try { if (typeof toggleButtonSpinner === 'function') return toggleButtonSpinner(btn, on); } catch(_) {}
                    // Minimal fallback: swap content with a simple spinner dot
                    if (!btn) return;
                    if (on) {
                        if (!btn.dataset.originalHtml) btn.dataset.originalHtml = btn.innerHTML;
                        btn.innerHTML = '<span class="btn-spinner" aria-hidden="true"></span>';
                    } else {
                        if (btn.dataset.originalHtml) { btn.innerHTML = btn.dataset.originalHtml; delete btn.dataset.originalHtml; }
                    }
                }
                function showToastFromResponse(res) {
                    try {
                        if (typeof window.showToast === 'function') {
                            const type = res.headers.get('X-Toast-Type');
                            const title = res.headers.get('X-Toast-Title');
                            const message = res.headers.get('X-Toast-Message');
                            if (message) window.showToast({ type: type || 'info', title: title || '', message });
                        }
                    } catch (_) {}
                }

                function postPlayerAction(action, value, btn) {
                    if (!action || !value) return;
                    if (btn && btn.disabled) return;
                    if (btn) { setBtnDisabled(btn, true); toggleBtnSpinner(btn, true); }
                    
                    // For kick action, send console command via API
                    if (action === 'kick') {
                        if (!serverId) {
                            if (btn) { toggleBtnSpinner(btn, false); setBtnDisabled(btn, false); }
                            return;
                        }
                        fetch(`/api/servers/${serverId}/command`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Accept': 'application/json'
                            },
                            credentials: 'same-origin',
                            body: JSON.stringify({ type: 'console', payload: 'KICK ' + value })
                        })
                        .then((res) => { showToastFromResponse(res); fetchStatus(); return res.ok ? res.json().catch(() => ({})) : Promise.resolve({}); })
                        .catch(() => { /* ignore; polling will reconcile */ })
                        .finally(() => { if (btn) { toggleBtnSpinner(btn, false); setBtnDisabled(btn, false); } });
                        return;
                    }
                    
                    // For ban/unban, use existing form POST
                    const body = encodeURIComponent(action) + '=' + encodeURIComponent(value);
                    fetch(window.location.pathname, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        body,
                        credentials: 'same-origin'
                    })
                    .then((res) => { showToastFromResponse(res); fetchStatus(); return res.ok ? res.json().catch(() => ({})) : Promise.resolve({}); })
                    .catch(() => { /* ignore; polling will reconcile */ })
                    .finally(() => { if (btn) { toggleBtnSpinner(btn, false); setBtnDisabled(btn, false); } });
                }

                function delegateAction(container) {
                    if (!container) return;
                    container.addEventListener('click', function(e){
                        const banBtn = e.target.closest && e.target.closest('button[name="ban"]');
                        const unbanBtn = !banBtn && e.target.closest && e.target.closest('button[name="unban"]');
                        const kickBtn = !banBtn && !unbanBtn && e.target.closest && e.target.closest('button[name="kick"]');
                        const btn = banBtn || unbanBtn || kickBtn;
                        if (!btn) return;
                        e.preventDefault();
                        const action = banBtn ? 'ban' : (unbanBtn ? 'unban' : 'kick');
                        const value = (btn.value || '').trim();
                        if (!value) return;
                        postPlayerAction(action, value, btn);
                    });
                }

                const liveBody = document.getElementById('players-live-body');
                const historyBody = document.getElementById('players-history-body');
                delegateAction(liveBody);
                delegateAction(historyBody);
            })();
        });
    </script>
    {{ template "toast.html" . }}
</body>
</html>