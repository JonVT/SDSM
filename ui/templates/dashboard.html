{{define "title"}}Dashboard{{end}}
{{define "page"}}dashboard{{end}}

{{define "dashboard.html"}}
<!-- Dashboard Content - loaded into frame.html via HTMX -->
<section class="stats-grid">
    <div class="stat-card">
        <div class="stat-value" id="total-servers">{{ len .servers }}</div>
        <div class="stat-label">Total Servers</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="active-servers">
            {{ $active := 0 }}
            {{ range .servers }}
                {{ if .IsRunning }}{{ $active = add $active 1 }}{{ end }}
            {{ end }}
            {{ $active }}
        </div>
        <div class="stat-label">Active Servers</div>
    </div>
    <div class="stat-card">
        <div class="stat-value" id="total-players">
            {{ $players := 0 }}
            {{ range .servers }}
                {{ $players = add $players .ClientCount }}
            {{ end }}
            {{ $players }}
        </div>
        <div class="stat-label">Connected Players</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">100%</div>
        <div class="stat-label">System Health</div>
    </div>
</section>

<section id="server-grid" class="grid-split">
    {{ template "server_cards.html" . }}
</section>

{{ if .servers }}
<button class="floating-action" onclick="createNewServer()" aria-label="Add new server">+</button>
{{ end }}

<script>
    // Dashboard-specific initialization
    function createNewServer(){ window.location.href='/server/new'; }

    document.addEventListener('DOMContentLoaded', ()=>{
        if (window.SDSM) {
            SDSM.ws.connect();
            SDSM.health.start();
            SDSM.ui.bindServerCardNavigation();
            SDSM.ui.startStatsPoll();
        }

        // Auto-refresh every 30 seconds
        setInterval(()=>{
            if (typeof htmx !== 'undefined') {
                htmx.trigger('#server-grid','refresh');
                htmx.trigger('.stats-grid','refresh');
            }
        }, 30000);
    });

    document.addEventListener('htmx:afterSwap', e=>{
        if(e.target && e.target.closest('#server-grid')){
            if (window.SDSM && SDSM.ui) {
                SDSM.ui.bindServerCardNavigation(e.target.closest('#server-grid'));
            }
        }
    });
</script>
{{end}}
