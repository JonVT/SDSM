{{define "title"}}Dashboard{{end}}
{{define "page"}}dashboard{{end}}

{{define "dashboard.html"}}
<div data-page-title="Dashboard" data-dashboard-root>
    <div class="dashboard-stack">
    {{ $totalServers := len .servers }}
    {{ $activeServers := 0 }}
    {{ $connectedPlayers := 0 }}
    {{ $startableServers := 0 }}
    {{ range .servers }}
        {{ if .IsRunning }}{{ $activeServers = add $activeServers 1 }}{{ end }}
        {{ if or (not .IsRunning) .Stopping }}{{ $startableServers = add $startableServers 1 }}{{ end }}
        {{ $connectedPlayers = add $connectedPlayers .ClientCount }}
    {{ end }}

    {{ $healthScore := "Offline" }}
    {{ $healthPill := "Offline" }}
    {{ if .active }}{{ $healthScore = "100%" }}{{ $healthPill = "Healthy" }}{{ end }}
    {{ $statsCtx := dict "totalServers" $totalServers "activeServers" $activeServers "totalPlayers" $connectedPlayers "startableServers" $startableServers }}
    {{ $healthCtx := dict "score" $healthScore "pill" $healthPill }}
    <div class="stats-grid stats-grid-compact">
        {{ template "stats.html" $statsCtx }}
    </div>

    <div class="system-overview-grid {{ if eq .role "admin" }}has-sidebar{{ else }}single-column{{ end }}">
        <div class="system-overview-left">
            {{ template "system_health.html" $healthCtx }}
        </div>
        {{ if eq .role "admin" }}
        <div class="system-overview-right">
            {{ template "manager_card.html" . }}
            {{ template "users_card.html" . }}
        </div>
        {{ end }}
    </div>

    {{ $serverCtx := dict "role" .role "startable" $startableServers "active" $activeServers "context" (dict "servers" .servers "role" .role) }}
    {{ template "server_deck.html" $serverCtx }}

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.SDSM) {
                SDSM.health.start();
                SDSM.ui.bindServerCardNavigation();
                SDSM.ui.startStatsPoll();
            }
            // Auto-refresh every 30 seconds
            setInterval(() => {
                if (typeof htmx !== 'undefined') {
                    htmx.trigger('#server-grid', 'refresh');
                    htmx.trigger('.stats-grid', 'refresh');
                }
            }, 30000);
        });
        document.addEventListener('htmx:afterSwap', e => {
            if (e.target && e.target.closest('#server-grid')) {
                if (window.SDSM && SDSM.ui) {
                    SDSM.ui.bindServerCardNavigation(e.target.closest('#server-grid'));
                }
            }
        });
    </script>
</div>
{{end}}
