{{define "title"}}Dashboard{{end}}
{{define "page"}}dashboard{{end}}

{{define "dashboard.html"}}
<div data-page-title="Dashboard">
    <div class="dashboard-stack">
    {{ $totalServers := len .servers }}
    {{ $activeServers := 0 }}
    {{ $connectedPlayers := 0 }}
    {{ range .servers }}
        {{ if .IsRunning }}{{ $activeServers = add $activeServers 1 }}{{ end }}
        {{ $connectedPlayers = add $connectedPlayers .ClientCount }}
    {{ end }}

    <div class="stats-grid stats-grid-compact">
        <div class="stat-card">
            <div class="stat-value" id="total-servers">{{ $totalServers }}</div>
            <div class="stat-label">Total Servers</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="active-servers">{{ $activeServers }}</div>
            <div class="stat-label">Active Servers</div>
        </div>
        <div class="stat-card">
            <div class="stat-value" id="total-players">{{ $connectedPlayers }}</div>
            <div class="stat-label">Connected Players</div>
        </div>
        <div class="stat-card">
            <div class="stat-value">{{ if .active }}100%{{ else }}Offline{{ end }}</div>
            <div class="stat-label">System Health</div>
        </div>
    </div>

    {{ if eq .role "admin" }}
    <div class="admin-overview-grid grid gap-4 md:grid-cols-2">
        {{ with .managerInfo }}
        <div class="card manager-card">
            <div class="card-header">
                <h2 class="card-title">Manager</h2>
                {{ if .updating }}
                    <span class="status-pill is-info">
                        <span class="dot" aria-hidden="true"></span>
                        <span>Updating…</span>
                    </span>
                {{ else }}
                    {{ $total := .components_total }}
                    {{ $healthy := .components_uptodate }}
                    {{ if le $total 0 }}
                        <span class="status-pill is-warning">
                            <span class="dot" aria-hidden="true"></span>
                            <span>Status Unknown</span>
                        </span>
                    {{ else if eq $healthy 0 }}
                        <span class="status-pill is-critical">
                            <span class="dot" aria-hidden="true"></span>
                            <span>No software up to date</span>
                            <span class="status-meta">{{$healthy}}/{{$total}} healthy</span>
                        </span>
                    {{ else if lt $healthy $total }}
                        <span class="status-pill is-warning">
                            <span class="dot" aria-hidden="true"></span>
                            <span>Updates required</span>
                            <span class="status-meta">{{$healthy}}/{{$total}} healthy</span>
                        </span>
                    {{ else }}
                        <span class="status-pill is-healthy">
                            <span class="dot" aria-hidden="true"></span>
                            <span>All software up to date</span>
                            <span class="status-meta">{{$healthy}}/{{$total}} healthy</span>
                        </span>
                    {{ end }}
                {{ end }}
            </div>
            <div class="card-body">
                <div class="manager-info-fields text-sm">
                    <div class="manager-info-field">
                        <div class="text-tertiary text-xs uppercase tracking-wide">Web UI Port</div>
                        <div class="text-lg font-semibold">{{ .port }}</div>
                    </div>
                    <div class="manager-info-field path-field">
                        <div class="text-tertiary text-xs uppercase tracking-wide">Root Path</div>
                        <div class="font-mono break-words">{{ if .root_path }}{{ .root_path }}{{ else }}Not configured{{ end }}</div>
                    </div>
                </div>
                <div class="row gap-3 mt-4 flex-wrap">
                    <button type="button"
                            class="btn btn-danger"
                            hx-post="/update"
                            hx-vals='{"shutdown":"1"}'
                            hx-target="this"
                            hx-swap="none"
                            hx-confirm="Stop SDSM and shut down all services?"
                            hx-disabled-elt="this">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.364 5.636A9 9 0 1 1 5.636 18.364 9 9 0 0 1 18.364 5.636z"/><path d="M12 2v10"/></svg>
                        <span>Stop SDSM</span>
                    </button>
                    <button type="button"
                            class="btn btn-secondary"
                            hx-post="/update"
                            hx-vals='{"restart":"1"}'
                            hx-target="this"
                            hx-swap="none"
                            hx-confirm="Restart SDSM now?"
                            hx-disabled-elt="this">
                        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"/><polyline points="1 20 1 14 7 14"/><path d="M3.51 9a9 9 0 0 1 14.13-3.36L23 10"/><path d="M1 14l5.37 5.37A9 9 0 0 0 20.49 15"/></svg>
                        <span>Restart</span>
                    </button>
                </div>
            </div>
        </div>
        {{ end }}

        {{ with .userStats }}
        <div class="card users-card">
            <div class="card-header">
                <h2 class="card-title">Users</h2>
                <a href="/users" class="btn btn-info" hx-get="/users" hx-push-url="/users">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><path d="M20 8v6"/><path d="M23 11h-6"/></svg>
                    <span>Manage Users</span>
                </a>
            </div>
            <div class="card-body">
                <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                    <div>
                        <div class="text-tertiary text-xs uppercase tracking-wide">Total</div>
                        <div class="text-2xl font-semibold">{{ .total }}</div>
                    </div>
                    <div>
                        <div class="text-tertiary text-xs uppercase tracking-wide">Admins</div>
                        <div class="text-xl font-semibold">{{ .admins }}</div>
                    </div>
                    <div>
                        <div class="text-tertiary text-xs uppercase tracking-wide">Operators</div>
                        <div class="text-xl font-semibold">{{ .operators }}</div>
                    </div>
                </div>
                {{ if eq .total 0 }}
                <p class="text-tertiary text-sm mt-4">No users have been created yet.</p>
                {{ end }}
            </div>
        </div>
        {{ end }}
    </div>
    {{ end }}

    <div class="card server-deck-card">
        <div class="card-header">
            <h2 class="card-title">Servers</h2>
            <div class="row gap-3">
                <div id="refresh-indicator" class="text-tertiary text-sm hidden" role="status" aria-live="polite">
                    Refreshing…
                </div>
                {{ if eq .role "admin" }}
                <button type="button"
                        class="btn btn-danger"
                        hx-post="/api/servers/stop-all"
                        hx-target="this"
                        hx-swap="none"
                        hx-disabled-elt="this"
                        hx-confirm="Stop all running servers now?"
                        title="Stop all running servers"
                        {{ if eq $activeServers 0 }}disabled aria-disabled="true"{{ end }}>
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="6" y="6" width="12" height="12" rx="2" ry="2"></rect></svg>
                    <span>Stop All Servers</span>
                </button>
                <a href="/server/new" class="btn btn-primary" hx-get="/server/new" hx-push-url="/server/new">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    <span>New Server</span>
                </a>
                {{ end }}
            </div>
        </div>
        <div class="card-body">
            <div id="server-grid"
                 class="grid gap-4 md:grid-cols-2 xl:grid-cols-3"
                 hx-get="/api/servers"
                 hx-trigger="load, refresh from:body"
                 hx-target="#server-grid"
                 hx-swap="innerHTML"
                 hx-indicator="#refresh-indicator">
                {{ template "server_cards.html" . }}
            </div>
            {{ if not .servers }}
            <div class="text-center p-6">
                <p class="text-tertiary">No servers have been configured.</p>
                {{ if eq .role "admin" }}
                <a href="/server/new" class="btn btn-primary mt-4" hx-get="/server/new" hx-push-url="/server/new">Create Your First Server</a>
                {{ end }}
            </div>
            {{ end }}
        </div>
    </div>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (window.SDSM) {
                SDSM.health.start();
                SDSM.ui.bindServerCardNavigation();
                SDSM.ui.startStatsPoll();
            }
            // Auto-refresh every 30 seconds
            setInterval(() => {
                if (typeof htmx !== 'undefined') {
                    htmx.trigger('#server-grid', 'refresh');
                    htmx.trigger('.stats-grid', 'refresh');
                }
            }, 30000);
        });
        document.addEventListener('htmx:afterSwap', e => {
            if (e.target && e.target.closest('#server-grid')) {
                if (window.SDSM && SDSM.ui) {
                    SDSM.ui.bindServerCardNavigation(e.target.closest('#server-grid'));
                }
            }
        });
    </script>
</div>
{{end}}
