<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stationeers Server Dashboard - Monitor and manage your servers">
    <title>Dashboard - Stationeers Server Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/ui-theme.css">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="page-shell">
    <div id="connection-banner" class="connection-banner" role="status" aria-live="polite">
        <span id="connection-banner-text">Connection lost. Attempting to reconnect...</span>
        <button type="button" id="connection-banner-action">Reload</button>
    </div>

    <div class="container">
        <header class="hero-card">
            <div class="hero-main">
                <img src="/sdsm.png" alt="SDSM logo" class="hero-logo" width="72" height="72">
                <div class="hero-heading">
                    <h1 class="hero-title">Server Dashboard</h1>
                    <p class="hero-subtitle">Monitor and manage your Stationeers servers in real time.</p>
                </div>
            </div>
            <div class="hero-meta">
                <div class="hero-meta-title">Fleet Overview</div>
                <p class="hero-meta-text">
                    <span id="header-total-servers">--</span> server<span id="header-total-servers-suffix">s</span> tracked â€¢
                    <span id="header-active-servers">--</span> active â€¢
                    <span id="header-total-players">--</span> players
                </p>
                <span class="pill">Last refresh: <span id="last-refresh">just now</span></span>
            </div>
            <div class="hero-actions">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <span id="theme-icon">ðŸŒ™</span>
                </button>
                <button
                    class="btn btn-primary"
                    hx-get="/api/refresh"
                    hx-trigger="click"
                    hx-indicator="#refresh-indicator"
                    hx-swap="none"
                >
                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <polyline points="23 4 23 10 17 10"></polyline>
                        <polyline points="1 20 1 14 7 14"></polyline>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                        <path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    <span id="refresh-indicator" class="hidden">âŸ³</span>
                    Refresh
                </button>
                <a href="/manager" class="btn btn-secondary">
                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 8.62 4.6 1.65 1.65 0 0 0 10.13 3H10a2 2 0 1 1 4 0v.09c0 .66.38 1.26.98 1.54.2.1.41.17.63.2.53.08 1.06-.07 1.46-.47l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06c-.4.4-.55.93-.47 1.46.03.22.1.43.2.63.28.6.88.98 1.54.98H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                    Manager
                </a>
                <a href="/logout" class="btn btn-secondary">
                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/>
                        <polyline points="16 17 21 12 16 7"/>
                        <line x1="21" y1="12" x2="9" y2="12"/>
                    </svg>
                    Logout
                </a>
            </div>
        </header>
    </div>

    <main class="container dashboard-content">
           <section class="stats-grid"
               hx-get="/api/stats"
               hx-trigger="load, every 30s, refresh"
               hx-headers='{"Accept":"text/html"}'
               hx-swap="innerHTML">
            <span class="htmx-indicator pill" aria-hidden="true">Refreshingâ€¦</span>
            <div class="stat-card">
                <div class="stat-value" id="total-servers">{{ len .servers }}</div>
                <div class="stat-label">Total Servers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="active-servers">
                    {{ $active := 0 }}
                    {{ range .servers }}
                        {{ if .IsRunning }}{{ $active = add $active 1 }}{{ end }}
                    {{ end }}
                    {{ $active }}
                </div>
                <div class="stat-label">Active Servers</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="total-players">
                    {{ $players := 0 }}
                    {{ range .servers }}
                        {{ $players = add $players .ClientCount }}
                    {{ end }}
                    {{ $players }}
                </div>
                <div class="stat-label">Connected Players</div>
            </div>
            <div class="stat-card">
                <div class="stat-value">100%</div>
                <div class="stat-label">System Health</div>
            </div>
        </section>

        <section id="server-grid"
                 class="grid-split"
                 hx-get="/api/servers"
                 hx-trigger="load, every 10s, refresh"
                 hx-headers='{"Accept":"text/html"}'
                 hx-swap="innerHTML">
            <span class="htmx-indicator pill" aria-hidden="true">Refreshingâ€¦</span>
            {{ template "server_cards.html" . }}
        </section>
    </main>

    {{ if .servers }}
    <button class="floating-action" onclick="createNewServer()" aria-label="Add new server">+</button>
    {{ end }}

    <script>
        let ws;

        function getStoredTheme() {
            return localStorage.getItem('theme') || 'dark';
        }

        function setTheme(theme) {
            const html = document.documentElement;
            html.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const icon = document.getElementById('theme-icon');
            if (icon) {
                icon.textContent = theme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
            }
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme') || getStoredTheme();
            const next = current === 'dark' ? 'light' : 'dark';
            setTheme(next);
        }

        setTheme(getStoredTheme());

        function bindServerCardNavigation(root) {
            const cards = (root || document).querySelectorAll('.server-card');
            cards.forEach(card => {
                if (card.dataset.navigationBound === 'true') {
                    return;
                }
                card.dataset.navigationBound = 'true';
                card.addEventListener('click', event => {
                    if (event.target.closest('[data-stop-navigation="true"]')) {
                        return;
                    }
                    const url = card.getAttribute('data-target-url');
                    if (url) {
                        window.location.href = url;
                    }
                });
            });
        }

        bindServerCardNavigation();

        document.addEventListener('htmx:afterSwap', event => {
            if (event.target && event.target.closest('#server-grid')) {
                bindServerCardNavigation(event.target.closest('#server-grid'));
            }
        });

        const HEALTH_ENDPOINT = '/healthz';
        const HEALTH_TIMEOUT = 4000;
        const HEALTH_INTERVAL_OK = 15000;
        const HEALTH_INTERVAL_LOST = 5000;
        let healthTimer = null;
        let healthLost = false;

        function connectWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
            const wsUrl = `${protocol}//${window.location.host}/ws`;
            ws = new WebSocket(wsUrl);

            ws.onopen = () => console.log('WebSocket connected');
            ws.onmessage = event => handleRealtimeUpdate(JSON.parse(event.data));
            ws.onclose = () => setTimeout(connectWebSocket, 3000);
            ws.onerror = error => console.error('WebSocket error:', error);
        }

        function setDashboardConnectionBanner(active, text) {
            const banner = document.getElementById('connection-banner');
            const bannerText = document.getElementById('connection-banner-text');
            if (!banner) {
                return;
            }
            if (active) {
                banner.classList.add('active');
                if (bannerText && text) {
                    bannerText.textContent = text;
                }
                document.body.style.paddingTop = '3.5rem';
            } else {
                banner.classList.remove('active');
                document.body.style.paddingTop = '';
            }
        }

        function scheduleHealthCheck(delay) {
            if (healthTimer) {
                clearTimeout(healthTimer);
            }
            healthTimer = setTimeout(runHealthCheck, delay);
        }

        function runHealthCheck() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), HEALTH_TIMEOUT);
            fetch(HEALTH_ENDPOINT, {
                cache: 'no-store',
                credentials: 'same-origin',
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) {
                        throw new Error('Health check failed');
                    }
                    if (healthLost) {
                        healthLost = false;
                        setDashboardConnectionBanner(true, 'Connection restored. Reloading...');
                        setTimeout(() => {
                            setDashboardConnectionBanner(false);
                            window.location.reload();
                        }, 1200);
                        return;
                    }
                    setDashboardConnectionBanner(false);
                })
                .catch(() => {
                    clearTimeout(timeoutId);
                    if (!healthLost) {
                        healthLost = true;
                        setDashboardConnectionBanner(true, 'Connection lost. Attempting to reconnect...');
                    }
                })
                .finally(() => {
                    scheduleHealthCheck(healthLost ? HEALTH_INTERVAL_LOST : HEALTH_INTERVAL_OK);
                });
        }

        function startHealthMonitor() {
            const reloadBtn = document.getElementById('connection-banner-action');
            if (reloadBtn) {
                reloadBtn.addEventListener('click', () => window.location.reload());
            }
            runHealthCheck();
        }

        function handleRealtimeUpdate(data) {
            switch (data.type) {
                case 'server_status':
                    updateServerStatus(data.serverId, data.status);
                    break;
                case 'stats_update':
                    updateStats(data.stats);
                    break;
                default:
                    console.log('Unknown update type:', data.type);
            }
        }

        function updateServerStatus(serverId, status) {
            const serverCard = document.querySelector(`[data-server-id="${serverId}"]`);
            if (!serverCard) {
                return;
            }
            const statusBadge = serverCard.querySelector('[data-status]');
            if (statusBadge) {
                statusBadge.textContent = status.running ? 'Running' : 'Stopped';
                statusBadge.classList.toggle('is-running', status.running);
                statusBadge.classList.toggle('is-stopped', !status.running);
            }
            if (status.playerCount !== undefined) {
                const playerInfo = serverCard.querySelector('[data-player-count]');
                if (playerInfo) {
                    playerInfo.textContent = `${status.playerCount}/${status.maxPlayers || '?'}`;
                }
            }
        }

        function updateStats(stats) {
            if (stats.totalServers !== undefined) {
                const total = document.getElementById('total-servers');
                if (total) total.textContent = stats.totalServers;
                const hTotal = document.getElementById('header-total-servers');
                if (hTotal) hTotal.textContent = stats.totalServers;
                const hSuffix = document.getElementById('header-total-servers-suffix');
                if (hSuffix) hSuffix.textContent = stats.totalServers === 1 ? '' : 's';
            }
            if (stats.activeServers !== undefined) {
                const active = document.getElementById('active-servers');
                if (active) active.textContent = stats.activeServers;
                const hActive = document.getElementById('header-active-servers');
                if (hActive) hActive.textContent = stats.activeServers;
            }
            if (stats.totalPlayers !== undefined) {
                const players = document.getElementById('total-players');
                if (players) players.textContent = stats.totalPlayers;
                const hPlayers = document.getElementById('header-total-players');
                if (hPlayers) hPlayers.textContent = stats.totalPlayers;
            }
            const refresh = document.getElementById('last-refresh');
            if (refresh) {
                const now = new Date();
                refresh.textContent = now.toLocaleTimeString();
            }
        }

        // Lightweight header poll to ensure header stats stay in sync even without websocket
        function pollHeaderStats() {
            fetch('/api/stats', { headers: { 'Accept': 'application/json' }, credentials: 'same-origin', cache: 'no-store' })
                .then(r => r.ok ? r.json() : null)
                .then(data => { if (data) updateStats(data); })
                .catch(() => {});
        }

        function createNewServer() {
            window.location.href = '/server/new';
        }

        document.addEventListener('DOMContentLoaded', () => {
            connectWebSocket();
            startHealthMonitor();
            // Initial header stats + interval
            pollHeaderStats();
            setInterval(pollHeaderStats, 30000);

            document.body.addEventListener('htmx:beforeRequest', event => {
                if (event.detail.elt?.getAttribute('hx-indicator') === '#refresh-indicator') {
                    document.getElementById('refresh-indicator')?.classList.remove('hidden');
                }
            });

            document.body.addEventListener('htmx:afterRequest', event => {
                if (event.detail.elt?.getAttribute('hx-indicator') === '#refresh-indicator') {
                    document.getElementById('refresh-indicator')?.classList.add('hidden');
                }
            });

            setInterval(() => {
                htmx.trigger('#server-grid', 'refresh');
                htmx.trigger('.stats-grid', 'refresh');
            }, 30000);
        });

        document.addEventListener('keydown', event => {
            if (event.ctrlKey && event.shiftKey && event.key === 'T') {
                event.preventDefault();
                toggleTheme();
            }
            if (event.ctrlKey && event.key === 'r') {
                event.preventDefault();
                htmx.trigger('#server-grid', 'refresh');
            }
        });

        window.addEventListener('beforeunload', () => {
            if (ws) {
                ws.close();
            }
        });
    </script>
    
    {{ template "toast.html" . }}
</body>
</html>