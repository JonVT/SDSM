<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stationeers Server Manager - Configuration and Updates">
    <title>Manager - Stationeers Server Manager</title>
    
    <link rel="stylesheet" href="/static/ui-theme.css?v={{buildTime}}">
    <link rel="icon" href="/sdsm.png" type="image/png">
    
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        
        /* Connection banner uses shared styles from ui-theme.css */
        
        
        /* Use shared .button-group styles from ui-theme.css */
        
        #updating {
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            font-family: monospace;
            font-size: var(--text-sm);
        }
        
        #updating div {
            margin-bottom: var(--space-1);
            color: var(--text-primary);
        }
        
        /* Theme toggle uses shared styles from ui-theme.css */
        

        /* Software card: keep long messages and progress text from pushing layout */
        .update-message {
            display: none;
            margin-bottom: var(--space-3);
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--panel-border);
            border-radius: var(--radius-md);
            background: var(--surface-subtle);
            color: var(--text-secondary);
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        .update-message.active { display: block; }
        .update-message.error {
            border-color: rgba(239, 68, 68, 0.35);
            background: rgba(127, 29, 29, 0.12);
            color: var(--danger-500);
        }

        .table-container { width: 100%; overflow-x: visible; }
        .table-container table { width: 100%; table-layout: auto; border-collapse: collapse; }
        .table-container th, .table-container td { vertical-align: top; word-break: break-word; overflow-wrap: anywhere; }
        /* Allow Action column to wrap controls on small screens instead of forcing horizontal scroll */
        .table-container th:nth-child(4),
        .table-container td:nth-child(4) { width: auto; white-space: normal; }
        .table-container td:nth-child(4) { display: flex; flex-wrap: wrap; gap: var(--space-2); align-items: center; }
        /* Allow long titles and progress text to wrap within first column */
        .component-title, .progress-text { overflow-wrap: anywhere; word-break: break-word; }

        

        /* Inline spinner for action buttons */
        .btn-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-left: 8px;
            border-radius: 50%;
            border: 2px solid rgba(99, 102, 241, 0.35);
            border-top-color: #6366f1;
            animation: btnspin 0.8s linear infinite;
            vertical-align: -2px;
        }

        @keyframes btnspin { to { transform: rotate(360deg); } }

        /* Arrange Manager cards side-by-side on wide screens */
        .manager-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-4);
        }
        /* Allow grid children to shrink/grow without overflow affecting column sizing */
        .manager-grid > * { min-width: 0; }

        @media (min-width: 900px) {
            .manager-grid {
                /* Keep Software a bit wider, but don't over-shrink Configuration */
                grid-template-columns: 0.9fr 1.1fr;
            }
        }
        @media (min-width: 1280px) {
            .manager-grid {
                /* On very wide screens, slight extra bias toward Software Versions */
                grid-template-columns: 0.85fr 1.15fr;
            }
        }

        .manager-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            width: 100%;
            padding-left: var(--space-6);
            padding-right: var(--space-6);
        }

        /* Status pill variants are now provided globally by ui-theme.css */

        /* Inline layout for Configuration form: labels left, inputs right */
        .config-form .form-group {
            display: grid;
            grid-template-columns: minmax(110px, 160px) 1fr; /* flexible label column to avoid overflow */
            align-items: center;
            gap: var(--space-2); /* tighter label-to-field spacing */
            min-width: 0;
        }

        .config-form .form-group label {
            margin: 0;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .config-form .form-group input[type="text"],
        .config-form .form-group input[type="number"],
        .config-form .form-group select {
            width: 100%;
        }
        .config-form .form-group > * { min-width: 0; }

        /* Checkbox row aligns inline as well */
        .config-form .form-group input[type="checkbox"] {
            justify-self: start;
            width: 18px;
            height: 18px;
        }

        /* Position Update button aligned with inputs (second column), add space above */
        .config-form .form-row-full {
            grid-template-columns: minmax(110px, 160px) 1fr; /* keep consistent with label column */
            margin-top: var(--space-4);
        }
        .config-form .form-row-full > * {
            /* Span across both columns and align to the right edge of the pane */
            grid-column: 1 / -1;
            justify-self: end;
            width: auto;
        }

        /* Keep inline label/select rows tidy */
        .field-inline { display: inline-flex; align-items: center; gap: var(--space-1); }
        .inline-controls { display: inline-flex; align-items: center; gap: var(--space-2); flex-wrap: wrap; }
        /* Size/flow controls for Language/Source row */
        .lang-select { flex: 0 0 160px; width: 160px; max-width: 200px; }
        .source-select { flex: 1 1 260px; min-width: 220px; }
        @media (max-width: 640px) {
            .inline-controls { flex-wrap: wrap; }
            .lang-select, .source-select { flex: 1 1 100%; width: 100%; max-width: none; }
        }
        .field-inline label { margin: 0; }

        @media (max-width: 640px) {
            .config-form .form-group {
                grid-template-columns: 1fr;
                align-items: start;
            }

            .config-form .form-group label {
                margin-bottom: var(--space-1);
            }
        }
    </style>
    <script>
        (function () {
            // Lightweight header stats fetcher to keep hero-meta live
            function pollStats() {
                fetch('/api/stats', {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'same-origin',
                    cache: 'no-store'
                })
                    .then((res) => res.ok ? res.json() : null)
                    .then((data) => {
                        if (!data) return;
                        try {
                            document.getElementById('header-total-servers').textContent = data.totalServers;
                            document.getElementById('header-total-servers-suffix').textContent = data.totalServers === 1 ? '' : 's';
                            document.getElementById('header-active-servers').textContent = data.activeServers;
                            document.getElementById('header-total-players').textContent = data.totalPlayers;
                            document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
                        } catch(e) {
                            console.error("Error updating header stats:", e);
                        }
                    })
                    .catch(() => {});
            }

            document.addEventListener('DOMContentLoaded', () => {
                pollStats();
                setInterval(pollStats, 30000);
                // Trigger polling when user clicks the global refresh button
                document.body.addEventListener('htmx:afterRequest', function(evt) {
                    if (evt.detail.elt.getAttribute('hx-get') === '/api/refresh') {
                        pollStats();
                    }
                });
            });

            // Defer DOM queries and event bindings until the DOM is ready
            let pollTimer = null;

            // Toast helper for fetch-based requests
            function showToastFromHeaders(res) {
                try {
                    if (!window.showToast || !res || !res.headers) return;
                    const type = res.headers.get('X-Toast-Type');
                    const title = res.headers.get('X-Toast-Title');
                    const message = res.headers.get('X-Toast-Message');
                    if (message) {
                        window.showToast({ type: type || 'info', title: title || '', message });
                    }
                } catch (_) {
                    // ignore header parse failures
                }
            }

            function showButtonSpinner(btn, on) {
                if (!btn) return;
                btn.setAttribute('aria-busy', on ? 'true' : 'false');
                let sp = btn.querySelector('.btn-spinner');
                if (on) {
                    if (!sp) {
                        sp = document.createElement('span');
                        sp.className = 'btn-spinner';
                        sp.setAttribute('aria-hidden', 'true');
                        btn.appendChild(sp);
                    }
                } else if (sp) {
                    sp.remove();
                }
            }

            function showMessage(text, isError) {
                const messageEl = document.getElementById('updateMessage');
                if (!messageEl) return;
                if (!text) {
                    messageEl.classList.remove('active', 'error');
                    messageEl.textContent = '';
                    return;
                }
                messageEl.textContent = text;
                messageEl.classList.add('active');
                messageEl.classList.toggle('error', !!isError);
            }

            function setButtonsDisabled(disabled) {
                const btns = document.querySelectorAll('.update-trigger');
                btns.forEach((btn) => {
                    btn.disabled = disabled;
                    if (!disabled) showButtonSpinner(btn, false);
                });
            }

            function selectProgressRow(key) {
                if (!key) return null;
                return document.querySelector('.progress-row[data-progress="' + key.toLowerCase() + '"]');
            }

            function formatBytes(bytes) {
                if (!bytes || bytes <= 0) return '0 B';
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let value = bytes; let index = 0;
                while (value >= 1024 && index < units.length - 1) { value /= 1024; index++; }
                const fixed = value < 10 && index > 0 ? value.toFixed(1) : Math.round(value).toString();
                return fixed + ' ' + units[index];
            }

            function updateProgressRow(component) {
                const row = selectProgressRow(component.key || component.component);
                if (!row) return;
                const fill = row.querySelector('.progress-fill');
                const text = row.querySelector('.progress-text');
                const active = component.running || component.percent > 0 || !!component.error;

                row.classList.toggle('active', active);
                row.classList.toggle('error', !!component.error);

                if (fill) {
                    if (component.total > 0) {
                        fill.style.width = Math.min(component.percent || 0, 100) + '%';
                        fill.classList.remove('indeterminate');
                    } else if (component.running) {
                        fill.style.width = '100%';
                        fill.classList.add('indeterminate');
                    } else {
                        fill.style.width = '0%';
                        fill.classList.remove('indeterminate');
                    }
                }

                if (text) {
                    // Safe renderer for status + optional trailing text, avoids injecting arbitrary HTML
                    const renderStatus = (kind, label, tail) => {
                        text.innerHTML = '';
                        const pill = document.createElement('span');
                        pill.className = 'status-pill status-' + kind;
                        const dot = document.createElement('span');
                        dot.className = 'dot';
                        dot.setAttribute('aria-hidden', 'true');
                        pill.appendChild(dot);
                        pill.appendChild(document.createTextNode(label));
                        text.appendChild(pill);
                        if (tail) {
                            text.appendChild(document.createTextNode(' ' + tail));
                        }
                    };

                    let status = (component.stage || '').trim();
                    if (component.error) {
                        renderStatus('error', 'Error', component.error);
                    } else if (component.running) {
                        let tail = '';
                        if (component.total > 0) {
                            tail = (status ? status + ' ' : '') + '(' + (component.percent || 0) + '% of ' + formatBytes(component.total) + ')';
                        } else {
                            tail = status || '';
                        }
                        renderStatus('running', 'Running', tail);
                    } else if (!component.running && (status === '' || /^(idle)$/i.test(status))) {
                        renderStatus('idle', 'Idle', '');
                    } else if (!component.running && component.percent >= 100 && !component.error) {
                        renderStatus('complete', 'Completed', status && !/^completed$/i.test(status) ? status : '');
                    } else {
                        text.textContent = status;
                    }
                }
            }

            function handleProgressSnapshot(snapshot) {
                if (!snapshot || !Array.isArray(snapshot.components)) return;
                snapshot.components.forEach(updateProgressRow);
                setButtonsDisabled(snapshot.updating);
                if (!snapshot.updating && pollTimer) { clearInterval(pollTimer); pollTimer = null; }
            }

            function fetchProgress() {
                fetch('/update/progress', { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
                    .then((res) => res.ok ? res.json() : null)
                    .then(handleProgressSnapshot)
                    .catch(() => {});
            }

            function ensurePolling() {
                if (!pollTimer) pollTimer = setInterval(fetchProgress, 2000);
            }

            // Manager-level Language removed; languages are configured per server.

            document.addEventListener('DOMContentLoaded', () => {
                const buttons = Array.from(document.querySelectorAll('.update-trigger'));
                const configForm = document.getElementById('configForm');
                const configBtn = document.getElementById('updateConfigBtn');
                const shutdownBtn = document.getElementById('shutdownBtn');
                const restartBtn = document.getElementById('restartBtn');
                


                // Wire up update buttons
                buttons.forEach((btn) => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        if (btn.disabled) return;

                        const target = btn.dataset.updateTarget;
                        if (!target) return;

                        const params = new URLSearchParams();
                        params.append(target, '1');

                        setButtonsDisabled(true);
                        showButtonSpinner(btn, true);
                        showMessage('Starting update...', false);

                        fetch('/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-Requested-With': 'XMLHttpRequest',
                                'Accept': 'application/json'
                            },
                            credentials: 'same-origin',
                            body: params.toString()
                        })
                            .then((res) => { showToastFromHeaders(res); if (!res.ok) { return res.json().then((data) => Promise.reject(data)); } return res.json(); })
                            .then((data) => {
                                if (data && data.status === 'started') {
                                    const label = btn.closest('tr')?.querySelector('.component-title')?.textContent?.trim() || 'Update';
                                    showMessage(label + ' started...', false);
                                    fetchProgress();
                                    ensurePolling();
                                } else if (data && data.status === 'ok') {
                                    showMessage('Configuration updated.', false);
                                    setButtonsDisabled(false);
                                } else {
                                    showMessage('', false);
                                    setButtonsDisabled(false);
                                }
                            })
                            .catch((err) => {
                                const errorText = err && err.error ? err.error : 'Unable to start update. Please try again.';
                                showMessage(errorText, true);
                                setButtonsDisabled(false);
                                fetchProgress();
                            });
                    });
                });

            // Async submit for Configuration form with inline spinner
            if (configForm && configBtn) {
                configForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    if (configBtn.disabled) return;

                    const fd = new FormData(configForm);
                    const params = new URLSearchParams();
                    for (const [key, value] of fd.entries()) {
                        params.append(key, typeof value === 'string' ? value : String(value));
                    }
                    if (!params.has('update_config')) params.append('update_config', '1');

                    configBtn.disabled = true;
                    showButtonSpinner(configBtn, true);
                    showMessage('Saving configuration…', false);

                    fetch('/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: params.toString()
                    })
                        .then((res) => { showToastFromHeaders(res); if (!res.ok) { return res.json().then((data) => Promise.reject(data)); } return res.json(); })
                        .then((data) => {
                            if (data && (data.status === 'ok' || data.status === 'updated')) {
                                showMessage('Configuration updated.', false);
                            } else {
                                showMessage('Configuration updated.', false);
                            }
                        })
                        .catch((err) => {
                            const errorText = err && err.error ? err.error : 'Unable to save configuration. Please try again.';
                            showMessage(errorText, true);
                            if (window.showToast) window.showToast({ type: 'error', title: 'Save Failed', message: errorText });
                        })
                        .finally(() => {
                            configBtn.disabled = false;
                            showButtonSpinner(configBtn, false);
                        });
                });
            }

            // Footer actions: Shutdown / Restart with async POSTs and spinners
            function disableFooterButtons(disabled) {
                if (shutdownBtn) shutdownBtn.disabled = disabled;
                if (restartBtn) restartBtn.disabled = disabled;
                if (!disabled) {
                    if (shutdownBtn) showButtonSpinner(shutdownBtn, false);
                    if (restartBtn) showButtonSpinner(restartBtn, false);
                }
            }

            function postFooterAction(kind, btn, confirmingText, startedText, successText, errorText) {
                if (!btn) return;
                if (!confirm(confirmingText)) return;

                const params = new URLSearchParams();
                params.append(kind, '1');

                disableFooterButtons(true);
                showButtonSpinner(btn, true);
                showMessage(startedText, false);

                fetch('/update', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: params.toString()
                })
                    .then((res) => { showToastFromHeaders(res); if (!res.ok) { return res.json().then((data) => Promise.reject(data)); } return res.json().catch(() => ({})); })
                    .then(() => {
                        showMessage(successText, false);
                        setTimeout(() => disableFooterButtons(false), 3000);
                    })
                    .catch((err) => {
                        const e = err && err.error ? err.error : errorText;
                        showMessage(e, true);
                        if (window.showToast) window.showToast({ type: 'error', title: 'Request Failed', message: e });
                        disableFooterButtons(false);
                    });
            }

            if (shutdownBtn) {
                shutdownBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    postFooterAction(
                        'shutdown',
                        shutdownBtn,
                        'Are you sure you want to shutdown SDSM? All servers will be stopped.',
                        'Shutting down SDSM…',
                        'Shutdown initiated. The UI may go offline shortly.',
                        'Unable to shutdown SDSM. Please try again.'
                    );
                });
            }

            if (restartBtn) {
                restartBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    postFooterAction(
                        'restart',
                        restartBtn,
                        'Are you sure you want to restart SDSM? All servers will be temporarily stopped.',
                        'Restarting SDSM…',
                        'Restart initiated. The UI will reconnect when available.',
                        'Unable to restart SDSM. Please try again.'
                    );
                });
            }

            // User Management collapsible toggle
            (function(){
                const toggle = document.getElementById('userMgmtToggle');
                const content = document.getElementById('userMgmtContent');
                const chevron = document.getElementById('userMgmtChevron');
                const label = document.getElementById('userMgmtToggleLabel');
                if (!toggle || !content || !chevron) {
                    // Card may not be present in some builds
                } else {
                    const storageKey = 'sdsm:manager:user-mgmt:expanded';
                    const setExpanded = (expanded) => {
                        toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                        content.setAttribute('aria-hidden', expanded ? 'false' : 'true');
                        content.style.display = expanded ? '' : 'none';
                        chevron.innerHTML = expanded
                            ? '<polyline points="18 15 12 9 6 15"></polyline>' // up
                            : '<polyline points="6 9 12 15 18 9"></polyline>'; // down
                        if (label) label.textContent = expanded ? 'Less' : 'More';
                        toggle.title = expanded ? 'Collapse' : 'Expand';
                        try { sessionStorage.setItem(storageKey, expanded ? '1' : '0'); } catch(_) {}
                    };
                    let initial = '0';
                    try { initial = sessionStorage.getItem(storageKey) || '0'; } catch(_) {}
                    setExpanded(initial === '1');
                    toggle.addEventListener('click', () => {
                        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                        setExpanded(!isExpanded);
                    });
                }
            })();

            // User Management logic
            (function(){
                const tbody = document.getElementById('um_table_body');
                const addBtn = document.getElementById('um_add_btn');
                const newUser = document.getElementById('um_new_username');
                const newPass = document.getElementById('um_new_password');
                const newRole = document.getElementById('um_new_role');
                const accessBtn = document.getElementById('um_access_btn');
                const accessDrop = document.getElementById('um_access_dropdown');
                const accessAll = document.getElementById('um_access_all');
                const accessList = document.getElementById('um_access_list');
                const accessSave = document.getElementById('um_access_save');
                const accessClose = document.getElementById('um_access_close');
                if(!tbody) return;

                let listBusy = false;
                let serversCache = null;
                let usersData = [];
                let sortState = { key: 'username', dir: 'asc' };
                let newAssignAll = false;
                let newAssignServers = new Set();

                function ensureServersCache(){
                    if (serversCache) return Promise.resolve(serversCache);
                    return fetch('/api/servers', {headers:{'Accept':'application/json'}, credentials:'same-origin'})
                        .then(r => r.ok ? r.json() : Promise.reject())
                        .then(data => { serversCache = Array.isArray(data.servers) ? data.servers : []; return serversCache; })
                        .catch(()=>{ serversCache = []; return serversCache; });
                }

                function openAssignPanel(username){
                    const row = Array.from(tbody.querySelectorAll('tr')).find(tr => tr.firstChild && tr.firstChild.textContent === username);
                    if (!row) return;
                    let panelRow = row.nextElementSibling;
                    const isPanel = panelRow && panelRow.classList && panelRow.classList.contains('um-assign-panel');
                    if (!isPanel) {
                        panelRow = document.createElement('tr');
                        panelRow.className = 'um-assign-panel';
                        const td = document.createElement('td'); td.colSpan = 4; td.style.background='var(--bg-tertiary)'; td.style.borderTop='1px solid var(--border-color)'; td.style.padding='12px 16px';
                        td.innerHTML = '<div><strong>Server Access</strong><div class="form-group" style="margin-top:8px;"><label><input type="checkbox" id="assign_all_'+username+'"> All servers</label></div><div id="assign_list_'+username+'" class="assign-list" style="display:flex; flex-wrap:wrap; gap:8px; margin-top:8px;"></div><div style="margin-top:12px;"><button class="btn btn-primary" id="assign_save_'+username+'">Save</button> <button class="btn btn-secondary" id="assign_close_'+username+'">Close</button></div></div>';
                        panelRow.appendChild(td);
                        row.insertAdjacentElement('afterend', panelRow);
                    }

                    panelRow.style.display = panelRow.style.display === 'none' ? '' : '';

                    ensureServersCache().then(() => {
                        // Populate server checkboxes
                        const list = panelRow.querySelector('#assign_list_'+CSS.escape(username)+'' );
                        const chkAll = panelRow.querySelector('#assign_all_'+CSS.escape(username)+'' );
                        const btnSave = panelRow.querySelector('#assign_save_'+CSS.escape(username)+'' );
                        const btnClose = panelRow.querySelector('#assign_close_'+CSS.escape(username)+'' );
                        if (!list || !chkAll || !btnSave || !btnClose) return;

                        list.innerHTML = '';
                        serversCache.forEach(s => {
                            const lbl = document.createElement('label'); lbl.style.display='inline-flex'; lbl.style.alignItems='center'; lbl.style.gap='6px'; lbl.style.padding='4px 8px'; lbl.style.border='1px solid var(--border-color)'; lbl.style.borderRadius='8px';
                            const cb = document.createElement('input'); cb.type='checkbox'; cb.value=String(s.id); cb.className='assign-cb';
                            const span = document.createElement('span'); span.textContent = s.name + ' (#'+s.id+')';
                            lbl.appendChild(cb); lbl.appendChild(span);
                            list.appendChild(lbl);
                        });

                        function setListEnabled(enabled){
                            list.querySelectorAll('.assign-cb').forEach((el)=>{ el.disabled = !enabled; });
                        }

                        // Load current assignments
                        fetch('/api/users/'+encodeURIComponent(username)+'/assignments', {headers:{'Accept':'application/json'}, credentials:'same-origin'})
                          .then(r=> r.ok ? r.json() : { all:false, servers:[] })
                          .then(data => {
                              const all = !!data.all; const servers = Array.isArray(data.servers) ? data.servers.map(Number) : [];
                              chkAll.checked = all;
                              setListEnabled(!all);
                              list.querySelectorAll('.assign-cb').forEach((cb)=>{ const id = Number(cb.value); cb.checked = servers.includes(id); });
                          });

                        chkAll.addEventListener('change', ()=> setListEnabled(!chkAll.checked));
                        btnClose.addEventListener('click', ()=> { panelRow.style.display='none'; });
                        btnSave.addEventListener('click', ()=>{
                            const all = chkAll.checked;
                            const selected = Array.from(list.querySelectorAll('.assign-cb')).filter(cb=>cb.checked).map(cb=>Number(cb.value));
                            fetch('/api/users/'+encodeURIComponent(username)+'/assignments', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify({ all, servers: selected }) })
                              .then(r=> r.ok ? r.json() : r.json().then(Promise.reject))
                              .then(()=>{ if(window.showToast) window.showToast({type:'success', title:'Assignments Saved', message:'Updated access for '+username}); })
                              .catch(err=>{ if(window.showToast) window.showToast({type:'error', title:'Save Failed', message:(err&&err.error)||'Unable to save assignments'}); });
                        });
                    });
                }

                function positionDropdown(anchor, panel){
                    if (!anchor || !panel) return;
                    panel.style.visibility = 'hidden';
                    panel.style.display = 'block';
                    const rect = anchor.getBoundingClientRect();
                    const menuWidth = panel.offsetWidth;
                    const padding = 6;
                    // Align to the right edge of the button
                    let left = Math.round(rect.right - menuWidth);
                    let top = Math.round(rect.bottom + padding);
                    const vw = window.innerWidth; const vh = window.innerHeight;
                    if (left + menuWidth > vw - 8) left = Math.max(8, vw - menuWidth - 8);
                    if (left < 8) left = 8;
                    if (top > vh - 8) top = Math.max(8, rect.top - panel.offsetHeight - padding);
                    panel.style.left = left + 'px';
                    panel.style.top = top + 'px';
                    panel.style.visibility = '';
                }

                function openAccessDropdown(){
                    if (!accessDrop) return;
                    ensureServersCache().then(() => {
                        accessList.innerHTML = '';
                        serversCache.forEach(s => {
                            const lbl = document.createElement('label'); lbl.style.display='inline-flex'; lbl.style.alignItems='center'; lbl.style.gap='6px'; lbl.style.padding='4px 8px'; lbl.style.border='1px solid var(--border-color)'; lbl.style.borderRadius='8px';
                            const cb = document.createElement('input'); cb.type='checkbox'; cb.value=String(s.id); cb.checked = newAssignServers.has(Number(s.id)); cb.disabled = newAssignAll; cb.className='um-new-assign-cb';
                            cb.addEventListener('change', ()=>{ const id = Number(cb.value); if (cb.checked) newAssignServers.add(id); else newAssignServers.delete(id); });
                            const span = document.createElement('span'); span.textContent = s.name + ' (#'+s.id+')';
                            lbl.appendChild(cb); lbl.appendChild(span);
                            accessList.appendChild(lbl);
                        });
                        if (accessAll) {
                            accessAll.checked = newAssignAll;
                            accessAll.onchange = () => {
                                newAssignAll = accessAll.checked;
                                accessList.querySelectorAll('.um-new-assign-cb').forEach(el => { el.disabled = newAssignAll; });
                            };
                        }
                        accessDrop.style.display = 'block';
                        positionDropdown(accessBtn, accessDrop);
                        function onDocClick(evt){
                            if (!accessDrop.contains(evt.target) && evt.target !== accessBtn && !accessBtn.contains(evt.target)) {
                                closeAccessDropdown();
                                document.removeEventListener('mousedown', onDocClick);
                                window.removeEventListener('resize', onResize);
                                window.removeEventListener('scroll', onResize, { passive: true });
                            }
                        }
                        function onResize(){ positionDropdown(accessBtn, accessDrop); }
                        document.addEventListener('mousedown', onDocClick);
                        window.addEventListener('resize', onResize);
                        window.addEventListener('scroll', onResize, { passive: true });
                    });
                }

                function closeAccessDropdown(){ if (accessDrop) accessDrop.style.display = 'none'; }

                if (accessBtn) accessBtn.addEventListener('click', () => { if (accessDrop.style.display === 'block') closeAccessDropdown(); else openAccessDropdown(); });
                if (accessClose) accessClose.addEventListener('click', closeAccessDropdown);
                if (accessSave) accessSave.addEventListener('click', () => { closeAccessDropdown(); });

                function sortUsers(arr){
                    const k = sortState.key; const dir = sortState.dir === 'asc' ? 1 : -1;
                    const copy = arr.slice();
                    copy.sort((a,b)=>{
                        const av = (a[k] ?? '').toString().toLowerCase();
                        const bv = (b[k] ?? '').toString().toLowerCase();
                        if (av < bv) return -1*dir; if (av > bv) return 1*dir; return 0;
                    });
                    return copy;
                }

                function renderUsers(users){
                    tbody.innerHTML = '';
                    if(!Array.isArray(users) || users.length === 0){
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 4;
                        td.textContent = 'No users found.';
                        tr.appendChild(td); tbody.appendChild(tr); return;
                    }
                    sortUsers(users).forEach(u => {
                        const tr = document.createElement('tr');
                        const tdU = document.createElement('td'); tdU.textContent = u.username; tr.appendChild(tdU);
                        const tdR = document.createElement('td');
                        const sel = document.createElement('select'); sel.className='form-input'; sel.style.width='140px';
                        ['admin','operator'].forEach(r => {
                            const opt = document.createElement('option'); opt.value=r; opt.textContent=r.charAt(0).toUpperCase()+r.slice(1);
                            if(String(u.role).toLowerCase()===r) opt.selected=true; sel.appendChild(opt);
                        });
                        sel.addEventListener('change', () => updateRole(u.username, sel.value));
                        tdR.appendChild(sel); tr.appendChild(tdR);
                        const tdC = document.createElement('td'); tdC.textContent = (u.created_at ? new Date(u.created_at).toLocaleString() : ''); tr.appendChild(tdC);
                        const tdA = document.createElement('td');
                        // Reset password button
                        const btnPw = document.createElement('button'); btnPw.className='btn btn-secondary'; btnPw.textContent='Set Password';
                        btnPw.addEventListener('click', () => {
                            const p = prompt('Enter new password for '+u.username+':');
                            if(p && p.length>=8){ resetPassword(u.username, p); }
                            else if(p!==null){ if(window.showToast) window.showToast({type:'error', title:'Invalid', message:'Password must be at least 8 characters.'}); }
                        });
                        tdA.appendChild(btnPw);
                        // Delete button
                        const btnDel = document.createElement('button'); btnDel.className='btn btn-danger'; btnDel.style.marginLeft='8px'; btnDel.textContent='Delete';
                        btnDel.addEventListener('click', () => { if(confirm('Delete user '+u.username+'?')) deleteUser(u.username); });
                        tdA.appendChild(btnDel);
                        // Assignments button (operators only)
                        const isOperator = String(u.role).toLowerCase() === 'operator';
                        if (isOperator) {
                            const btnAssign = document.createElement('button'); btnAssign.className='btn btn-secondary'; btnAssign.style.marginLeft='8px'; btnAssign.textContent='Assign Servers'; btnAssign.title='Manage server access for this operator';
                            btnAssign.addEventListener('click', () => openAssignPanel(u.username));
                            tdA.appendChild(btnAssign);
                        }
                        tr.appendChild(tdA);
                        tbody.appendChild(tr);
                    });
                }

                function fetchUsers(){
                    if(listBusy) return; listBusy = true;
                    const url = '/api/users';
                    fetch(url, {headers:{'Accept':'application/json'}, credentials:'same-origin'})
                        .then(r => r.ok ? r.json() : Promise.reject())
                        .then(data => { usersData = Array.isArray(data.users)? data.users : []; renderUsers(usersData); })
                        .catch(()=>{})
                        .finally(()=>{ listBusy=false; });
                }

                function updateRole(username, role){
                    fetch('/api/users/'+encodeURIComponent(username)+'/role', {
                        method:'PATCH', credentials:'same-origin', headers:{'Content-Type':'application/json','Accept':'application/json'},
                        body: JSON.stringify({role})
                    }).then(r => r.ok ? r.json() : r.json().then(Promise.reject))
                      .then(()=>{ if(window.showToast) window.showToast({type:'success', title:'Role Updated', message: username+" → "+role}); fetchUsers(); })
                      .catch(err=>{ if(window.showToast) window.showToast({type:'error', title:'Update Failed', message: (err&&err.error)||'Unable to update role'}); fetchUsers(); });
                }

                function resetPassword(username, password){
                    fetch('/api/users/'+encodeURIComponent(username)+'/reset-password', {
                        method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','Accept':'application/json'},
                        body: JSON.stringify({password})
                    }).then(r => r.ok ? r.json() : r.json().then(Promise.reject))
                      .then(()=>{ if(window.showToast) window.showToast({type:'success', title:'Password Set', message: 'Password updated for '+username}); })
                      .catch(err=>{ if(window.showToast) window.showToast({type:'error', title:'Set Failed', message: (err&&err.error)||'Unable to set password'}); });
                }

                function deleteUser(username){
                    fetch('/api/users/'+encodeURIComponent(username), { method:'DELETE', credentials:'same-origin', headers:{'Accept':'application/json'} })
                      .then(r => r.ok ? r.json() : r.json().then(Promise.reject))
                      .then(()=>{ if(window.showToast) window.showToast({type:'success', title:'User Deleted', message: username}); fetchUsers(); })
                      .catch(err=>{ if(window.showToast) window.showToast({type:'error', title:'Delete Failed', message: (err&&err.error)||'Unable to delete user'}); fetchUsers(); });
                }

                if(addBtn && newUser && newPass && newRole){
                    addBtn.addEventListener('click', () => {
                        const u = newUser.value.trim(); const p = newPass.value; const r = newRole.value;
                        if(u.length < 3){ if(window.showToast) window.showToast({type:'error', title:'Invalid', message:'Username must be at least 3 characters.'}); return; }
                        if(p.length < 8){ if(window.showToast) window.showToast({type:'error', title:'Invalid', message:'Password must be at least 8 characters.'}); return; }
                        addBtn.disabled = true;
                        fetch('/api/users', {
                            method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','Accept':'application/json'},
                            body: JSON.stringify({username:u, password:p, role:r})
                        }).then(r => r.ok ? r.json() : r.json().then(Promise.reject))
                          .then(()=>{
                              const doAssign = (r === 'operator');
                              const payload = { all: newAssignAll, servers: Array.from(newAssignServers) };
                              const assign = doAssign ? fetch('/api/users/'+encodeURIComponent(u)+'/assignments', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(payload) }) : Promise.resolve();
                              return assign.then(() => {
                                  if(window.showToast) window.showToast({type:'success', title:'User Added', message: u});
                                  newUser.value=''; newPass.value=''; newRole.value='operator';
                                  newAssignAll = false; newAssignServers.clear(); closeAccessDropdown();
                                  fetchUsers();
                              });
                          })
                          .catch(err=>{ if(window.showToast) window.showToast({type:'error', title:'Add Failed', message: (err&&err.error)||'Unable to add user'}); })
                          .finally(()=>{ addBtn.disabled = false; });
                    });
                }
                // Toggle server access control visibility by role (optional UX)
                if (newRole && accessBtn) {
                    const updateAccessVisibility = () => {
                        const isOp = newRole.value === 'operator';
                        accessBtn.style.display = isOp ? '' : 'none';
                        if (!isOp) closeAccessDropdown();
                    };
                    newRole.addEventListener('change', updateAccessVisibility);
                    updateAccessVisibility();
                }

                // Sorting handlers
                document.querySelectorAll('th.um-sort').forEach(th => {
                    th.addEventListener('click', () => {
                        const key = th.dataset.key;
                        if (sortState.key === key) sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
                        else { sortState.key = key; sortState.dir = 'asc'; }
                        renderUsers(usersData);
                    });
                });
                // Initial load
                fetchUsers();
            })();

            // Initial progress fetch
            fetchProgress();
            ensurePolling();
            }); // DOMContentLoaded end
        })();
    </script>
</head>

<body class="page-shell">
    <div id="connectionBanner" class="connection-banner" role="status" aria-live="polite">
        <span id="connectionBannerText">Connection lost. Attempting to reconnect...</span>
        <button type="button" id="connectionBannerAction">Reload</button>
    </div>
    
    <div class="container">
    <header class="hero-card">
        <div class="hero-main">
            <img src="/sdsm.png" alt="SDSM logo" class="hero-logo" width="72" height="72">
            <div class="hero-heading">
                <h1 class="hero-title">Server Manager</h1>
                <p class="hero-subtitle">Configure and update your Stationeers servers.</p>
            </div>
        </div>
        <div class="hero-meta">
            <div class="hero-meta-title">Fleet Overview</div>
            <p class="hero-meta-text">
                <span id="header-total-servers">--</span> server<span id="header-total-servers-suffix">s</span> tracked •
                <span id="header-active-servers">--</span> active •
                <span id="header-total-players">--</span> players
            </p>
            <span class="pill">Last refresh: <span id="last-refresh">just now</span></span>
        </div>
        <div class="hero-actions flex-col items-end">
            <div class="row wrap">
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                <span id="theme-icon">🌙</span>
            </button>
            <button
                class="btn btn-primary"
                hx-get="/api/refresh"
                hx-trigger="click"
                hx-indicator="#manager-refresh-indicator"
                hx-swap="none"
            >
                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                    <path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                <span id="manager-refresh-indicator" class="hidden">⟳</span>
                Refresh
            </button>
            <a href="/dashboard" class="btn btn-primary" title="Go to Dashboard">
                {{ template "icon_dashboard" . }}
                Dashboard
            </a>
            {{ template "user_menu" . }}
            </div>
            <span style="font-size: 0.7rem; color: var(--text-muted, #888); margin-top: 4px;">{{buildTime}}</span>
        </div>
    </header>
    </div>

    <main class="container">
        {{ if .game_data_warnings }}
        {{ if gt (len .game_data_warnings) 0 }}
        <div class="alert alert-warning mb-4" role="status" aria-live="polite">
            <div class="alert-icon" aria-hidden="true">
                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12" y2="16"></line>
                </svg>
            </div>
            <div class="alert-content">
                <div class="alert-title">Game data missing</div>
                <ul class="alert-message" style="margin:0; padding-left: 1.2rem;">
                    {{ range .game_data_warnings }}
                    <li>{{ . }}</li>
                    {{ end }}
                </ul>
            </div>
        </div>
        {{ end }}
        {{ end }}
        <div class="manager-content">
            <div class="manager-grid">
                <div class="glass-card">
                    <h3>Configuration</h3>
                    <form id="configForm" class="config-form" action="/update" method="POST">
                        <div class="form-group">
                            <label for="steam_id">Steam ID</label>
                            <input type="text" id="steam_id" name="steam_id" value="{{ .steam_id }}" required>
                        </div>
                        <div class="form-group">
                            <label for="port">Port</label>
                            <input type="text" id="port" name="port" value="{{ .port }}" required>
                        </div>
                        <div class="form-group">
                            <label for="root_path">Root Path</label>
                            <input type="text" id="root_path" name="root_path" value="{{ .root_path }}" required>
                        </div>
                        <div class="form-group">
                            <label for="auto_update">Auto Update Time</label>
                            <input type="text" id="auto_update" name="auto_update" value="{{ .auto_update }}" required>
                        </div>
                        <div class="form-group">
                            <label for="start_update">Update at Start</label>
                            <input type="checkbox" id="start_update" name="start_update" {{if .start_update}}checked{{end}}>
                        </div>
                        <div class="form-group form-row-full">
                            <button id="updateConfigBtn" type="submit" name="update_config" class="btn btn-primary" {{if .updating}}disabled{{end}}>
                                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                    <polyline points="7 3 7 8 15 8"></polyline>
                                </svg>
                                Update Config
                            </button>
                        </div>
                    </form>
                    <div class="note">
                        <strong>Note:</strong> After updating the configuration, SDSM may restart so changes can take effect.
                    </div>
                </div>

                <div class="glass-card">
                    {{if not .updating}}
                    <div id="versions">
                        <h3>Software Versions</h3>
                        <form action="/update" method="POST" id="updateForm">
                            <div id="updateMessage" class="update-message" role="status" aria-live="polite"></div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Component</th>
                                            <th>Deployed</th>
                                            <th>Latest</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        
                                        <tr>
                                            <td>
                                                <div class="component-title">steamcmd</div>
                                                <div class="progress-row" data-progress="steamcmd">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td>{{ .steamcmd_deployed }}</td>
                                            <td>{{ .steamcmd_latest }}</td>
                                            <td>
                                                <button type="submit" name="update_steamcmd" data-update-target="update_steamcmd" data-component="steamcmd" class="btn {{if eq .steamcmd_deployed .steamcmd_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="component-title">rocketstation_DedicatedServer Release</div>
                                                <div class="progress-row" data-progress="release">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td>{{ .release_deployed }}</td>
                                            <td>{{ .release_latest }}</td>
                                            <td>
                                                <button type="submit" name="update_release" data-update-target="update_release" data-component="release" class="btn {{if eq .release_deployed .release_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="component-title">rocketstation_DedicatedServer Beta</div>
                                                <div class="progress-row" data-progress="beta">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td>{{ .beta_deployed }}</td>
                                            <td>{{ .beta_latest }}</td>
                                            <td>
                                                <button type="submit" name="update_beta" data-update-target="update_beta" data-component="beta" class="btn {{if eq .beta_deployed .beta_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="component-title">BEPINEX</div>
                                                <div class="progress-row" data-progress="bepinex">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td>{{ .bepinex_deployed }}</td>
                                            <td>{{ .bepinex_latest }}</td>
                                            <td>
                                                <button type="submit" name="update_bepinex" data-update-target="update_bepinex" data-component="bepinex" class="btn {{if eq .bepinex_deployed .bepinex_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="component-title">Stationeers LaunchPad</div>
                                                <div class="progress-row" data-progress="launchpad">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td>{{ .launchpad_deployed }}</td>
                                            <td>{{ .launchpad_latest }}</td>
                                            <td>
                                                <button type="submit" name="update_launchpad" data-update-target="update_launchpad" data-component="launchpad" class="btn {{if eq .launchpad_deployed .launchpad_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="component-title">SCON</div>
                                                <div class="progress-row" data-progress="scon">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td>{{ .scon_deployed }}</td>
                                            <td>{{ .scon_latest }}</td>
                                            <td>
                                                <button type="submit" name="update_scon" data-update-target="update_scon" data-component="scon" class="btn {{if eq .scon_deployed .scon_latest}}btn-success{{else}}btn-danger{{end}} update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3"></td>
                                            <td>
                                                <button type="submit" name="update_all" data-update-target="update_all" data-component="all" class="btn btn-primary update-trigger" {{if .updating}}disabled{{end}}>
                                                    Update All
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                    {{else}}
                    <div>
                        <h3>Updating...</h3>
                        <div id="updating">Nothing to see here...</div>
                        <script>
                            const eventSource = new EventSource('/updating');
                            const messagesDiv = document.getElementById('updating');

                            eventSource.onmessage = function (event) {
                                const newMessage = document.createElement('div');
                                newMessage.textContent = event.data;
                                messagesDiv.appendChild(newMessage);
                                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                            };
                        </script>
                    </div>
                    {{end}}
                </div>
            </div>
            
            <div class="glass-card" id="userMgmtCard">
                <div class="card-header" style="display:flex; align-items:center; justify-content:space-between; gap: var(--space-2);">
                    <h3 class="card-title" style="margin:0;">User Management</h3>
                    <button type="button" id="userMgmtToggle" class="btn btn-secondary btn-min-sm" aria-expanded="false" aria-controls="userMgmtContent" title="Expand">
                        <svg id="userMgmtChevron" class="icon-inline" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        <span id="userMgmtToggleLabel" style="margin-left:6px;">More</span>
                    </button>
                </div>
                <div id="userMgmtContent" class="card-body" aria-hidden="true" style="display:none;">
                    <div class="form-grid-compact" style="margin-bottom: var(--space-3);">
                        <div class="form-group">
                            <label>Add User</label>
                            <div class="inline-controls" style="flex-wrap: nowrap;">
                                <input id="um_new_username" type="text" class="form-input-inline" placeholder="username" minlength="3" required />
                                <input id="um_new_password" type="password" class="form-input-inline" placeholder="password (min 8)" minlength="8" required />
                                <select id="um_new_role" class="form-input-inline" style="width: 120px; min-width: 120px;">
                                    <option value="admin">Admin</option>
                                    <option value="operator" selected>Operator</option>
                                </select>
                                <button type="button" id="um_access_btn" class="btn btn-secondary" title="Choose servers for this operator" style="min-width: 120px; white-space: nowrap;">Servers ▾</button>
                                <button type="button" id="um_add_btn" class="btn btn-primary">Add</button>
                            </div>
                            <div id="um_access_dropdown" class="glass-card" style="display:none; position: fixed; z-index: 5000; width: 340px; padding: 12px; border: 1px solid var(--border-color);">
                                <div style="display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px;">
                                    <strong>Server Access</strong>
                                    <button type="button" id="um_access_close" class="btn btn-min-sm btn-secondary">Close</button>
                                </div>
                                <div class="form-group" style="margin-bottom:8px;">
                                    <label style="display:inline-flex; align-items:center; gap:8px;"><input type="checkbox" id="um_access_all"> All servers</label>
                                </div>
                                <div id="um_access_list" style="display:flex; flex-wrap:wrap; gap:8px; max-height: 240px; overflow:auto; padding: 4px; border: 1px dashed var(--border-color); border-radius: 8px;"></div>
                                <div style="margin-top:10px; display:flex; justify-content:flex-end; gap:8px;">
                                    <button type="button" id="um_access_save" class="btn btn-primary">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="um-sort" data-key="username" style="cursor:pointer;">Username</th>
                                    <th class="um-sort" data-key="role" style="cursor:pointer;">Role</th>
                                    <th class="um-sort" data-key="created_at" style="cursor:pointer;">Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="um_table_body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            
            <div class="glass-card">
                <p>There are <strong>{{.server_count_active}}</strong> servers currently running.</p>
                <div class="button-group centered gap-3 mt-4">
                    <form id="footerActionsForm" action="/update" method="POST" style="display: contents;">
                        <button id="shutdownBtn" type="submit" name="shutdown" value="1" class="btn btn-danger" {{if .updating}}disabled{{end}}>
                            <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                                <line x1="12" y1="2" x2="12" y2="12"></line>
                            </svg>
                            Shutdown SDSM
                        </button>
                        <button id="restartBtn" type="submit" name="restart" value="1" class="btn btn-primary" {{if .updating}}disabled{{end}}>
                            <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <polyline points="1 20 1 14 7 14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            Restart SDSM
                        </button>
                    </form>
                    <a class="btn btn-secondary" href="/logs/sdsm" target="_blank" rel="noopener">
                        <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        View Log
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script>
        (function () {
            const HEALTH_ENDPOINT = '/healthz';
            const HEALTH_TIMEOUT = 4000;
            const INTERVAL_OK = 15000;
            const INTERVAL_LOST = 5000;

            let healthTimer = null;
            let connectionLost = false;

            function setBanner(active, message) {
                const banner = document.getElementById('connectionBanner');
                const text = document.getElementById('connectionBannerText');
                if (!banner) {
                    return;
                }
                if (active) {
                    banner.classList.add('active');
                    if (text && message) {
                        text.textContent = message;
                    }
                    document.body.style.paddingTop = '4rem';
                } else {
                    banner.classList.remove('active');
                    document.body.style.paddingTop = '';
                }
            }

            function scheduleNext(delay) {
                if (healthTimer) {
                    clearTimeout(healthTimer);
                }
                healthTimer = setTimeout(runHealthCheck, delay);
            }

            function runHealthCheck() {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), HEALTH_TIMEOUT);

                fetch(HEALTH_ENDPOINT, {
                    cache: 'no-store',
                    credentials: 'same-origin',
                    signal: controller.signal
                })
                    .then((response) => {
                        clearTimeout(timeoutId);
                        if (!response.ok) {
                            throw new Error('Health check failed');
                        }
                        if (connectionLost) {
                            connectionLost = false;
                            setBanner(true, 'Connection restored. Reloading...');
                            setTimeout(() => {
                                setBanner(false);
                                window.location.reload();
                            }, 1200);
                            return;
                        }
                        setBanner(false);
                    })
                    .catch(() => {
                        clearTimeout(timeoutId);
                        if (!connectionLost) {
                            connectionLost = true;
                            setBanner(true, 'Connection lost. Attempting to reconnect...');
                        }
                    })
                    .finally(() => {
                        scheduleNext(connectionLost ? INTERVAL_LOST : INTERVAL_OK);
                    });
            }

            document.addEventListener('DOMContentLoaded', () => {
                const reloadButton = document.getElementById('connectionBannerAction');
                if (reloadButton) {
                    reloadButton.addEventListener('click', () => window.location.reload());
                }
                runHealthCheck();
            });
        })();
    </script>
    
    <script>
        // Theme management
        function getStoredTheme() {
            return localStorage.getItem('theme') || 'light';
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const icon = document.getElementById('theme-icon');
            icon.textContent = theme === 'dark' ? '☀️' : '🌙';
        }
        
        function toggleTheme() {
            const currentTheme = getStoredTheme();
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }
        
        // Initialize theme
        setTheme(getStoredTheme());
    </script>
    
    
    {{ template "toast.html" . }}
    {{ template "footer" . }}
</body>

</html>