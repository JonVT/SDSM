<!DOCTYPE html>
<html lang="en" data-theme="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Stationeers Server Manager - Configuration and Updates">
    <title>Manager - Stationeers Server Manager</title>
    
    <link rel="stylesheet" href="/static/ui-theme.css?v={{buildTime}}">
    <link rel="icon" href="/sdsm.png" type="image/png">
    
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        
        /* Connection banner uses shared styles from ui-theme.css */
        
        
        /* Use shared .button-group styles from ui-theme.css */
        
        #updating {
            max-height: 400px;
            overflow-y: auto;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            padding: var(--space-4);
            font-family: monospace;
            font-size: var(--text-sm);
        }
        
        #updating div {
            margin-bottom: var(--space-1);
            color: var(--text-primary);
        }
        
        /* Theme toggle uses shared styles from ui-theme.css */
        

        /* Software card: keep long messages and progress text from pushing layout */
        .update-message {
            display: none;
            margin-bottom: var(--space-3);
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--panel-border);
            border-radius: var(--radius-md);
            background: var(--surface-subtle);
            color: var(--text-secondary);
            overflow-wrap: anywhere;
            word-break: break-word;
        }
        .update-message.active { display: block; }
        .update-message.error {
            border-color: rgba(239, 68, 68, 0.35);
            background: rgba(127, 29, 29, 0.12);
            color: var(--danger-500);
        }

        .table-container { width: 100%; overflow-x: visible; }
        .table-container table { width: 100%; table-layout: auto; border-collapse: collapse; }
        .table-container th, .table-container td { vertical-align: top; word-break: break-word; overflow-wrap: anywhere; }
        /* Allow Action column to wrap controls on small screens instead of forcing horizontal scroll */
        .table-container th:nth-child(4),
        .table-container td:nth-child(4) { width: auto; white-space: normal; }
        .table-container td:nth-child(4) { display: flex; flex-wrap: wrap; gap: var(--space-2); align-items: center; }
        /* Allow long titles and progress text to wrap within first column */
        .component-title, .progress-text { overflow-wrap: anywhere; word-break: break-word; }

        

        /* Inline spinner for action buttons */
        .btn-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            margin-left: 8px;
            border-radius: 50%;
            border: 2px solid rgba(99, 102, 241, 0.35);
            border-top-color: #6366f1;
            animation: btnspin 0.8s linear infinite;
            vertical-align: -2px;
        }

        @keyframes btnspin { to { transform: rotate(360deg); } }

        /* Arrange Manager cards side-by-side on wide screens */
        .manager-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: var(--space-4);
        }
        /* Allow grid children to shrink/grow without overflow affecting column sizing */
        .manager-grid > * { min-width: 0; }

        @media (min-width: 900px) {
            .manager-grid {
                /* Keep Software a bit wider, but don't over-shrink Configuration */
                grid-template-columns: 0.9fr 1.1fr;
            }
        }
        @media (min-width: 1280px) {
            .manager-grid {
                /* On very wide screens, slight extra bias toward Software Versions */
                grid-template-columns: 0.85fr 1.15fr;
            }
        }

        .manager-content {
            display: flex;
            flex-direction: column;
            gap: var(--space-4);
            width: 100%;
            padding-left: var(--space-6);
            padding-right: var(--space-6);
        }

        /* Status pill variants are now provided globally by ui-theme.css */

        /* Inline layout for Configuration form: labels left, inputs right */
        .config-form .form-group {
            display: grid;
            grid-template-columns: minmax(110px, 160px) 1fr; /* flexible label column to avoid overflow */
            align-items: center;
            gap: var(--space-2); /* tighter label-to-field spacing */
            min-width: 0;
        }

        .config-form .form-group label {
            margin: 0;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .config-form .form-group input[type="text"],
        .config-form .form-group input[type="number"],
        .config-form .form-group select {
            width: 100%;
        }
        .config-form .form-group > * { min-width: 0; }

        /* Checkbox row aligns inline as well */
        .config-form .form-group input[type="checkbox"] {
            justify-self: start;
            width: 18px;
            height: 18px;
        }

        /* Ensure consistent checkbox sizing across browsers */
        .form-checkbox {
            width: 18px;
            height: 18px;
            flex-shrink: 0;
        }

        /* Position Update button aligned with inputs (second column), add space above */
        .config-form .form-row-full {
            grid-template-columns: minmax(110px, 160px) 1fr; /* keep consistent with label column */
            margin-top: var(--space-4);
        }
        .config-form .form-row-full > * {
            /* Span across both columns and align to the right edge of the pane */
            grid-column: 1 / -1;
            justify-self: end;
            width: auto;
        }

        /* Keep inline label/select rows tidy */
        .field-inline { display: inline-flex; align-items: center; gap: var(--space-1); }
        .inline-controls { display: inline-flex; align-items: center; gap: var(--space-2); flex-wrap: wrap; }
        /* Size/flow controls for Language/Source row */
        .lang-select { flex: 0 0 160px; width: 160px; max-width: 200px; }
        .source-select { flex: 1 1 260px; min-width: 220px; }
        @media (max-width: 640px) {
            .inline-controls { flex-wrap: wrap; }
            .lang-select, .source-select { flex: 1 1 100%; width: 100%; max-width: none; }
        }
        .field-inline label { margin: 0; }

        @media (max-width: 640px) {
            .config-form .form-group {
                grid-template-columns: 1fr;
                align-items: start;
            }

            .config-form .form-group label {
                margin-bottom: var(--space-1);
            }
        }
    </style>
    <script>
        (function () {
            // Lightweight header stats fetcher to keep hero-meta live
            function pollStats() {
                fetch('/api/stats', {
                    headers: { 'Accept': 'application/json' },
                    credentials: 'same-origin',
                    cache: 'no-store'
                })
                    .then((res) => res.ok ? res.json() : null)
                    .then((data) => {
                        if (!data) return;
                        try {
                            document.getElementById('header-total-servers').textContent = data.totalServers;
                            document.getElementById('header-total-servers-suffix').textContent = data.totalServers === 1 ? '' : 's';
                            document.getElementById('header-active-servers').textContent = data.activeServers;
                            document.getElementById('header-total-players').textContent = data.totalPlayers;
                            document.getElementById('last-refresh').textContent = new Date().toLocaleTimeString();
                        } catch(e) {
                            console.error("Error updating header stats:", e);
                        }
                    })
                    .catch(() => {});
            }

            document.addEventListener('DOMContentLoaded', () => {
                pollStats();
                setInterval(pollStats, 30000);
                // Trigger polling when user clicks the global refresh button
                document.body.addEventListener('htmx:afterRequest', function(evt) {
                    if (evt.detail.elt.getAttribute('hx-get') === '/api/refresh') {
                        pollStats();
                    }
                });
            });

            // Defer DOM queries and event bindings until the DOM is ready
            let pollTimer = null;

            // Toast helper for fetch-based requests
            function showToastFromHeaders(res) {
                try {
                    if (!window.showToast || !res || !res.headers) return;
                    const type = res.headers.get('X-Toast-Type');
                    const title = res.headers.get('X-Toast-Title');
                    const message = res.headers.get('X-Toast-Message');
                    if (message) {
                        window.showToast({ type: type || 'info', title: title || '', message });
                    }
                } catch (_) {
                    // ignore header parse failures
                }
            }

            function showButtonSpinner(btn, on) {
                if (!btn) return;
                btn.setAttribute('aria-busy', on ? 'true' : 'false');
                let sp = btn.querySelector('.btn-spinner');
                if (on) {
                    if (!sp) {
                        sp = document.createElement('span');
                        sp.className = 'btn-spinner';
                        sp.setAttribute('aria-hidden', 'true');
                        btn.appendChild(sp);
                    }
                } else if (sp) {
                    sp.remove();
                }
            }

            // Unified confirm wrapper using modal helper when available
            function askConfirm(options, fallbackMessage) {
                try {
                    if (window.openConfirm) {
                        return window.openConfirm(options);
                    }
                } catch(_) {}
                return Promise.resolve(window.confirm(fallbackMessage));
            }

            function showMessage(text, isError) {
                const messageEl = document.getElementById('updateMessage');
                if (!messageEl) return;
                if (!text) {
                    messageEl.classList.remove('active', 'error');
                    messageEl.textContent = '';
                    return;
                }
                messageEl.textContent = text;
                messageEl.classList.add('active');
                messageEl.classList.toggle('error', !!isError);
            }

            function setButtonsDisabled(disabled) {
                const btns = document.querySelectorAll('.update-trigger');
                btns.forEach((btn) => {
                    // Only toggle disabled if not currently running a spinner operation
                    if (!disabled) {
                        btn.disabled = false;
                        showButtonSpinner(btn, false);
                    } else {
                        btn.disabled = true;
                    }
                });
                // Also toggle config button
                const cfgBtn = document.getElementById('updateConfigBtn');
                if (cfgBtn) cfgBtn.disabled = disabled;
            }

            function selectProgressRow(key) {
                if (!key) return null;
                return document.querySelector('.progress-row[data-progress="' + key.toLowerCase() + '"]');
            }

            function formatBytes(bytes) {
                if (!bytes || bytes <= 0) return '0 B';
                const units = ['B', 'KB', 'MB', 'GB', 'TB'];
                let value = bytes; let index = 0;
                while (value >= 1024 && index < units.length - 1) { value /= 1024; index++; }
                const fixed = value < 10 && index > 0 ? value.toFixed(1) : Math.round(value).toString();
                return fixed + ' ' + units[index];
            }

            function updateProgressRow(component) {
                const row = selectProgressRow(component.key || component.component);
                if (!row) return;
                const fill = row.querySelector('.progress-fill');
                const text = row.querySelector('.progress-text');
                const active = component.running || component.percent > 0 || !!component.error;

                row.classList.toggle('active', active);
                row.classList.toggle('error', !!component.error);

                if (fill) {
                    if (component.total > 0) {
                        fill.style.width = Math.min(component.percent || 0, 100) + '%';
                        fill.classList.remove('indeterminate');
                    } else if (component.running) {
                        fill.style.width = '100%';
                        fill.classList.add('indeterminate');
                    } else {
                        fill.style.width = '0%';
                        fill.classList.remove('indeterminate');
                    }
                }

                if (text) {
                    // Safe renderer for status + optional trailing text, avoids injecting arbitrary HTML
                    const renderStatus = (kind, label, tail) => {
                        text.innerHTML = '';
                        const pill = document.createElement('span');
                        pill.className = 'status-pill status-' + kind;
                        const dot = document.createElement('span');
                        dot.className = 'dot';
                        dot.setAttribute('aria-hidden', 'true');
                        pill.appendChild(dot);
                        pill.appendChild(document.createTextNode(label));
                        text.appendChild(pill);
                        if (tail) {
                            text.appendChild(document.createTextNode(' ' + tail));
                        }
                    };

                    let status = (component.stage || '').trim();
                    if (component.error) {
                        renderStatus('error', 'Error', component.error);
                    } else if (component.running) {
                        let tail = '';
                        if (component.total > 0) {
                            tail = (status ? status + ' ' : '') + '(' + (component.percent || 0) + '% of ' + formatBytes(component.total) + ')';
                        } else {
                            tail = status || '';
                        }
                        renderStatus('running', 'Running', tail);
                    } else if (!component.running && (status === '' || /^(idle)$/i.test(status))) {
                        renderStatus('idle', 'Idle', '');
                    } else if (!component.running && component.percent >= 100 && !component.error) {
                        renderStatus('complete', 'Completed', status && !/^completed$/i.test(status) ? status : '');
                    } else {
                        text.textContent = status;
                    }
                }
            }

            let __prevUpdating = null;
            function handleProgressSnapshot(snapshot) {
                if (!snapshot || !Array.isArray(snapshot.components)) return;
                snapshot.components.forEach(updateProgressRow);
                setButtonsDisabled(snapshot.updating);
                // When an update run transitions from active -> idle, refresh the page
                if (__prevUpdating === true && snapshot.updating === false) {
                    // Small delay to let UI show Completed state
                    setTimeout(() => { window.location.reload(); }, 600);
                }
                __prevUpdating = !!snapshot.updating;
                if (!snapshot.updating && pollTimer) { clearInterval(pollTimer); pollTimer = null; }
            }

            function fetchProgress() {
                fetch('/update/progress', { headers: { 'Accept': 'application/json' }, credentials: 'same-origin' })
                    .then((res) => res.ok ? res.json() : null)
                    .then(handleProgressSnapshot)
                    .catch(() => {});
            }

            function ensurePolling() {
                if (!pollTimer) pollTimer = setInterval(fetchProgress, 2000);
            }

            // Async populate of versions table to speed initial paint
            let __versionsLoaded = false;
            function populateVersions(data){
                const map = [
                    ['ver-steamcmd-deployed','steamcmd_deployed'],
                    ['ver-steamcmd-latest','steamcmd_latest'],
                    ['ver-release-deployed','release_deployed'],
                    ['ver-release-latest','release_latest'],
                    ['ver-beta-deployed','beta_deployed'],
                    ['ver-beta-latest','beta_latest'],
                    ['ver-bepinex-deployed','bepinex_deployed'],
                    ['ver-bepinex-latest','bepinex_latest'],
                    ['ver-launchpad-deployed','launchpad_deployed'],
                    ['ver-launchpad-latest','launchpad_latest'],
                    ['ver-scon-deployed','scon_deployed'],
                    ['ver-scon-latest','scon_latest']
                ];
                map.forEach(([id,key])=>{ const el=document.getElementById(id); if(el && key in data){ el.textContent = data[key] || ''; } });
                // Update button colors based on equality
                function setBtnColor(name, deployedKey, latestKey){
                    const btn = document.querySelector('button[data-component="'+name+'"]');
                    if (!btn) return;
                    btn.classList.remove('btn-success','btn-danger');
                    if ((data[deployedKey]||'') === (data[latestKey]||'')) btn.classList.add('btn-success'); else btn.classList.add('btn-danger');
                }
                setBtnColor('steamcmd','steamcmd_deployed','steamcmd_latest');
                setBtnColor('release','release_deployed','release_latest');
                setBtnColor('beta','beta_deployed','beta_latest');
                setBtnColor('bepinex','bepinex_deployed','bepinex_latest');
                setBtnColor('launchpad','launchpad_deployed','launchpad_latest');
                setBtnColor('scon','scon_deployed','scon_latest');
                __versionsLoaded = true;
                try { window.__versionsPrimaryLoaded = true; } catch(_) {}
                try { console.debug('[SDSM] Versions loaded (primary).'); } catch(_) {}
            }
            function fetchVersions(retryCount){
                const tries = typeof retryCount === 'number' ? retryCount : 0;
                fetch('/api/manager/versions', { headers:{'Accept':'application/json'}, credentials:'same-origin', cache:'no-store' })
                  .then(r=> r.ok ? r.json() : Promise.reject(new Error('bad status '+r.status)))
                  .then(populateVersions)
                  .catch((err)=>{
                      try { console.error('[SDSM] Versions fetch failed (primary)', err); } catch(_) {}
                      if (window && typeof window.showToast === 'function' && tries >= 2) {
                          window.showToast({ type: 'error', title: 'Version Load Failed', message: 'Could not fetch component versions.' });
                      }
                      if (tries < 3) {
                          setTimeout(()=>fetchVersions(tries+1), 500 * (tries+1));
                      } else {
                          // Final fallback: mark cells as unavailable
                          const ids = ['ver-steamcmd-deployed','ver-steamcmd-latest','ver-release-deployed','ver-release-latest','ver-beta-deployed','ver-beta-latest','ver-bepinex-deployed','ver-bepinex-latest','ver-launchpad-deployed','ver-launchpad-latest','ver-scon-deployed','ver-scon-latest'];
                          ids.forEach(id=>{ const el=document.getElementById(id); if(el && (el.textContent==='Loading…' || el.textContent==='Loading...')){ el.textContent='Unavailable'; }});
                      }
                  });
            }

            // Manager-level Language removed; languages are configured per server.

            document.addEventListener('DOMContentLoaded', () => {
                const buttons = Array.from(document.querySelectorAll('.update-trigger'));
                const configForm = document.getElementById('configForm');
                const configBtn = document.getElementById('updateConfigBtn');
                const shutdownBtn = document.getElementById('shutdownBtn');
                const restartBtn = document.getElementById('restartBtn');
                // If an update was already in progress when the page rendered (template .updating == true),
                // begin polling progress immediately so the UI will auto-refresh when it completes.
                const initialUpdating = {{if .updating}}true{{else}}false{{end}};
                if (initialUpdating) {
                    try { __prevUpdating = true; } catch(_) {}
                    fetchProgress();
                    ensurePolling();
                }
                const stopAllBtn = document.getElementById('stopAllBtn');
                


                // Wire up update buttons
                buttons.forEach((btn) => {
                    btn.addEventListener('click', (event) => {
                        event.preventDefault();
                        if (btn.disabled) return;

                        const target = btn.dataset.updateTarget;
                        if (!target) return;

                        const params = new URLSearchParams();
                        params.append(target, '1');

                        setButtonsDisabled(true);
                        showButtonSpinner(btn, true);
                        showMessage('Starting update...', false);

                        fetch('/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-Requested-With': 'XMLHttpRequest',
                                'Accept': 'application/json'
                            },
                            credentials: 'same-origin',
                            body: params.toString()
                        })
                            .then((res) => { showToastFromHeaders(res); if (!res.ok) { return res.json().then((data) => Promise.reject(data)); } return res.json(); })
                            .then((data) => {
                                if (data && data.status === 'started') {
                                    const label = btn.closest('tr')?.querySelector('.component-title')?.textContent?.trim() || 'Update';
                                    showMessage(label + ' started...', false);
                                    fetchProgress();
                                    ensurePolling();
                                } else if (data && data.status === 'ok') {
                                    showMessage('Configuration updated.', false);
                                    setButtonsDisabled(false);
                                } else {
                                    showMessage('', false);
                                    setButtonsDisabled(false);
                                }
                            })
                            .catch((err) => {
                                const errorText = err && err.error ? err.error : 'Unable to start update. Please try again.';
                                showMessage(errorText, true);
                                setButtonsDisabled(false);
                                fetchProgress();
                            });
                    });
                });

            // Async submit for Configuration form with inline spinner
            if (configForm && configBtn) {
                configForm.addEventListener('submit', (event) => {
                    event.preventDefault();
                    if (configBtn.disabled) return;

                    const fd = new FormData(configForm);
                    const params = new URLSearchParams();
                    for (const [key, value] of fd.entries()) {
                        params.append(key, typeof value === 'string' ? value : String(value));
                    }
                    if (!params.has('update_config')) params.append('update_config', '1');

                    configBtn.disabled = true;
                    showButtonSpinner(configBtn, true);
                    showMessage('Saving configuration…', false);

                    fetch('/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                            'X-Requested-With': 'XMLHttpRequest',
                            'Accept': 'application/json'
                        },
                        credentials: 'same-origin',
                        body: params.toString()
                    })
                        .then((res) => { showToastFromHeaders(res); if (!res.ok) { return res.json().then((data) => Promise.reject(data)); } return res.json(); })
                        .then((data) => {
                            if (data && (data.status === 'ok' || data.status === 'updated')) {
                                showMessage('Configuration updated.', false);
                                // Refresh versions table if placeholders present or after config change
                                try { if (typeof fetchVersions === 'function') fetchVersions(); } catch(_) {}
                            } else {
                                showMessage('Configuration updated.', false);
                                try { if (typeof fetchVersions === 'function') fetchVersions(); } catch(_) {}
                            }
                        })
                        .catch((err) => {
                            const errorText = err && err.error ? err.error : 'Unable to save configuration. Please try again.';
                            showMessage(errorText, true);
                            if (window.showToast) window.showToast({ type: 'error', title: 'Save Failed', message: errorText });
                        })
                        .finally(() => {
                            configBtn.disabled = false;
                            showButtonSpinner(configBtn, false);
                        });
                });
            }

            // Footer actions: Shutdown / Restart with async POSTs and spinners
            function disableFooterButtons(disabled) {
                if (shutdownBtn) shutdownBtn.disabled = disabled;
                if (restartBtn) restartBtn.disabled = disabled;
                if (!disabled) {
                    if (shutdownBtn) showButtonSpinner(shutdownBtn, false);
                    if (restartBtn) showButtonSpinner(restartBtn, false);
                }
            }

            function postFooterAction(kind, btn, confirmingText, startedText, successText, errorText) {
                if (!btn) return;

                const danger = (kind === 'shutdown' || kind === 'restart');
                askConfirm({ title: 'Confirm', message: confirmingText, confirmText: 'Confirm', cancelText: 'Cancel', danger }, confirmingText)
                    .then((ok) => {
                        if (!ok) return;

                        const params = new URLSearchParams();
                        params.append(kind, '1');

                        disableFooterButtons(true);
                        showButtonSpinner(btn, true);
                        showMessage(startedText, false);

                        fetch('/update', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                                'X-Requested-With': 'XMLHttpRequest',
                                'Accept': 'application/json'
                            },
                            credentials: 'same-origin',
                            body: params.toString()
                        })
                            .then((res) => { showToastFromHeaders(res); if (!res.ok) { return res.json().then((data) => Promise.reject(data)); } return res.json().catch(() => ({})); })
                            .then(() => {
                                showMessage(successText, false);
                                setTimeout(() => disableFooterButtons(false), 3000);
                            })
                            .catch((err) => {
                                const e = err && err.error ? err.error : errorText;
                                showMessage(e, true);
                                if (window.showToast) window.showToast({ type: 'error', title: 'Request Failed', message: e });
                                disableFooterButtons(false);
                            });
                    });
            }

            if (shutdownBtn) {
                shutdownBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    // If detached servers is enabled and any server is running, prompt the user
                    const detachedEnabled = document.body.getAttribute('data-detached') === 'true';
                    const runningCountEl = document.getElementById('server-count-running');
                    const runningCount = runningCountEl ? parseInt(runningCountEl.textContent || '0', 10) : 0;
                    if (detachedEnabled && runningCount > 0) {
                        askConfirm({ title: 'Shutdown', message: 'Servers are running and detached mode is enabled. Stop all servers as well?', confirmText: 'Stop Servers', cancelText: 'Do Not Stop', danger: true }, 'Servers are running and detached mode is enabled. Stop all servers as well?')
                          .then((alsoStop) => {
                              const params = new URLSearchParams();
                              params.append('shutdown', '1');
                              params.append('stop_servers', alsoStop ? '1' : '0');
                              disableFooterButtons(true);
                              showButtonSpinner(shutdownBtn, true);
                              showMessage('Shutting down SDSM…', false);
                              fetch('/shutdown', {
                                  method: 'POST',
                                  headers: {
                                      'Content-Type': 'application/x-www-form-urlencoded',
                                      'X-Requested-With': 'XMLHttpRequest',
                                      'Accept': 'application/json'
                                  },
                                  credentials: 'same-origin',
                                  body: params.toString()
                              }).then((res) => { showToastFromHeaders(res); if (!res.ok) { return res.json().then((d)=>Promise.reject(d)); } return res.json().catch(()=>({})); })
                              .then(()=>{ showMessage('Shutdown initiated. The UI may go offline shortly.', false); setTimeout(()=>disableFooterButtons(false), 3000); })
                              .catch((err)=>{ const e = err && err.error ? err.error : 'Unable to shutdown SDSM. Please try again.'; showMessage(e, true); if (window.showToast) window.showToast({type:'error', title:'Request Failed', message:e}); disableFooterButtons(false); });
                          });
                        return;
                    }
                    postFooterAction(
                        'shutdown',
                        shutdownBtn,
                        (detachedEnabled
                            ? 'Are you sure you want to shutdown SDSM? Detached mode is enabled; no servers will be stopped.'
                            : 'Are you sure you want to shutdown SDSM? All servers will be stopped.'),
                        'Shutting down SDSM…',
                        'Shutdown initiated. The UI may go offline shortly.',
                        'Unable to shutdown SDSM. Please try again.'
                    );
                });
            }

            if (restartBtn) {
                restartBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    postFooterAction(
                        'restart',
                        restartBtn,
                        'Are you sure you want to restart SDSM? All servers will be temporarily stopped.',
                        'Restarting SDSM…',
                        'Restart initiated. The UI will reconnect when available.',
                        'Unable to restart SDSM. Please try again.'
                    );
                });
            }

            // Stop All Servers (bulk stop) with dynamic enable/disable
            if (stopAllBtn) {
                function updateStopAllDisabled() {
                    const runningCountEl = document.getElementById('server-count-running');
                    const currentRunning = runningCountEl ? parseInt(runningCountEl.textContent || '0', 10) : 0;
                    // Disabled if none running or an update is in progress
                    const anyUpdateDisabled = !!document.querySelector('.update-trigger[disabled]');
                    stopAllBtn.disabled = currentRunning === 0 || anyUpdateDisabled;
                }
                function pollActiveServers(){
                    fetch('/api/stats', { headers:{'Accept':'application/json'}, credentials:'same-origin', cache:'no-store' })
                      .then(r => r.ok ? r.json() : null)
                      .then(data => { if (data && typeof data.activeServers === 'number') {
                          const el = document.getElementById('server-count-running');
                          if (el) el.textContent = String(data.activeServers);
                          updateStopAllDisabled();
                      }}).catch(()=>{});
                }
                // Initial state
                updateStopAllDisabled();
                // Poll every 15s
                setInterval(pollActiveServers, 15000);
                stopAllBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (stopAllBtn.disabled) return;
                    const runningCountEl = document.getElementById('server-count-running');
                    const currentRunning = runningCountEl ? parseInt(runningCountEl.textContent || '0', 10) : 0;
                    if (currentRunning === 0) {
                        if (window.showToast) window.showToast({ type: 'info', title: 'No Servers', message: 'There are no running servers to stop.' });
                        return;
                    }
                    askConfirm({ title: 'Stop All Servers', message: 'Stop ALL running servers? Active processes will be terminated.', confirmText: 'Stop All', cancelText: 'Cancel', danger: true }, 'Stop ALL running servers? Active processes will be terminated.')
                      .then((ok) => {
                        if (!ok) return;
                        stopAllBtn.disabled = true;
                    showButtonSpinner(stopAllBtn, true);
                    fetch('/api/servers/stop-all', {
                        method: 'POST',
                        headers: { 'Accept': 'application/json' },
                        credentials: 'same-origin'
                    })
                    .then(res => { showToastFromHeaders(res); if (!res.ok) { return res.json().then(d => Promise.reject(d)); } return res.json(); })
                    .then(data => {
                        const stopped = data && typeof data.stopped === 'number' ? data.stopped : currentRunning;
                        if (runningCountEl) runningCountEl.textContent = '0';
                        if (window.showToast && stopped >= 0) window.showToast({ type: 'success', title: 'Stopped', message: 'Stopped ' + stopped + ' servers.' });
                        updateStopAllDisabled();
                    })
                    .catch(err => {
                        const msg = err && err.error ? err.error : 'Failed to stop servers.';
                        if (window.showToast) window.showToast({ type: 'error', title: 'Stop Failed', message: msg });
                    })
                    .finally(() => {
                        updateStopAllDisabled();
                        showButtonSpinner(stopAllBtn, false);
                        });
                      });
                });
            }

            // User Management collapsible toggle
            (function(){
                const toggle = document.getElementById('userMgmtToggle');
                const content = document.getElementById('userMgmtContent');
                const chevron = document.getElementById('userMgmtChevron');
                const label = document.getElementById('userMgmtToggleLabel');
                if (!toggle || !content || !chevron) {
                    // Card may not be present in some builds
                } else {
                    const storageKey = 'sdsm:manager:user-mgmt:expanded';
                    const setExpanded = (expanded) => {
                        toggle.setAttribute('aria-expanded', expanded ? 'true' : 'false');
                        content.setAttribute('aria-hidden', expanded ? 'false' : 'true');
                        content.classList.toggle('hidden', !expanded);
                        chevron.innerHTML = expanded
                            ? '<polyline points="18 15 12 9 6 15"></polyline>' // up
                            : '<polyline points="6 9 12 15 18 9"></polyline>'; // down
                        if (label) label.textContent = expanded ? 'Less' : 'More';
                        toggle.title = expanded ? 'Collapse' : 'Expand';
                        try { sessionStorage.setItem(storageKey, expanded ? '1' : '0'); } catch(_) {}
                    };
                    let initial = '0';
                    try { initial = sessionStorage.getItem(storageKey) || '0'; } catch(_) {}
                    setExpanded(initial === '1');
                    toggle.addEventListener('click', () => {
                        const isExpanded = toggle.getAttribute('aria-expanded') === 'true';
                        setExpanded(!isExpanded);
                    });
                }
            })();

            // User Management logic
            (function(){
                const tbody = document.getElementById('um_table_body');
                const addBtn = document.getElementById('um_add_btn');
                const newUser = document.getElementById('um_new_username');
                const newPass = document.getElementById('um_new_password');
                const newRole = document.getElementById('um_new_role');
                const accessBtn = document.getElementById('um_access_btn');
                const accessDrop = document.getElementById('um_access_dropdown');
                const accessAll = document.getElementById('um_access_all');
                const accessList = document.getElementById('um_access_list');
                const accessSave = document.getElementById('um_access_save');
                const accessClose = document.getElementById('um_access_close');
                if(!tbody) return;

                let listBusy = false;
                let serversCache = null;
                let usersData = [];
                let sortState = { key: 'username', dir: 'asc' };
                let newAssignAll = false;
                let newAssignServers = new Set();

                function ensureServersCache(){
                    if (serversCache) return Promise.resolve(serversCache);
                    return fetch('/api/servers', {headers:{'Accept':'application/json'}, credentials:'same-origin'})
                        .then(r => r.ok ? r.json() : Promise.reject())
                        .then(data => { serversCache = Array.isArray(data.servers) ? data.servers : []; return serversCache; })
                        .catch(()=>{ serversCache = []; return serversCache; });
                }

                function openAssignPanel(username){
                    const row = Array.from(tbody.querySelectorAll('tr')).find(tr => tr.firstChild && tr.firstChild.textContent === username);
                    if (!row) return;
                    let panelRow = row.nextElementSibling;
                    const isPanel = panelRow && panelRow.classList && panelRow.classList.contains('um-assign-panel');
                    if (!isPanel) {
                        panelRow = document.createElement('tr');
                        panelRow.className = 'um-assign-panel';
                        const td = document.createElement('td'); td.colSpan = 4; td.className = 'assign-panel-cell';
                        td.innerHTML = '<div><strong>Server Access</strong><div class="form-group mt-2"><label class="inline-flex items-center gap-2"><input type="checkbox" id="assign_all_'+username+'"> All servers</label></div><div id="assign_list_'+username+'" class="assign-list mt-2"></div><div class="mt-2"><button class="btn btn-primary" id="assign_save_'+username+'">Save</button> <button class="btn btn-secondary" id="assign_close_'+username+'">Close</button></div></div>';
                        panelRow.appendChild(td);
                        row.insertAdjacentElement('afterend', panelRow);
                    }

                    panelRow.style.display = panelRow.style.display === 'none' ? '' : '';

                    ensureServersCache().then(() => {
                        // Populate server checkboxes
                        const list = panelRow.querySelector('#assign_list_'+CSS.escape(username)+'' );
                        const chkAll = panelRow.querySelector('#assign_all_'+CSS.escape(username)+'' );
                        const btnSave = panelRow.querySelector('#assign_save_'+CSS.escape(username)+'' );
                        const btnClose = panelRow.querySelector('#assign_close_'+CSS.escape(username)+'' );
                        if (!list || !chkAll || !btnSave || !btnClose) return;

                        list.innerHTML = '';
                        serversCache.forEach(s => {
                            const lbl = document.createElement('label'); lbl.className = 'assign-chip';
                            const cb = document.createElement('input'); cb.type='checkbox'; cb.value=String(s.id); cb.className='assign-cb';
                            const span = document.createElement('span'); span.textContent = s.name + ' (#'+s.id+')';
                            lbl.appendChild(cb); lbl.appendChild(span);
                            list.appendChild(lbl);
                        });

                        function setListEnabled(enabled){
                            list.querySelectorAll('.assign-cb').forEach((el)=>{ el.disabled = !enabled; });
                        }

                        // Load current assignments
                        fetch('/api/users/'+encodeURIComponent(username)+'/assignments', {headers:{'Accept':'application/json'}, credentials:'same-origin'})
                          .then(r=> r.ok ? r.json() : { all:false, servers:[] })
                          .then(data => {
                              const all = !!data.all; const servers = Array.isArray(data.servers) ? data.servers.map(Number) : [];
                              chkAll.checked = all;
                              setListEnabled(!all);
                              list.querySelectorAll('.assign-cb').forEach((cb)=>{ const id = Number(cb.value); cb.checked = servers.includes(id); });
                          });

                        chkAll.addEventListener('change', ()=> setListEnabled(!chkAll.checked));
                        btnClose.addEventListener('click', ()=> { panelRow.style.display='none'; });
                        btnSave.addEventListener('click', ()=>{
                            const all = chkAll.checked;
                            const selected = Array.from(list.querySelectorAll('.assign-cb')).filter(cb=>cb.checked).map(cb=>Number(cb.value));
                            fetch('/api/users/'+encodeURIComponent(username)+'/assignments', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify({ all, servers: selected }) })
                              .then(r=> r.ok ? r.json() : r.json().then(Promise.reject))
                              .then(()=>{ if(window.showToast) window.showToast({type:'success', title:'Assignments Saved', message:'Updated access for '+username}); })
                              .catch(err=>{ if(window.showToast) window.showToast({type:'error', title:'Save Failed', message:(err&&err.error)||'Unable to save assignments'}); });
                        });
                    });
                }

                function positionDropdown(anchor, panel){
                    if (!anchor || !panel) return;
                    panel.style.visibility = 'hidden';
                    panel.style.display = 'block';
                    const rect = anchor.getBoundingClientRect();
                    const menuWidth = panel.offsetWidth;
                    const padding = 6;
                    // Align to the right edge of the button
                    let left = Math.round(rect.right - menuWidth);
                    let top = Math.round(rect.bottom + padding);
                    const vw = window.innerWidth; const vh = window.innerHeight;
                    if (left + menuWidth > vw - 8) left = Math.max(8, vw - menuWidth - 8);
                    if (left < 8) left = 8;
                    if (top > vh - 8) top = Math.max(8, rect.top - panel.offsetHeight - padding);
                    panel.style.left = left + 'px';
                    panel.style.top = top + 'px';
                    panel.style.visibility = '';
                }

                function openAccessDropdown(){
                    if (!accessDrop) return;
                    ensureServersCache().then(() => {
                        accessList.innerHTML = '';
                        serversCache.forEach(s => {
                            const lbl = document.createElement('label'); lbl.className='assign-chip';
                            const cb = document.createElement('input'); cb.type='checkbox'; cb.value=String(s.id); cb.checked = newAssignServers.has(Number(s.id)); cb.disabled = newAssignAll; cb.className='um-new-assign-cb';
                            cb.addEventListener('change', ()=>{ const id = Number(cb.value); if (cb.checked) newAssignServers.add(id); else newAssignServers.delete(id); });
                            const span = document.createElement('span'); span.textContent = s.name + ' (#'+s.id+')';
                            lbl.appendChild(cb); lbl.appendChild(span);
                            accessList.appendChild(lbl);
                        });
                        if (accessAll) {
                            accessAll.checked = newAssignAll;
                            accessAll.onchange = () => {
                                newAssignAll = accessAll.checked;
                                accessList.querySelectorAll('.um-new-assign-cb').forEach(el => { el.disabled = newAssignAll; });
                            };
                        }
                        accessDrop.classList.remove('hidden');
                        positionDropdown(accessBtn, accessDrop);
                        function onDocClick(evt){
                            if (!accessDrop.contains(evt.target) && evt.target !== accessBtn && !accessBtn.contains(evt.target)) {
                                closeAccessDropdown();
                                document.removeEventListener('mousedown', onDocClick);
                                window.removeEventListener('resize', onResize);
                                window.removeEventListener('scroll', onResize, { passive: true });
                            }
                        }
                        function onResize(){ positionDropdown(accessBtn, accessDrop); }
                        document.addEventListener('mousedown', onDocClick);
                        window.addEventListener('resize', onResize);
                        window.addEventListener('scroll', onResize, { passive: true });
                    });
                }

                function closeAccessDropdown(){ if (accessDrop) accessDrop.classList.add('hidden'); }

                if (accessBtn) accessBtn.addEventListener('click', () => { if (!accessDrop.classList.contains('hidden')) closeAccessDropdown(); else openAccessDropdown(); });
                if (accessClose) accessClose.addEventListener('click', closeAccessDropdown);
                if (accessSave) accessSave.addEventListener('click', () => { closeAccessDropdown(); });

                function sortUsers(arr){
                    const k = sortState.key; const dir = sortState.dir === 'asc' ? 1 : -1;
                    const copy = arr.slice();
                    copy.sort((a,b)=>{
                        const av = (a[k] ?? '').toString().toLowerCase();
                        const bv = (b[k] ?? '').toString().toLowerCase();
                        if (av < bv) return -1*dir; if (av > bv) return 1*dir; return 0;
                    });
                    return copy;
                }

                function renderUsers(users){
                    tbody.innerHTML = '';
                    if(!Array.isArray(users) || users.length === 0){
                        const tr = document.createElement('tr');
                        const td = document.createElement('td');
                        td.colSpan = 4;
                        td.textContent = 'No users found.';
                        tr.appendChild(td); tbody.appendChild(tr); return;
                    }
                    sortUsers(users).forEach(u => {
                        const tr = document.createElement('tr');
                        const tdU = document.createElement('td'); tdU.textContent = u.username; tr.appendChild(tdU);
                        const tdR = document.createElement('td');
                        const sel = document.createElement('select'); sel.className='form-input-inline w-140';
                        ['admin','operator'].forEach(r => {
                            const opt = document.createElement('option'); opt.value=r; opt.textContent=r.charAt(0).toUpperCase()+r.slice(1);
                            if(String(u.role).toLowerCase()===r) opt.selected=true; sel.appendChild(opt);
                        });
                        sel.addEventListener('change', () => updateRole(u.username, sel.value));
                        tdR.appendChild(sel); tr.appendChild(tdR);
                        const tdC = document.createElement('td'); tdC.textContent = (u.created_at ? new Date(u.created_at).toLocaleString() : ''); tr.appendChild(tdC);
                        const tdA = document.createElement('td');
                        // Reset password button
                        const btnPw = document.createElement('button'); btnPw.className='btn btn-secondary'; btnPw.textContent='Set Password';
                        btnPw.addEventListener('click', () => {
                            const p = prompt('Enter new password for '+u.username+':');
                            if(p && p.length>=8){ resetPassword(u.username, p); }
                            else if(p!==null){ if(window.showToast) window.showToast({type:'error', title:'Invalid', message:'Password must be at least 8 characters.'}); }
                        });
                        tdA.appendChild(btnPw);
                        // Delete button
                                                const btnDel = document.createElement('button'); btnDel.className='btn btn-danger ml-2'; btnDel.textContent='Delete';
                                                btnDel.addEventListener('click', () => {
                                                        askConfirm({ title: 'Delete User', message: 'Delete user '+u.username+'?', confirmText: 'Delete', cancelText: 'Cancel', danger: true }, 'Delete user '+u.username+'?')
                                                            .then((ok) => { if (ok) deleteUser(u.username); });
                                                });
                        tdA.appendChild(btnDel);
                        // Assignments button (operators only)
                        const isOperator = String(u.role).toLowerCase() === 'operator';
                        if (isOperator) {
                            const btnAssign = document.createElement('button'); btnAssign.className='btn btn-secondary ml-2'; btnAssign.textContent='Assign Servers'; btnAssign.title='Manage server access for this operator';
                            btnAssign.addEventListener('click', () => openAssignPanel(u.username));
                            tdA.appendChild(btnAssign);
                        }
                        tr.appendChild(tdA);
                        tbody.appendChild(tr);
                    });
                }

                function fetchUsers(){
                    if(listBusy) return; listBusy = true;
                    const url = '/api/users';
                    fetch(url, {headers:{'Accept':'application/json'}, credentials:'same-origin'})
                        .then(r => r.ok ? r.json() : Promise.reject())
                        .then(data => { usersData = Array.isArray(data.users)? data.users : []; renderUsers(usersData); })
                        .catch(()=>{})
                        .finally(()=>{ listBusy=false; });
                }

                function updateRole(username, role){
                    fetch('/api/users/'+encodeURIComponent(username)+'/role', {
                        method:'PATCH', credentials:'same-origin', headers:{'Content-Type':'application/json','Accept':'application/json'},
                        body: JSON.stringify({role})
                    }).then(r => r.ok ? r.json() : r.json().then(Promise.reject))
                      .then(()=>{ if(window.showToast) window.showToast({type:'success', title:'Role Updated', message: username+" → "+role}); fetchUsers(); })
                      .catch(err=>{ if(window.showToast) window.showToast({type:'error', title:'Update Failed', message: (err&&err.error)||'Unable to update role'}); fetchUsers(); });
                }

                function resetPassword(username, password){
                    fetch('/api/users/'+encodeURIComponent(username)+'/reset-password', {
                        method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','Accept':'application/json'},
                        body: JSON.stringify({password})
                    }).then(r => r.ok ? r.json() : r.json().then(Promise.reject))
                      .then(()=>{ if(window.showToast) window.showToast({type:'success', title:'Password Set', message: 'Password updated for '+username}); })
                      .catch(err=>{ if(window.showToast) window.showToast({type:'error', title:'Set Failed', message: (err&&err.error)||'Unable to set password'}); });
                }

                function deleteUser(username){
                    fetch('/api/users/'+encodeURIComponent(username), { method:'DELETE', credentials:'same-origin', headers:{'Accept':'application/json'} })
                      .then(r => r.ok ? r.json() : r.json().then(Promise.reject))
                      .then(()=>{ if(window.showToast) window.showToast({type:'success', title:'User Deleted', message: username}); fetchUsers(); })
                      .catch(err=>{ if(window.showToast) window.showToast({type:'error', title:'Delete Failed', message: (err&&err.error)||'Unable to delete user'}); fetchUsers(); });
                }

                if(addBtn && newUser && newPass && newRole){
                    addBtn.addEventListener('click', () => {
                        const u = newUser.value.trim(); const p = newPass.value; const r = newRole.value;
                        if(u.length < 3){ if(window.showToast) window.showToast({type:'error', title:'Invalid', message:'Username must be at least 3 characters.'}); return; }
                        if(p.length < 8){ if(window.showToast) window.showToast({type:'error', title:'Invalid', message:'Password must be at least 8 characters.'}); return; }
                        addBtn.disabled = true;
                        fetch('/api/users', {
                            method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','Accept':'application/json'},
                            body: JSON.stringify({username:u, password:p, role:r})
                        }).then(r => r.ok ? r.json() : r.json().then(Promise.reject))
                          .then(()=>{
                              const doAssign = (r === 'operator');
                              const payload = { all: newAssignAll, servers: Array.from(newAssignServers) };
                              const assign = doAssign ? fetch('/api/users/'+encodeURIComponent(u)+'/assignments', { method:'POST', credentials:'same-origin', headers:{'Content-Type':'application/json','Accept':'application/json'}, body: JSON.stringify(payload) }) : Promise.resolve();
                              return assign.then(() => {
                                  if(window.showToast) window.showToast({type:'success', title:'User Added', message: u});
                                  newUser.value=''; newPass.value=''; newRole.value='operator';
                                  newAssignAll = false; newAssignServers.clear(); closeAccessDropdown();
                                  fetchUsers();
                              });
                          })
                          .catch(err=>{ if(window.showToast) window.showToast({type:'error', title:'Add Failed', message: (err&&err.error)||'Unable to add user'}); })
                          .finally(()=>{ addBtn.disabled = false; });
                    });
                }
                // Toggle server access control visibility by role (optional UX)
                if (newRole && accessBtn) {
                    const updateAccessVisibility = () => {
                        const isOp = newRole.value === 'operator';
                        accessBtn.classList.toggle('hidden', !isOp);
                        if (!isOp) closeAccessDropdown();
                    };
                    newRole.addEventListener('change', updateAccessVisibility);
                    updateAccessVisibility();
                }

                // Sorting handlers
                document.querySelectorAll('th.um-sort').forEach(th => {
                    th.addEventListener('click', () => {
                        const key = th.dataset.key;
                        if (sortState.key === key) sortState.dir = (sortState.dir === 'asc') ? 'desc' : 'asc';
                        else { sortState.key = key; sortState.dir = 'asc'; }
                        renderUsers(usersData);
                    });
                });
                // Initial load
                fetchUsers();
            })();

            // Initial progress fetch
            fetchProgress();
            ensurePolling();
            }); // DOMContentLoaded end
        })();
    </script>
</head>

<body class="page-shell" data-detached="{{if .detached}}true{{else}}false{{end}}">
    <div id="connectionBanner" class="connection-banner" role="status" aria-live="polite">
        <span id="connectionBannerText">Connection lost. Attempting to reconnect...</span>
        <button type="button" id="connectionBannerAction">Reload</button>
    </div>
    
    <div class="container">
    <header class="hero-card">
        <div class="hero-main">
            <img src="/sdsm.png" alt="SDSM logo" class="hero-logo" width="72" height="72">
            <div class="hero-heading">
                <h1 class="hero-title">Server Manager</h1>
                <p class="hero-subtitle">Configure and update your Stationeers servers.</p>
            </div>
        </div>
        <div class="hero-meta">
            <div class="hero-meta-title">Fleet Overview</div>
            <p class="hero-meta-text">
                <span id="header-total-servers">--</span> server<span id="header-total-servers-suffix">s</span> tracked •
                <span id="header-active-servers">--</span> active •
                <span id="header-total-players">--</span> players
            </p>
            <span class="pill">Last refresh: <span id="last-refresh">just now</span></span>
        </div>
        <div class="hero-actions flex-col items-end">
            <div class="row wrap">
            <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                <span id="theme-icon">🌙</span>
            </button>
            <button
                class="btn btn-primary"
                hx-get="/api/refresh"
                hx-trigger="click"
                hx-indicator="#manager-refresh-indicator"
                hx-swap="none"
            >
                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" aria-hidden="true">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10"></path>
                    <path d="M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                <span id="manager-refresh-indicator" class="hidden">⟳</span>
                Refresh
            </button>
            <a href="/dashboard" class="btn btn-primary" title="Go to Dashboard">
                {{ template "icon_dashboard" . }}
                Dashboard
            </a>
            {{ template "user_menu" . }}
            </div>
            <span class="build-meta">{{buildTime}}</span>
        </div>
    </header>
    </div>

    <main class="container">
        {{ if .game_data_warnings }}
        {{ if gt (len .game_data_warnings) 0 }}
        <div class="alert alert-warning mb-4" role="status" aria-live="polite">
            <div class="alert-icon" aria-hidden="true">
                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="10"></circle>
                    <line x1="12" y1="8" x2="12" y2="12"></line>
                    <line x1="12" y1="16" x2="12" y2="16"></line>
                </svg>
            </div>
            <div class="alert-content">
                <div class="alert-title">Game data missing</div>
                <ul class="alert-message m-0 pl-5">
                    {{ range .game_data_warnings }}
                    <li>{{ . }}</li>
                    {{ end }}
                </ul>
            </div>
        </div>
        {{ end }}
        {{ end }}
        <div class="manager-content">
            <div class="manager-grid">
                <div class="glass-card">
                    <h3>Configuration</h3>
                    <form id="configForm" class="config-form" action="/update" method="POST">
                        <div class="form-group">
                            <label for="steam_id">Steam ID</label>
                            <input type="text" id="steam_id" name="steam_id" value="{{ .steam_id }}" required>
                        </div>
                        <div class="form-group">
                            <label for="port">Port</label>
                            <input type="text" id="port" name="port" value="{{ .port }}" required>
                        </div>
                        <div class="form-group">
                            <label for="root_path">Root Path</label>
                            <input type="text" id="root_path" name="root_path" value="{{ .root_path }}" required>
                        </div>
                        <div class="form-group">
                            <label for="auto_update">Auto Update Time</label>
                            <input type="text" id="auto_update" name="auto_update" value="{{ .auto_update }}" required>
                        </div>
                        <div class="form-group">
                            <label for="start_update">Update at Start</label>
                            <div class="field-inline items-start gap-2">
                                <input type="checkbox" id="start_update" name="start_update" class="form-checkbox" {{if .start_update}}checked{{end}}>
                                <span class="text-secondary text-sm flex-1" aria-live="polite">
                                    When enabled, SDSM will check and apply updates automatically on startup.
                                </span>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="detached_servers">Detached Servers (keep running if SDSM exits)</label>
                            <div class="field-inline items-start gap-2">
                                <input type="checkbox" id="detached_servers" name="detached_servers" class="form-checkbox" {{if .detached}}checked{{end}}>
                                <span class="text-secondary text-sm flex-1" aria-live="polite">
                                    When enabled, servers are started in a separate process group and will continue running if SDSM is stopped. Environment variable <code>SDSM_DETACHED_SERVERS</code> may override this at runtime.
                                </span>
                            </div>
                        </div>
                        <div class="form-group form-row-full">
                            <button id="updateConfigBtn" type="submit" name="update_config" class="btn btn-primary" {{if .updating}}disabled{{end}}>
                                <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"></path>
                                    <polyline points="17 21 17 13 7 13 7 21"></polyline>
                                    <polyline points="7 3 7 8 15 8"></polyline>
                                </svg>
                                Update Config
                            </button>
                        </div>
                    </form>
                    <div class="note">
                        <strong>Note:</strong> After updating the configuration, SDSM may restart so changes can take effect.
                    </div>
                </div>

                <div class="glass-card">
                    {{/* Always render versions section; rely on dynamic polling instead of full hide to keep buttons re-enabled post-load. */}}
                    {{/* If updating, we'll disable buttons but keep table visible for user feedback. */}}
                    <div id="versions" data-initial-updating="{{if .updating}}true{{else}}false{{end}}">
                        {{/* Legacy conditional wrapper removed (was: if not .updating) */}}
                        <h3>Software Versions</h3>
                        <form action="/update" method="POST" id="updateForm">
                            <div id="updateMessage" class="update-message" role="status" aria-live="polite"></div>
                            <div class="table-container">
                                <table>
                                    <thead>
                                        <tr>
                                            <th>Component</th>
                                            <th>Deployed</th>
                                            <th>Latest</th>
                                            <th>Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        
                                        <tr>
                                            <td>
                                                <div class="component-title">steamcmd</div>
                                                <div class="progress-row" data-progress="steamcmd">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td id="ver-steamcmd-deployed">Loading…</td>
                                            <td id="ver-steamcmd-latest">Loading…</td>
                                            <td>
                                                <button type="submit" name="update_steamcmd" data-update-target="update_steamcmd" data-component="steamcmd" class="btn btn-secondary update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="component-title">rocketstation_DedicatedServer Release</div>
                                                <div class="progress-row" data-progress="release">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td id="ver-release-deployed">Loading…</td>
                                            <td id="ver-release-latest">Loading…</td>
                                            <td>
                                                <button type="submit" name="update_release" data-update-target="update_release" data-component="release" class="btn btn-secondary update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="component-title">rocketstation_DedicatedServer Beta</div>
                                                <div class="progress-row" data-progress="beta">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td id="ver-beta-deployed">Loading…</td>
                                            <td id="ver-beta-latest">Loading…</td>
                                            <td>
                                                <button type="submit" name="update_beta" data-update-target="update_beta" data-component="beta" class="btn btn-secondary update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="component-title">BEPINEX</div>
                                                <div class="progress-row" data-progress="bepinex">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td id="ver-bepinex-deployed">Loading…</td>
                                            <td id="ver-bepinex-latest">Loading…</td>
                                            <td>
                                                <button type="submit" name="update_bepinex" data-update-target="update_bepinex" data-component="bepinex" class="btn btn-secondary update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="component-title">Stationeers LaunchPad</div>
                                                <div class="progress-row" data-progress="launchpad">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td id="ver-launchpad-deployed">Loading…</td>
                                            <td id="ver-launchpad-latest">Loading…</td>
                                            <td>
                                                <button type="submit" name="update_launchpad" data-update-target="update_launchpad" data-component="launchpad" class="btn btn-secondary update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td>
                                                <div class="component-title">SCON</div>
                                                <div class="progress-row" data-progress="scon">
                                                    <div class="progress-bar"><div class="progress-fill"></div></div>
                                                    <div class="progress-text"></div>
                                                </div>
                                            </td>
                                            <td id="ver-scon-deployed">Loading…</td>
                                            <td id="ver-scon-latest">Loading…</td>
                                            <td>
                                                <button type="submit" name="update_scon" data-update-target="update_scon" data-component="scon" class="btn btn-secondary update-trigger" {{if .updating}}disabled{{end}}>
                                                    <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"></path>
                                                        <path d="M21 3v5h-5"></path>
                                                    </svg>
                                                    Update
                                                </button>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td colspan="3"></td>
                                            <td>
                                                <button type="submit" name="update_all" data-update-target="update_all" data-component="all" class="btn btn-primary update-trigger" {{if .updating}}disabled{{end}}>
                                                    Update All
                                                </button>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <div class="glass-card" id="userMgmtCard">
                <div class="card-header">
                    <h3 class="card-title m-0">User Management</h3>
                    <button type="button" id="userMgmtToggle" class="btn btn-secondary btn-min-sm" aria-expanded="false" aria-controls="userMgmtContent" title="Expand">
                        <svg id="userMgmtChevron" class="icon-inline" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><polyline points="6 9 12 15 18 9"></polyline></svg>
                        <span id="userMgmtToggleLabel" class="ml-6">More</span>
                    </button>
                </div>
                <div id="userMgmtContent" class="card-body hidden" aria-hidden="true">
                    <div class="form-grid-compact mb-3">
                        <div class="form-group">
                            <label>Add User</label>
                            <div class="inline-controls">
                                <input id="um_new_username" type="text" class="form-input-inline" placeholder="username" minlength="3" required />
                                <input id="um_new_password" type="password" class="form-input-inline" placeholder="password (min 8)" minlength="8" required />
                                <select id="um_new_role" class="form-input-inline w-120 min-w-120">
                                    <option value="admin">Admin</option>
                                    <option value="operator" selected>Operator</option>
                                </select>
                                <button type="button" id="um_access_btn" class="btn btn-secondary min-w-120 nowrap" title="Choose servers for this operator">Servers ▾</button>
                                <button type="button" id="um_add_btn" class="btn btn-primary">Add</button>
                            </div>
                            <div id="um_access_dropdown" class="glass-card dropdown-panel hidden w-340">
                                <div class="row justify-between mb-2">
                                    <strong>Server Access</strong>
                                    <button type="button" id="um_access_close" class="btn btn-min-sm btn-secondary">Close</button>
                                </div>
                                <div class="form-group mb-2">
                                    <label class="inline-flex items-center gap-2"><input type="checkbox" id="um_access_all"> All servers</label>
                                </div>
                                <div id="um_access_list" class="assign-list"></div>
                                <div class="row justify-end mt-2 gap-2">
                                    <button type="button" id="um_access_save" class="btn btn-primary">Save</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th class="um-sort cursor-pointer" data-key="username">Username</th>
                                    <th class="um-sort cursor-pointer" data-key="role">Role</th>
                                    <th class="um-sort cursor-pointer" data-key="created_at">Created</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="um_table_body"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            
            <div class="glass-card">
                <p>There are <strong id="server-count-running">{{.server_count_active}}</strong> servers currently running.</p>
                <div class="button-group centered gap-3 mt-4">
                    <form id="footerActionsForm" action="/update" method="POST" class="display-contents">
                        <button id="shutdownBtn" type="submit" name="shutdown" value="1" class="btn btn-danger" {{if .updating}}disabled{{end}}>
                            <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                                <line x1="12" y1="2" x2="12" y2="12"></line>
                            </svg>
                            Shutdown SDSM
                        </button>
                        <button id="restartBtn" type="submit" name="restart" value="1" class="btn btn-primary" {{if .updating}}disabled{{end}}>
                            <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="23 4 23 10 17 10"></polyline>
                                <polyline points="1 20 1 14 7 14"></polyline>
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            Restart SDSM
                        </button>
                        <button id="stopAllBtn" type="button" class="btn btn-warning" {{if or .updating (eq .server_count_active 0)}}disabled{{end}} title="Stop all running servers">
                            <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="9" x2="15" y2="9"></line>
                                <line x1="9" y1="15" x2="15" y2="15"></line>
                            </svg>
                            Stop All Servers
                        </button>
                    </form>
                    <a class="btn btn-secondary" href="/logs/sdsm" target="_blank" rel="noopener">
                        <svg class="icon-inline" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                            <polyline points="10 9 9 9 8 9"></polyline>
                        </svg>
                        View Log
                    </a>
                </div>
            </div>
        </div>
    </main>

    <script>
        (function () {
            const HEALTH_ENDPOINT = '/healthz';
            const HEALTH_TIMEOUT = 4000;
            const INTERVAL_OK = 15000;
            const INTERVAL_LOST = 5000;

            let healthTimer = null;
            let connectionLost = false;

            function setBanner(active, message) {
                const banner = document.getElementById('connectionBanner');
                const text = document.getElementById('connectionBannerText');
                if (!banner) {
                    return;
                }
                if (active) {
                    banner.classList.add('active');
                    if (text && message) {
                        text.textContent = message;
                    }
                    document.body.style.paddingTop = '4rem';
                } else {
                    banner.classList.remove('active');
                    document.body.style.paddingTop = '';
                }
            }

            function scheduleNext(delay) {
                if (stopAllBtn) {
                    // Initialize disabled state based on current running count
                    try {
                        const rcEl = document.getElementById('server-count-running');
                        const rc = rcEl ? parseInt(rcEl.textContent || '0', 10) : 0;
                        if (rc === 0) stopAllBtn.disabled = true;
                    } catch(_) {}
                    clearTimeout(healthTimer);
                }
                healthTimer = setTimeout(runHealthCheck, delay);
            }

            function runHealthCheck() {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), HEALTH_TIMEOUT);

                fetch(HEALTH_ENDPOINT, {
                    cache: 'no-store',
                    credentials: 'same-origin',
                    signal: controller.signal
                })
                    .then((response) => {
                        clearTimeout(timeoutId);
                        if (!response.ok) {
                            throw new Error('Health check failed');
                        }
                        if (connectionLost) {
                            connectionLost = false;
                            // With zero running, keep button disabled post-success
                            stopAllBtn.disabled = true;
                            setBanner(true, 'Connection restored. Reloading...');
                            setTimeout(() => {
                                setBanner(false);
                                window.location.reload();
                            }, 1200);
                            return;
                        }
                            // If still servers running, re-enable; otherwise remains disabled
                            const rcEl2 = document.getElementById('server-count-running');
                            const rc2 = rcEl2 ? parseInt(rcEl2.textContent || '0', 10) : 0;
                            stopAllBtn.disabled = (rc2 === 0);
                    })
                    .catch(() => {
                        clearTimeout(timeoutId);
                        if (!connectionLost) {
                            connectionLost = true;
                            setBanner(true, 'Connection lost. Attempting to reconnect...');
                        }
                    })
                    .finally(() => {
                        scheduleNext(connectionLost ? INTERVAL_LOST : INTERVAL_OK);
                    });
            }

            document.addEventListener('DOMContentLoaded', () => {
                const reloadButton = document.getElementById('connectionBannerAction');
                if (reloadButton) {
                    reloadButton.addEventListener('click', () => window.location.reload());
                }
                runHealthCheck();
                // Kick off async versions fetch shortly after paint. Guard against missing function.
                setTimeout(() => { try { if (typeof fetchVersions === 'function') fetchVersions(0); } catch(_) {} }, 50);
            });
        })();
    </script>
    
    <script>
        // Theme management
        function getStoredTheme() {
            return localStorage.getItem('theme') || 'light';
        }
        
        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const icon = document.getElementById('theme-icon');
            icon.textContent = theme === 'dark' ? '☀️' : '🌙';
        }
        
        function toggleTheme() {
            const currentTheme = getStoredTheme();
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            setTheme(newTheme);
        }
        
        // Initialize theme
        setTheme(getStoredTheme());
    </script>
    
    
    {{ template "modal_templates" . }}
    {{ template "modal_scripts" . }}

    {{ template "toast.html" . }}
    {{ template "footer" . }}
</body>

</html>
<!-- Fallback loader: populate versions even if main script fails; logs errors and respects primary flag -->
<script>
(function(){
    function setText(id, val){ var el = document.getElementById(id); if(el){ el.textContent = val || ''; } }
    function setBtn(name, equal){
        var btn = document.querySelector('button[data-component="'+name+'"]');
        if (!btn) return;
        btn.classList.remove('btn-success','btn-danger');
        btn.classList.add(equal ? 'btn-success' : 'btn-danger');
    }
    function apply(data){
        if (window.__versionsPrimaryLoaded) { return; }
        setText('ver-steamcmd-deployed', data.steamcmd_deployed);
        setText('ver-steamcmd-latest', data.steamcmd_latest);
        setText('ver-release-deployed', data.release_deployed);
        setText('ver-release-latest', data.release_latest);
        setText('ver-beta-deployed', data.beta_deployed);
        setText('ver-beta-latest', data.beta_latest);
        setText('ver-bepinex-deployed', data.bepinex_deployed);
        setText('ver-bepinex-latest', data.bepinex_latest);
        setText('ver-launchpad-deployed', data.launchpad_deployed);
        setText('ver-launchpad-latest', data.launchpad_latest);
        setText('ver-scon-deployed', data.scon_deployed);
        setText('ver-scon-latest', data.scon_latest);
        setBtn('steamcmd', (data.steamcmd_deployed||'')===(data.steamcmd_latest||''));
        setBtn('release', (data.release_deployed||'')===(data.release_latest||''));
        setBtn('beta', (data.beta_deployed||'')===(data.beta_latest||''));
        setBtn('bepinex', (data.bepinex_deployed||'')===(data.bepinex_latest||''));
        setBtn('launchpad', (data.launchpad_deployed||'')===(data.launchpad_latest||''));
        setBtn('scon', (data.scon_deployed||'')===(data.scon_latest||''));
        try { console.warn('[SDSM] Versions loaded via fallback.'); window.__versionsFallbackUsed = true; } catch(_) {}
    }
    function markUnavailable(){
        if (window.__versionsPrimaryLoaded) { return; }
        var ids=['ver-steamcmd-deployed','ver-steamcmd-latest','ver-release-deployed','ver-release-latest','ver-beta-deployed','ver-beta-latest','ver-bepinex-deployed','ver-bepinex-latest','ver-launchpad-deployed','ver-launchpad-latest','ver-scon-deployed','ver-scon-latest'];
        for (var i=0;i<ids.length;i++){ var el=document.getElementById(ids[i]); if (el && (el.textContent==='Loading…' || el.textContent==='Loading...')) el.textContent='Unavailable'; }
        try {
            console.error('[SDSM] Fallback failed to load versions after retries.');
            if (window && typeof window.showToast === 'function') {
                window.showToast({ type: 'error', title: 'Version Load Failed', message: 'Fallback could not load component versions.' });
            }
        } catch(_) {}
    }
    function load(retry){
        if (window.__versionsPrimaryLoaded) { return; }
        var tries = typeof retry==='number' ? retry : 0;
        try {
            var xhr = new XMLHttpRequest();
            xhr.open('GET','/api/manager/versions', true);
            xhr.setRequestHeader('Accept','application/json');
            xhr.onreadystatechange = function(){
                if (xhr.readyState !== 4) return;
                if (window.__versionsPrimaryLoaded) { return; }
                if (xhr.status>=200 && xhr.status<300){
                    try { var data = JSON.parse(xhr.responseText||'{}'); apply(data); }
                    catch(e){ console.error('[SDSM] Fallback parse error', e); markUnavailable(); }
                } else {
                    if (tries < 3) {
                        try { console.warn('[SDSM] Fallback versions fetch retry', tries+1); } catch(_) {}
                        setTimeout(function(){ load(tries+1); }, 500*(tries+1));
                    } else {
                        markUnavailable();
                    }
                }
            };
            xhr.onerror = function(){
                if (tries < 3) { setTimeout(function(){ load(tries+1); }, 500*(tries+1)); }
                else { markUnavailable(); }
            };
            xhr.send();
        } catch(e){ if (tries < 3) { setTimeout(function(){ load(tries+1); }, 500*(tries+1)); } else { markUnavailable(); } }
    }
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function(){ setTimeout(function(){ load(0); }, 200); });
    } else {
        setTimeout(function(){ load(0); }, 200);
    }
})();
</script>