<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SDSM - Server Manager</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/ui-theme.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
            background: var(--page-background);
            overflow: hidden;
            height: 100vh;
            display: flex;
        }

        .sidebar {
            width: 280px;
            background: var(--panel-gradient);
            border-right: 1px solid var(--panel-border);
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(24px);
            box-shadow: var(--shadow-md);
            z-index: 100;
        }

        .sidebar-header {
            padding: var(--space-6) var(--space-5);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .sidebar-logo {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-lg);
            object-fit: contain;
            background: rgba(99, 102, 241, 0.08);
            padding: var(--space-2);
        }

        .sidebar-title {
            flex: 1;
        }

        .sidebar-title h1 {
            font-size: var(--text-lg);
            font-weight: 700;
            margin: 0;
            color: var(--text-primary);
        }

        .sidebar-title p {
            font-size: var(--text-xs);
            color: var(--text-tertiary);
            margin: 0;
            margin-top: 2px;
        }

        .nav-section {
            padding: var(--space-4) var(--space-3);
        }

        .nav-section-title {
            font-size: var(--text-xs);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            padding: 0 var(--space-3);
            margin-bottom: var(--space-2);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-3);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-secondary);
            text-decoration: none;
            font-size: var(--text-sm);
            font-weight: 500;
            margin-bottom: var(--space-1);
        }

        .nav-item:hover {
            background: var(--surface-soft);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: linear-gradient(120deg, rgba(99, 102, 241, 0.18), rgba(147, 51, 234, 0.12));
            color: var(--primary-600);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.18);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            flex-shrink: 0;
        }

        .nav-badge {
            margin-left: auto;
            background: var(--chip-bg);
            color: var(--chip-text);
            font-size: var(--text-xs);
            font-weight: 600;
            padding: 2px var(--space-2);
            border-radius: var(--radius-full);
            min-width: 20px;
            text-align: center;
        }

        .nav-servers {
            flex: 1;
            overflow-y: auto;
            padding: var(--space-2) var(--space-3);
        }

        .sidebar-footer {
            padding: var(--space-4) var(--space-3);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: var(--space-2);
        }

        .theme-toggle-btn {
            display: flex;
            align-items: center;
            gap: var(--space-2);
            padding: var(--space-2) var(--space-3);
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            font-size: var(--text-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .theme-toggle-btn:hover {
            background: var(--surface-soft);
            border-color: var(--input-border);
        }

        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .topbar {
            background: var(--panel-gradient);
            border-bottom: 1px solid var(--panel-border);
            padding: var(--space-4) var(--space-6);
            display: flex;
            align-items: center;
            justify-content: space-between;
            backdrop-filter: blur(24px);
            box-shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
        }

        .topbar-left {
            display: flex;
            align-items: center;
            gap: var(--space-3);
        }

        .page-title {
            font-size: var(--text-xl);
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .datetime-display {
            font-size: var(--text-sm);
            color: var(--text-tertiary);
            font-variant-numeric: tabular-nums;
        }

        .content-frame {
            flex: 1;
            border: none;
            width: 100%;
            height: 100%;
            background: transparent;
        }

        .connection-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            display: none;
            align-items: center;
            justify-content: center;
            gap: var(--space-3);
            padding: var(--space-3) var(--space-5);
            background: rgba(239, 68, 68, 0.95);
            color: #ffffff;
            font-weight: 600;
            font-size: var(--text-sm);
            z-index: 10000;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(8px);
        }

        .connection-banner.active {
            display: flex;
        }

        .connection-banner button {
            padding: var(--space-1) var(--space-3);
            border: 1px solid rgba(255, 255, 255, 0.55);
            border-radius: var(--radius-md);
            background: rgba(255, 255, 255, 0.18);
            color: #ffffff;
            font-size: var(--text-sm);
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s ease;
        }

        .connection-banner button:hover {
            background: rgba(255, 255, 255, 0.32);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 240px;
            }

            .topbar {
                padding: var(--space-3) var(--space-4);
            }
        }
    </style>
        const HEALTH_ENDPOINT = '/healthz';
        const HEALTH_POLL_OK = 15000;
        const HEALTH_POLL_LOST = 5000;
        const HEALTH_TIMEOUT = 4000;

        let connectionTimer = null;
        let connectionLost = false;
        let currentTarget = 'dashboard';

        const pageTitles = {
            'dashboard': 'Dashboard',
            'manager': 'Manager Settings',
        };

        function navigateTo(target, event) {
            if (event) {
                event.preventDefault();
            }

            currentTarget = target;
            
            // Update active state
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            const activeItem = document.querySelector(`.nav-item[data-target="${target}"]`);
            if (activeItem) {
                activeItem.classList.add('active');
            }

            // Update page title
            const titleEl = document.getElementById('page-title');
            if (titleEl) {
                titleEl.textContent = pageTitles[target] || target.replace(/server(\d+)/, 'Server $1');
            }

            // Load content
            document.getElementById('frame').src = target;
        }

        function updateDateTime() {
            const now = new Date();
            const element = document.getElementById('datetime');
            if (element) {
                element.textContent = now.toLocaleString('en-US', {
                    weekday: 'short',
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit'
                });
            }
        }

        function setConnectionBanner(active, message) {
            const banner = document.getElementById('connection-banner');
            const text = document.getElementById('connection-banner-text');
            if (!banner) return;

            if (active) {
                banner.classList.add('active');
                if (text && message) {
                    text.textContent = message;
                }
                document.body.style.paddingTop = '3.5rem';
            } else {
                banner.classList.remove('active');
                document.body.style.paddingTop = '';
            }
        }

        function scheduleConnectionCheck(delay) {
            if (connectionTimer) {
                clearTimeout(connectionTimer);
            }
            connectionTimer = setTimeout(runConnectionCheck, delay);
        }

        function runConnectionCheck() {
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), HEALTH_TIMEOUT);

            fetch(HEALTH_ENDPOINT, {
                cache: 'no-store',
                credentials: 'same-origin',
                signal: controller.signal
            })
                .then(response => {
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error('Health check failed');
                    
                    if (connectionLost) {
                        connectionLost = false;
                        setConnectionBanner(true, 'Connection restored. Reloading...');
                        setTimeout(() => {
                            setConnectionBanner(false);
                            window.location.reload();
                        }, 1200);
                        return;
                    }
                    setConnectionBanner(false);
                })
                .catch(() => {
                    clearTimeout(timeoutId);
                    if (!connectionLost) {
                        connectionLost = true;
                        setConnectionBanner(true, 'Connection lost. Attempting to reconnect...');
                    }
                })
                .finally(() => {
                    scheduleConnectionCheck(connectionLost ? HEALTH_POLL_LOST : HEALTH_POLL_OK);
                });
        }

        function getStoredTheme() {
            return localStorage.getItem('theme') || 'dark';
        }

        function setTheme(theme) {
            document.documentElement.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            const textEl = document.getElementById('theme-text');
            if (textEl) {
                textEl.textContent = theme === 'dark' ? 'Light Mode' : 'Dark Mode';
            }
        }

        function toggleTheme() {
            const current = getStoredTheme();
            const next = current === 'dark' ? 'light' : 'dark';
            setTheme(next);
        }

        function startConnectionMonitor() {
            const reloadButton = document.getElementById('connection-banner-action');
            if (reloadButton) {
                reloadButton.addEventListener('click', () => window.location.reload());
            }
            runConnectionCheck();
        }

        // Initialize
        window.addEventListener('load', () => {
            setTheme(getStoredTheme());
            updateDateTime();
            setInterval(updateDateTime, 1000);
            navigateTo('dashboard');
            startConnectionMonitor();
        });
    </script>
</head>
<body>
    <div id="connection-banner" class="connection-banner" role="status" aria-live="polite">
        <span id="connection-banner-text">Connection lost. Attempting to reconnect...</span>
        <button type="button" id="connection-banner-action">Reload</button>
    </div>

    <!-- Sidebar Navigation -->
    <aside class="sidebar">
        <div class="sidebar-header">
            <img src="/sdsm.png" alt="SDSM" class="sidebar-logo">
            <div class="sidebar-title">
                <h1>SDSM</h1>
                <p>Server Manager</p>
            </div>
        </div>

        <!-- Main Navigation -->
        <nav class="nav-section">
            <div class="nav-section-title">Main</div>
            <a href="#" class="nav-item" data-target="dashboard" onclick="navigateTo('dashboard', event)">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"/>
                </svg>
                <span>Dashboard</span>
            </a>
            <a href="#" class="nav-item" data-target="manager" onclick="navigateTo('manager', event)">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                </svg>
                <span>Manager</span>
            </a>
        </nav>

        <!-- Servers Section -->
        {{if .active}}
        <div class="nav-servers">
            <div class="nav-section-title">Servers</div>
            {{if .servers}}
            {{range .servers}}
            <a href="#" class="nav-item" data-target="server{{.ID}}" onclick="navigateTo('server{{.ID}}', event)">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2m-2-4h.01M17 16h.01"/>
                </svg>
                <span>{{.Name}}</span>
                {{if .IsRunning}}
                <span class="nav-badge">‚óè</span>
                {{end}}
            </a>
            {{end}}
            {{else}}
            <div style="padding: var(--space-3); color: var(--text-tertiary); font-size: var(--text-sm);">
                No servers configured
            </div>
            {{end}}
        </div>
        {{end}}

        <!-- Footer Actions -->
        <div class="sidebar-footer">
            <button class="theme-toggle-btn" onclick="toggleTheme()" aria-label="Toggle theme">
                <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8z"/>
                </svg>
                <span id="theme-text">Light Mode</span>
            </button>
            <a href="/logout" class="nav-item" style="margin: 0;">
                <svg class="nav-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/>
                </svg>
                <span>Logout</span>
            </a>
        </div>
    </aside>

    <!-- Main Content Area -->
    <main class="main-content">
        <header class="topbar">
            <div class="topbar-left">
                <h1 class="page-title" id="page-title">Dashboard</h1>
            </div>
            <div class="datetime-display" id="datetime"></div>
        </header>
        <iframe id="frame" class="content-frame" src=""></iframe>
    </main>
</body>
</html>