<div id="toast-container" class="toast-container" role="region" aria-live="polite" data-duration="5000"></div>
<div id="global-htmx-indicator" class="global-htmx-indicator" aria-hidden="true">
    <span class="spinner" aria-hidden="true"></span>
    <span class="label">Loadingâ€¦</span>
 </div>

<style>
    .toast-container {
        position: fixed;
        top: var(--space-6);
        right: var(--space-6);
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
        max-width: 400px;
        pointer-events: none;
    }

    /* Global HTMX Indicator */
    .global-htmx-indicator {
        position: fixed;
        top: var(--space-6);
        right: var(--space-6);
        z-index: 9998;
        display: none;
        align-items: center;
        gap: var(--space-2);
        padding: 6px 10px;
        font-size: var(--text-sm);
        color: var(--text-primary);
        background: var(--panel-gradient);
        border: 1px solid var(--panel-border);
        border-radius: var(--radius-full);
        backdrop-filter: blur(18px);
        box-shadow: var(--shadow-md);
        pointer-events: none;
    }

    .global-htmx-indicator.active {
        display: inline-flex;
    }

    .global-htmx-indicator .spinner {
        width: 16px;
        height: 16px;
        border-radius: 50%;
        border: 2px solid var(--panel-border);
        border-top-color: var(--primary-600);
        animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
        to { transform: rotate(360deg); }
    }

    .toast {
        display: flex;
        align-items: flex-start;
        gap: var(--space-3);
        padding: var(--space-4);
        background: var(--panel-gradient);
        border: 1px solid var(--panel-border);
        border-radius: var(--radius-lg);
        backdrop-filter: blur(24px);
        box-shadow: var(--shadow-lg);
        pointer-events: all;
        animation: toast-slide-in 0.3s ease-out;
        min-width: 320px;
    }

    .toast.toast-exit {
        animation: toast-slide-out 0.3s ease-out forwards;
    }

    @keyframes toast-slide-in {
        from {
            transform: translateX(calc(100% + var(--space-6)));
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    @keyframes toast-slide-out {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(calc(100% + var(--space-6)));
            opacity: 0;
        }
    }

    .toast-icon {
        flex-shrink: 0;
        width: 24px;
        height: 24px;
        border-radius: var(--radius-full);
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .toast-success .toast-icon { background: rgba(34, 197, 94, 0.15); color: var(--success-500); }

    .toast-error .toast-icon { background: rgba(239, 68, 68, 0.15); color: var(--danger-500); }

    .toast-info .toast-icon { background: rgba(59, 130, 246, 0.15); color: var(--primary-500); }

    .toast-warning .toast-icon { background: rgba(245, 158, 11, 0.15); color: var(--warning-500); }

    .toast-content {
        flex: 1;
        min-width: 0;
    }

    .toast-title {
        font-weight: 600;
        font-size: var(--text-sm);
        color: var(--text-primary);
        margin: 0 0 var(--space-1) 0;
    }

    .toast-message {
        font-size: var(--text-sm);
        color: var(--text-secondary);
        margin: 0;
        line-height: 1.5;
    }

    .toast-close {
        flex-shrink: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        border: none;
        background: none;
        color: var(--text-tertiary);
        cursor: pointer;
        border-radius: var(--radius-sm);
        transition: all 0.2s ease;
    }

    .toast-close:hover {
        background: var(--bg-tertiary);
        color: var(--text-primary);
    }

    @media (max-width: 768px) {
        .toast-container {
            top: var(--space-4);
            right: var(--space-4);
            left: var(--space-4);
            max-width: none;
        }

        .toast {
            min-width: 0;
        }
    }
</style>

<script>
    (function() {
        const toastIcons = {
            success: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 6L9 17l-5-5"></path></svg>',
            error: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>',
            info: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>',
            warning: '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>'
        };

        let toastCounter = 0;
        let inflight = 0;

        // Determine a uniform global duration. Read from container data-duration, fallback 5000ms.
        function getGlobalToastDuration() {
            const container = document.getElementById('toast-container');
            const raw = container && container.dataset ? container.dataset.duration : undefined;
            const val = raw ? parseInt(raw, 10) : NaN;
            if (Number.isFinite(val) && val >= 0) return val;
            return 5000;
        }

        function showToast(options) {
            const {
                type = 'info',
                title = '',
                message = '',
                // duration is ignored to enforce uniform timing; use setGlobalToastDuration or data-duration instead
                duration: _ignored,
                closable = true
            } = options;

            const container = document.getElementById('toast-container');
            if (!container) return;

            const toastId = `toast-${++toastCounter}`;
            const toast = document.createElement('div');
            toast.id = toastId;
            toast.className = `toast toast-${type}`;
            toast.setAttribute('role', 'alert');

            const icon = toastIcons[type] || toastIcons.info;

            toast.innerHTML = `
                <div class="toast-icon">${icon}</div>
                <div class="toast-content">
                    ${title ? `<div class="toast-title">${title}</div>` : ''}
                    <div class="toast-message">${message}</div>
                </div>
                ${closable ? `
                    <button class="toast-close" onclick="window.closeToast('${toastId}')" aria-label="Close notification">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                    </button>
                ` : ''}
            `;

            container.appendChild(toast);

            const duration = getGlobalToastDuration();
            if (duration > 0) {
                setTimeout(() => {
                    window.closeToast(toastId);
                }, duration);
            }

            return toastId;
        }

        function closeToast(toastId) {
            const toast = document.getElementById(toastId);
            if (!toast) return;

            toast.classList.add('toast-exit');
            setTimeout(() => {
                toast.remove();
            }, 300);
        }

        // Global HTMX indicator helpers
        function showGlobalIndicator() {
            const el = document.getElementById('global-htmx-indicator');
            if (!el) return;
            el.classList.add('active');
        }

        function hideGlobalIndicator() {
            const el = document.getElementById('global-htmx-indicator');
            if (!el) return;
            el.classList.remove('active');
        }

        // Expose to window
        window.showToast = showToast;
        window.closeToast = closeToast;
        window.setGlobalToastDuration = function(ms) {
            const container = document.getElementById('toast-container');
            if (!container) return;
            const n = parseInt(ms, 10);
            if (Number.isFinite(n) && n >= 0) {
                container.dataset.duration = String(n);
            }
        };

        // HTMX integration
        document.addEventListener('htmx:beforeRequest', function() {
            inflight++;
            showGlobalIndicator();
        });

        document.addEventListener('htmx:afterRequest', function(event) {
            const xhr = event.detail.xhr;
            
            // Check for toast headers
            const toastType = xhr.getResponseHeader('X-Toast-Type');
            const toastTitle = xhr.getResponseHeader('X-Toast-Title');
            const toastMessage = xhr.getResponseHeader('X-Toast-Message');

            if (toastMessage) {
                showToast({
                    type: toastType || 'info',
                    title: toastTitle || '',
                    message: toastMessage
                });
            }

            // Decrement and maybe hide global indicator
            inflight = Math.max(0, inflight - 1);
            if (inflight === 0) hideGlobalIndicator();
        });

        // Listen for errors
        document.addEventListener('htmx:responseError', function(event) {
            showToast({
                type: 'error',
                title: 'Request Failed',
                message: 'An error occurred while processing your request.'
            });

            inflight = Math.max(0, inflight - 1);
            if (inflight === 0) hideGlobalIndicator();
        });

        // Apply persisted global toast duration (if any) on load so all pages respect the setting
        document.addEventListener('DOMContentLoaded', function() {
            try {
                const raw = localStorage.getItem('toastDurationMs');
                const ms = raw ? parseInt(raw, 10) : NaN;
                if (Number.isFinite(ms) && ms >= 0 && typeof window.setGlobalToastDuration === 'function') {
                    window.setGlobalToastDuration(ms);
                }
            } catch (_) {
                // ignore storage access errors
            }
        });
    })();
</script>
