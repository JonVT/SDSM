{{ define "modal_scripts" }}
<script>
(function(){
  if (window.openConfirm) return; // Prevent double init

  function cloneTemplate(id){
    const tpl = document.getElementById(id);
    if(!tpl) return null;
    return tpl.content ? tpl.content.cloneNode(true) : null;
  }

  function focusTrap(modal){
    const focusable = modal.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    function onKey(e){
      if(e.key === 'Tab'){
        if(focusable.length === 0){ e.preventDefault(); return; }
        if(e.shiftKey){
          if(document.activeElement === first){ e.preventDefault(); last.focus(); }
        } else {
          if(document.activeElement === last){ e.preventDefault(); first.focus(); }
        }
      } else if(e.key === 'Escape'){
        const closeBtn = modal.querySelector('[data-close]');
        if(closeBtn){ closeBtn.click(); }
      }
    }
    modal.addEventListener('keydown', onKey);
    return () => modal.removeEventListener('keydown', onKey);
  }

  function buildModal(fromId){
    const frag = cloneTemplate(fromId);
    if(!frag) return null;
    const wrapper = frag.querySelector('.confirm-modal');
    if(!wrapper) return null;
    document.body.appendChild(wrapper);
    return wrapper;
  }

  function setupCommon(modal, opts){
    const titleEl = modal.querySelector('[data-title]');
    const bodyEl = modal.querySelector('[data-body]');
    const iconEl = modal.querySelector('[data-icon]');
    if(titleEl && opts.title) titleEl.textContent = opts.title;
    if(bodyEl && opts.body) {
      if(typeof opts.body === 'string'){ bodyEl.innerHTML = opts.body; }
      else if(opts.body instanceof Node){ bodyEl.innerHTML=''; bodyEl.appendChild(opts.body); }
    }
    if(iconEl && opts.icon) iconEl.textContent = opts.icon;
  }

  function setButtonText(modal, sel, text){
    const btn = modal.querySelector(sel);
    if(btn && text) btn.textContent = text;
    return btn;
  }

  function activate(modal){
    modal.classList.add('active');
    modal.setAttribute('aria-hidden','false');
    setTimeout(()=>{
      const auto = modal.querySelector('[data-input]') || modal.querySelector('[data-confirm]') || modal.querySelector('[data-close]');
      try { auto && auto.focus(); auto && auto.select && auto.select(); } catch(_) {}
    }, 0);
  }

  function cleanup(modal, restoreFocus, trapDisposer){
    try { trapDisposer && trapDisposer(); } catch(_) {}
    if(modal && modal.parentNode) modal.parentNode.removeChild(modal);
    if(restoreFocus){ try { restoreFocus.focus(); } catch(_) {} }
  }

  function openConfirm(options){
    const opts = Object.assign({ title:'Confirm Action', body:'Are you sure?', confirmText:'Confirm', cancelText:'Cancel', icon:'!', danger:false }, options||{});
    if (opts.message && !opts.body) opts.body = opts.message;
    const prev = document.activeElement;
    const modal = buildModal('tpl-modal-confirm');
    if(!modal) return Promise.resolve(false);
    setupCommon(modal, opts);
    const confirmBtn = setButtonText(modal,'[data-confirm]', opts.confirmText);
    const cancelBtn = setButtonText(modal,'[data-cancel]', opts.cancelText);
    if(opts.danger && confirmBtn){ confirmBtn.classList.remove('btn-primary'); confirmBtn.classList.add('btn-danger'); }
    const closeBtn = modal.querySelector('[data-close]');
    const trapDisposer = focusTrap(modal);
    return new Promise(resolve => {
      function done(val){ cleanup(modal, prev, trapDisposer); resolve(val); }
      confirmBtn && confirmBtn.addEventListener('click', ()=> done(true));
      cancelBtn && cancelBtn.addEventListener('click', ()=> done(false));
      closeBtn && closeBtn.addEventListener('click', ()=> done(false));
      modal.addEventListener('click', e=>{ if(e.target === modal) done(false); });
      activate(modal);
    });
  }

  function openPrompt(options){
    const opts = Object.assign({ title:'Input Required', body:'', label:'Enter a value', placeholder:'', defaultValue:'', confirmText:'OK', cancelText:'Cancel', icon:'✎', hint:'', validate:null }, options||{});
    if (opts.message && !opts.body) opts.body = opts.message;
    const prev = document.activeElement;
    const modal = buildModal('tpl-modal-prompt');
    if(!modal) return Promise.resolve(null);
    setupCommon(modal, opts);
    const input = modal.querySelector('[data-input]');
    const labelEl = modal.querySelector('[data-label]');
    const hintEl = modal.querySelector('[data-hint]');
    if(labelEl && opts.label) labelEl.textContent = opts.label;
    if(input){ input.placeholder = opts.placeholder || ''; input.value = opts.defaultValue || ''; }
    if(hintEl && opts.hint){ hintEl.textContent = opts.hint; hintEl.style.display='block'; }
    const confirmBtn = setButtonText(modal,'[data-confirm]', opts.confirmText);
    const cancelBtn = setButtonText(modal,'[data-cancel]', opts.cancelText);
    const closeBtn = modal.querySelector('[data-close]');
    const trapDisposer = focusTrap(modal);
    return new Promise(resolve => {
      function finish(val){ cleanup(modal, prev, trapDisposer); resolve(val); }
      function commit(){
        const raw = (input && input.value || '').trim();
        if(opts.validate){
          try {
            const res = opts.validate(raw);
            if(res !== true){ if(hintEl){ hintEl.textContent = res || 'Invalid value'; hintEl.style.display='block'; } try { input.focus(); } catch(_){} return; }
          } catch(err){ if(hintEl){ hintEl.textContent = (err && err.message) || 'Invalid'; hintEl.style.display='block'; } return; }
        }
        finish(raw);
      }
      confirmBtn && confirmBtn.addEventListener('click', commit);
      cancelBtn && cancelBtn.addEventListener('click', ()=> finish(null));
      closeBtn && closeBtn.addEventListener('click', ()=> finish(null));
      modal.addEventListener('click', e=>{ if(e.target === modal) finish(null); });
      if(input) input.addEventListener('keydown', e=>{ if(e.key==='Enter'){ e.preventDefault(); commit(); } });
      activate(modal);
    });
  }

  function openInfo(options){
    const opts = Object.assign({ title:'Information', body:'', icon:'ℹ', buttonText:'OK' }, options||{});
    if (opts.message && !opts.body) opts.body = opts.message;
    if (opts.confirmText && !opts.buttonText) opts.buttonText = opts.confirmText;
    const prev = document.activeElement;
    const modal = buildModal('tpl-modal-info');
    if(!modal) return Promise.resolve();
    setupCommon(modal, opts);
    const okBtn = setButtonText(modal,'[data-confirm]', opts.buttonText);
    const closeBtn = modal.querySelector('[data-close]');
    const trapDisposer = focusTrap(modal);
    return new Promise(resolve => {
      function finish(){ cleanup(modal, prev, trapDisposer); resolve(); }
      okBtn && okBtn.addEventListener('click', finish);
      closeBtn && closeBtn.addEventListener('click', finish);
      modal.addEventListener('click', e=>{ if(e.target === modal) finish(); });
      activate(modal);
    });
  }

  window.openConfirm = openConfirm;
  window.openPrompt = openPrompt;
  window.openInfo = openInfo;

  if (!window.askConfirm) {
    window.askConfirm = function(options, fallbackMessage){
      try {
        if (window.openConfirm) return window.openConfirm(options||{});
      } catch(_) {}
      const msg = (fallbackMessage != null ? fallbackMessage : ((options && (options.message||options.body||options.title)) || 'Are you sure?'));
      return Promise.resolve(window.confirm(String(msg)));
    };
  }
  if (!window.askInfo) {
    window.askInfo = function(options){
      try {
        if (window.openInfo) return window.openInfo(options||{});
      } catch(_) {}
      const msg = (options && (options.message||options.body||options.title)) || 'Info';
      window.alert(String(msg));
      return Promise.resolve();
    };
  }
})();
</script>
{{ end }}
