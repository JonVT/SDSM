name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to release (e.g. v0.4.1). Leave empty to use current tag."
        required: false

permissions:
  contents: write

env:
  GO111MODULE: on
  CGO_ENABLED: 0

jobs:
  build:
    name: Build binaries
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: windows
            arch: amd64
          - os: windows
            arch: arm64
    outputs:
      version: ${{ steps.vars.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Determine version and commit
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" && "${GITHUB_REF_NAME}" == v* ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
            if [[ -z "$VERSION" ]]; then
              echo "::error::No version provided and not a tag push. Provide inputs.version (e.g., v0.4.1)"
              exit 1
            fi
          SHORT_SHA="${GITHUB_SHA::7}"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build
        shell: bash
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          VERSION: ${{ steps.vars.outputs.version }}
          SHORT_SHA: ${{ steps.vars.outputs.short_sha }}
          BUILD_DATE: ${{ steps.vars.outputs.build_date }}
        run: |
          set -euxo pipefail
          BIN_NAME="sdsm"
          EXT=""
          if [[ "$GOOS" == "windows" ]]; then EXT=".exe"; fi
          OUTDIR="dist/${GOOS}_${GOARCH}"
          mkdir -p "$OUTDIR"
          go build -trimpath -ldflags "-s -w -X sdsm/internal/version.Version=${VERSION} -X sdsm/internal/version.Commit=${SHORT_SHA} -X sdsm/internal/version.Date=${BUILD_DATE} -X sdsm/internal/version.Dirty=clean" -o "${OUTDIR}/${BIN_NAME}${EXT}" ./cmd/sdsm

      - name: Package artifacts
        shell: bash
        env:
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          set -euxo pipefail
          OUTDIR="dist/${{ matrix.os }}_${{ matrix.arch }}"
          PKGDIR="dist/pkg/${{ matrix.os }}_${{ matrix.arch }}"
          mkdir -p "$PKGDIR"
          BASENAME="sdsm_${VERSION}_${{ matrix.os }}_${{ matrix.arch }}"
          echo "Listing OUTDIR before packaging:" && ls -la "$OUTDIR" || true
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            [[ -f "$OUTDIR/sdsm.exe" ]] || { echo "Missing sdsm.exe in $OUTDIR" >&2; ls -la "$OUTDIR"; exit 1; }
            if ! command -v zip >/dev/null 2>&1; then
              sudo apt-get update -y && sudo apt-get install -y zip
            fi
            (cd "$OUTDIR" && zip -9 "../pkg/${{ matrix.os }}_${{ matrix.arch }}/${BASENAME}.zip" sdsm.exe)
          else
            [[ -f "$OUTDIR/sdsm" ]] || { echo "Missing sdsm in $OUTDIR" >&2; ls -la "$OUTDIR"; exit 1; }
            (cd "$OUTDIR" && tar -czf "../pkg/${{ matrix.os }}_${{ matrix.arch }}/${BASENAME}.tar.gz" sdsm)
          fi
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            (cd "$OUTDIR" && zip -9 "../../pkg/${{ matrix.os }}_${{ matrix.arch }}/${BASENAME}.zip" sdsm.exe)
          else
            (cd "$OUTDIR" && tar -czf "../../pkg/${{ matrix.os }}_${{ matrix.arch }}/${BASENAME}.tar.gz" sdsm)
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            dist/pkg/${{ matrix.os }}_${{ matrix.arch }}/*.tar.gz
            dist/pkg/${{ matrix.os }}_${{ matrix.arch }}/*.zip

  release:
    name: Create consolidated release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Determine version
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" && "${GITHUB_REF_NAME}" == v* ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
          if [[ -z "$VERSION" ]]; then
            echo "::error::No version provided and not a tag push. Provide inputs.version (e.g., v0.4.1)"
            exit 1
          fi
          SHORT_SHA="${GITHUB_SHA::7}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/upload

      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate release body
        id: body
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          SHORT_SHA="${{ steps.vars.outputs.short_sha }}"
          DATE="$(date -u +'%Y-%m-%dT%H:%M:%SZ')"

          # Find previous tag (by semver sort) excluding current
          git fetch --tags --force >/dev/null 2>&1 || true
          PREV_TAG=$(git tag --sort=-v:refname | grep '^v' | grep -v "^${VERSION}$" | head -n1 || true)
          if [[ -n "$PREV_TAG" ]]; then
            AUTHORS=$(git log --format='%aN' "$PREV_TAG".."$VERSION" | sort -u | tr '\n' '\n')
            RANGE="$PREV_TAG..$VERSION"
          else
            AUTHORS=$(git log --format='%aN' "$VERSION" | sort -u | tr '\n' '\n')
            RANGE="$VERSION"
          fi
          # Extract PR numbers referenced in commit messages (#123 pattern)
          PR_NUMBERS=$(git log --pretty=format:'%s%n%b' $RANGE | grep -o '#[0-9]\+' | sort -u || true)

          printf "# %s\n\n" "$VERSION" > RELEASE_BODY.md
          printf "- Commit: %s\n" "$SHORT_SHA" >> RELEASE_BODY.md
          printf "- Date: %s\n" "$DATE" >> RELEASE_BODY.md

          echo >> RELEASE_BODY.md
          echo "## Authors" >> RELEASE_BODY.md
          if [[ -n "$AUTHORS" ]]; then
            while IFS= read -r a; do
              [[ -z "$a" ]] && continue
              echo "- $a" >> RELEASE_BODY.md
            done <<< "$AUTHORS"
          else
            echo "- N/A" >> RELEASE_BODY.md
          fi

          echo >> RELEASE_BODY.md
          echo "## Pull Requests" >> RELEASE_BODY.md
          if [[ -n "$PR_NUMBERS" ]]; then
            for pr in $PR_NUMBERS; do
              num=${pr#"#"}
              echo "- $pr https://github.com/${GITHUB_REPOSITORY}/pull/$num" >> RELEASE_BODY.md
            done
          else
            echo "- None" >> RELEASE_BODY.md
          fi

          echo >> RELEASE_BODY.md
          echo "## Artifacts" >> RELEASE_BODY.md
          shopt -s globstar nullglob
          files=( dist/upload/**/*.tar.gz dist/upload/**/*.zip )
          for f in "${files[@]}"; do
            base=$(basename "$f")
            echo "- $base" >> RELEASE_BODY.md
          done
          echo "- checksums.txt" >> RELEASE_BODY.md

          echo >> RELEASE_BODY.md
          echo "## Changes" >> RELEASE_BODY.md
          if [[ -n "$PREV_TAG" ]]; then
            echo "Comparing $PREV_TAG..$VERSION" >> RELEASE_BODY.md
            echo >> RELEASE_BODY.md
            git log --pretty=format:'- %s (%h)' "$PREV_TAG".."$VERSION" >> RELEASE_BODY.md || echo "- No commits found" >> RELEASE_BODY.md
          else
            echo "Initial release for this tag." >> RELEASE_BODY.md
          fi

      - name: Generate checksums
        shell: bash
        run: |
          set -euxo pipefail
          cd dist/upload
          shopt -s globstar nullglob
          files=( **/*.tar.gz **/*.zip )
          if (( ${#files[@]} )); then
            sha256sum "${files[@]}" > checksums.txt
          else
            echo "No packaged files found." >&2
            exit 1
          fi

      - name: Create or update release metadata
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          if gh release view "$VERSION" >/dev/null 2>&1; then
            gh release edit "$VERSION" --title "$VERSION" --notes-file RELEASE_BODY.md
          else
            # Create empty release first; assets uploaded next
            gh release create "$VERSION" --title "$VERSION" --notes-file RELEASE_BODY.md
          fi

      - name: Upload assets with overwrite
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euxo pipefail
          VERSION="${{ steps.vars.outputs.version }}"
          shopt -s globstar nullglob
          files=( dist/upload/**/*.tar.gz dist/upload/**/*.zip dist/upload/checksums.txt )
          if (( ${#files[@]} )); then
            gh release upload "$VERSION" "${files[@]}" --clobber
          else
            echo "No files to upload" >&2
            exit 1
          fi
