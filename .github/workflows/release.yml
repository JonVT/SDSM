name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    env:
      CGO_ENABLED: 0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Print tag
        run: echo "Tag is $GITHUB_REF_NAME"

      - name: Build cross-platform
        shell: bash
        run: |
          set -euo pipefail
          TAG="$GITHUB_REF_NAME"
          echo "Building for tag: ${TAG}"
          mkdir -p release
          declare -a TARGETS=(
            "linux amd64"
            "linux arm64"
            "windows amd64"
            "darwin amd64"
            "darwin arm64"
          )

          for t in "${TARGETS[@]}"; do
            read -r GOOS GOARCH <<<"$t"
            EXT=""
            if [[ "$GOOS" == "windows" ]]; then EXT=".exe"; fi
            echo "\n==> Building ${GOOS}/${GOARCH}"
            GOOS="$GOOS" GOARCH="$GOARCH" ./build.sh
            BIN="dist/sdsm${EXT}"
            # Sanity check
            test -f "$BIN"
            OUTBASE="sdsm_${TAG}_${GOOS}_${GOARCH}"
            if [[ "$GOOS" == "windows" ]]; then
              zip -j "release/${OUTBASE}.zip" "$BIN" LICENSE README.md || zip -j "release/${OUTBASE}.zip" "$BIN" LICENSE || zip -j "release/${OUTBASE}.zip" "$BIN"
            else
              tar -czf "release/${OUTBASE}.tar.gz" -C dist "sdsm${EXT}" || tar -czf "release/${OUTBASE}.tar.gz" -C dist sdsm
            fi
          done

      - name: Generate checksums
        working-directory: release
        run: |
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            release/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
