name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: "Version tag to release (e.g. v0.4.1). Leave empty to use current tag."
        required: false

permissions:
  contents: write

env:
  GO111MODULE: on
  CGO_ENABLED: 0

jobs:
  build:
    name: Build binaries
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: windows
            arch: amd64
          - os: windows
            arch: arm64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
    outputs:
      version: ${{ steps.vars.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: Determine version and commit
        id: vars
        shell: bash
        run: |
          if [[ "${GITHUB_REF_TYPE}" == "tag" && "${GITHUB_REF_NAME}" == v* ]]; then
            VERSION="${GITHUB_REF_NAME}"
          else
            VERSION="${{ github.event.inputs.version }}"
          fi
            if [[ -z "$VERSION" ]]; then
              echo "::error::No version provided and not a tag push. Provide inputs.version (e.g., v0.4.1)"
              exit 1
            fi
          SHORT_SHA="${GITHUB_SHA::7}"
          BUILD_DATE="$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "short_sha=$SHORT_SHA" >> $GITHUB_OUTPUT
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT

      - name: Build
        shell: bash
        env:
          GOOS: ${{ matrix.os }}
          GOARCH: ${{ matrix.arch }}
          VERSION: ${{ steps.vars.outputs.version }}
          SHORT_SHA: ${{ steps.vars.outputs.short_sha }}
          BUILD_DATE: ${{ steps.vars.outputs.build_date }}
        run: |
          set -euxo pipefail
          BIN_NAME="sdsm"
          EXT=""
          if [[ "$GOOS" == "windows" ]]; then EXT=".exe"; fi
          OUTDIR="dist/${GOOS}_${GOARCH}"
          mkdir -p "$OUTDIR"
          go build -trimpath -ldflags "-s -w -X sdsm/internal/version.Version=${VERSION} -X sdsm/internal/version.Commit=${SHORT_SHA} -X sdsm/internal/version.Date=${BUILD_DATE} -X sdsm/internal/version.Dirty=clean" -o "${OUTDIR}/${BIN_NAME}${EXT}" ./cmd/sdsm

      - name: Package artifacts
        shell: bash
        env:
          VERSION: ${{ steps.vars.outputs.version }}
        run: |
          set -euxo pipefail
          OUTDIR="dist/${{ matrix.os }}_${{ matrix.arch }}"
          PKGDIR="dist/pkg/${{ matrix.os }}_${{ matrix.arch }}"
          mkdir -p "$PKGDIR"
          BASENAME="sdsm_${VERSION}_${{ matrix.os }}_${{ matrix.arch }}"
          if [[ "${{ matrix.os }}" == "windows" ]]; then
            (cd "$OUTDIR" && zip -9 "../../pkg/${{ matrix.os }}_${{ matrix.arch }}/${BASENAME}.zip" sdsm.exe)
          else
            (cd "$OUTDIR" && tar -czf "../../pkg/${{ matrix.os }}_${{ matrix.arch }}/${BASENAME}.tar.gz" sdsm)
          fi

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: pkg-${{ matrix.os }}-${{ matrix.arch }}
          path: |
            dist/pkg/${{ matrix.os }}_${{ matrix.arch }}/*.tar.gz
            dist/pkg/${{ matrix.os }}_${{ matrix.arch }}/*.zip

  release:
    name: Create consolidated release
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist/upload

      - name: Generate checksums
        shell: bash
        run: |
          set -euxo pipefail
          cd dist/upload
          shopt -s globstar nullglob
          files=( **/*.tar.gz **/*.zip )
          if (( ${#files[@]} )); then
            sha256sum "${files[@]}" > checksums.txt
          else
            echo "No packaged files found." >&2
            exit 1
          fi

      - name: Create/Update Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.build.outputs.version }}
          name: ${{ needs.build.outputs.version }}
          body: Consolidated multi-platform release
          draft: false
          prerelease: false
          files: |
            dist/upload/**/*.tar.gz
            dist/upload/**/*.zip
            dist/upload/checksums.txt
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
