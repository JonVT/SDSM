name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build-and-release:
    name: Build and Release
    runs-on: ubuntu-latest
    env:
      CGO_ENABLED: 0
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod

      - name: Print tag
        run: echo "Tag is $GITHUB_REF_NAME"

      - name: Build and package assets
        shell: bash
        run: |
          set -euo pipefail
          TAG="$GITHUB_REF_NAME"
          echo "Building for tag: ${TAG}"
          mkdir -p release
          declare -a TARGETS=(
            "linux amd64"
            "windows amd64"
          )

          for t in "${TARGETS[@]}"; do
            read -r GOOS GOARCH <<<"$t"
            echo "\n==> Building ${GOOS}/${GOARCH}"
            GOOS="$GOOS" GOARCH="$GOARCH" ./build.sh
            SRC="dist/sdsm"  # build.sh outputs this filename for all targets
            test -f "$SRC"
            if [[ "$GOOS" == "windows" ]]; then
              # Windows: raw executable named SDSM.exe (no zip)
              cp "$SRC" "release/SDSM.exe"
            else
              # Linux: binary named SDSM, zipped as SDSM.zip
              cp "$SRC" "release/SDSM"
              (cd release && zip -q -9 SDSM.zip SDSM && rm -f SDSM)
            fi
          done

      - name: Generate checksums
        working-directory: release
        run: |
          set -euo pipefail
          # Hash produced assets only
          sha256sum SDSM.exe SDSM.zip > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: ${{ github.ref_name }}
          generate_release_notes: true
          files: |
            release/SDSM.zip
            release/SDSM.exe
            release/SHA256SUMS.txt
            CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
